#
# Copyright (C) 2019-2024 vdaas.org vald team <vald@vdaas.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: "Determine Docker image tag"
description: "A action to determine Docker image tag"
outputs:
  TAGS:
    description: "docker image tag list"
    value: ${{ steps.determine_tag_name.outputs.TAGS }}
runs:
  using: "composite"
  steps:
    - name: Dump Github context
      shell: bash
      run: |
        echo "GITHUB_REF $GITHUB_REF"
        echo "GITHUB_BASE_REF $GITHUB_BASE_REF"
        echo "GITHUB_EVENT_PATH $GITHUB_EVENT_PATH"
        echo "GITHUB_EVENT_NAME ${{ github.event_name }}"
        echo "GITHUB_EVENT_NUMBER  ${{ github.event.number }}"
    - name: Determine tag name
      shell: bash
      id: determine_tag_name
      run: |
        if [[ "$GITHUB_REF" =~ ^refs/tags/.* ]]; then
        # The following is the priority of tags:
        #   Tag -> vx.x tag -> Release branch tag -> Commit hash tag
        tag_name=$(echo $GITHUB_REF | sed -e 's:^refs/tags/::')
        tags="${tag_name}"

        major_minor_tag_name="$(echo "${tag_name}" | sed -E 's/^v?([0-9]+\.[0-9]+).*$/v\1/')"
        tags="${tag_name} ${major_minor_tag_name}"

        release_branch_tag_name="release/${major_minor_tag_name}"
        tags="${tag_name} ${release_branch_tag_name}"

        commit_hash_tag_name=${GITHUB_SHA::8}
        tags="${tag_name} ${commit_hash_tag_name}"

        elif [[ "${{ github.event_name }}" = "pull_request" || "${{ github.event_name }}" = "pull_request_target" ]]; then
          # The following is the priority of tags:
          #   PR build tag -> Release branch tag or Nightly
          pr_num=`cat $GITHUB_EVENT_PATH | jq -r ".number"`
          tags="pr-${pr_num}"

          # For pull request to the release branch, use the release branch latest tag as the default tag (release/vx.x).
          # This is only set if the event that triggers the workflow execution is pull_request or pull_request_target.
          if [[ "$GITHUB_BASE_REF" =~ ^release/v([0-9]+)\.([0-9]+)$ ]]; then
            tags="${tags} $(echo "$GITHUB_BASE_REF")"
          else
            tags="${tags} nightly"
          fi
        elif [ "$GITHUB_REF" = "refs/heads/main" ]; then
          # The following is the priority of tags:
          #   Commit hash tag -> nightly tag
          commit_hash_tag_name=${GITHUB_SHA::8}
          tags="${commit_hash_tag_name}"
          tags="${tags} nightly"

        elif [[ "$GITHUB_REF" =~ ^refs/heads/release/v([0-9]+)\.([0-9]+)$ ]]; then
        # The following is the priority of tags:
        #   Release branch tag -> Commit hash tag -> Nightly
        release_branch_tag_name=`echo $GITHUB_REF | sed -e 's:^refs/heads/::'`
        tags="${release_branch_tag_name}"

        commit_hash_tag_name=${GITHUB_SHA::8}
        tags="${tag_name} ${commit_hash_tag_name}"
        else
          tags="unknown"
        fi

        echo "Determined tags: ${tags}"
        echo "TAGS=${tags}" >> $GITHUB_OUTPUT
