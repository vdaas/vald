#
# Copyright (C) 2019-2024 vdaas.org vald team <vald@vdaas.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: "Run E2E deploy and integration test"
on:
  push:
    tags:
      - "*.*.*"
      - "v*.*.*"
      - "*.*.*-*"
      - "v*.*.*-*"
  pull_request:

env:
  DATASET: fashion-mnist-784-euclidean.hdf5
jobs:
  # dump-contexts-to-log:
  #   if: startsWith( github.ref, 'refs/tags/') || github.event.action == 'labeled' && github.event.label.name == 'actions/e2e-deploy'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/dump-context
  # detect-ci-container:
  #   uses: ./.github/workflows/_detect-ci-container.yml
  e2e-stream-crud:
    name: "E2E test (Stream CRUD)"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # services:
    #   docker:
    #     image: docker:23.0.1-dind
    #     options: --privileged
    #     ports:
    #       - 2375:2375
    #       - 6443:6443
    #     volumes:
    #       - "/var/run/docker.sock:/var/run/docker.sock:ro"
    container:
      image: ghcr.io/vdaas/vald/vald-ci-container:nightly
      options: "--privileged --add-host host.docker.internal:host-gateway"
    steps:
      - uses: actions/checkout@v4
      # - name: Update
      #   run: |
      #     apt-get clean \
      #     && rm -rf \
      #         /var/lib/apt/lists/* \
      #         /var/cache/* \
      #     && apt-get update -y \
      #     && apt-get upgrade -y \
      #     && apt-get install -y --no-install-recommends --fix-missing \
      #       ca-certificates \
      #       curl \
      #       gnupg \
      #       lsb-release \
      #       git
      # - uses: azure/setup-kubectl@v3
      - name: Setup K3d environment
        uses: ./.github/actions/setup-k3d
        # env:
        #   DOCKER_HOST: tcp://0.0.0.0:2375
      - name: Chec
        run: |
          kubectl get pods -A
        # env:
        #   DOCKER_HOST: tcp://0.0.0.0:2375

  e2e-crud:
    name: "E2E test (Stream CRUD)"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # services:
    #   docker:
    #     image: docker:23.0.1-dind
    #     options: --privileged
    #     ports:
    #       - 2375:2375
    #       - 6443:6443
    #     volumes:
    #       - "/var/run/docker.sock:/var/run/docker.sock:ro"
    container:
      image: ghcr.io/vdaas/vald/vald-ci-container:nightly
      options: "--privileged --add-host host.docker.internal:host-gateway"
    steps:
      - uses: actions/checkout@v4
      # - name: Update
      #   run: |
      #     apt-get clean \
      #     && rm -rf \
      #         /var/lib/apt/lists/* \
      #         /var/cache/* \
      #     && apt-get update -y \
      #     && apt-get upgrade -y \
      #     && apt-get install -y --no-install-recommends --fix-missing \
      #       ca-certificates \
      #       curl \
      #       gnupg \
      #       lsb-release \
      #       git
      # - uses: azure/setup-kubectl@v3
      - name: Setup K3d environment
        uses: ./.github/actions/setup-k3d
        # env:
        #   DOCKER_HOST: tcp://0.0.0.0:2375
      - name: Chec
        run: |
          kubectl get pods -A
        # env:
        #   DOCKER_HOST: tcp://0.0.0.0:2375
