#
# Copyright (C) 2019-2024 vdaas.org vald team <vald@vdaas.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: "Sync Docker image from Docker Hub to GHCR"
on:
  # TODO: The following events are for debugging purposes so I will remove them before merging.
  pull_request:

  schedule:
    - cron: "0 1 * * *"
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref != 'refs/heads/main' && github.ref || github.sha }}-${{ github.event_name }}
  cancel-in-progress: true
env:
  ORG: vdaas
  REPO: vald
jobs:
  dump-contexts-to-log:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/dump-context

  ubuntu:
    runs-on: ubuntu-latest
    env:
      CREATED_IMAGE_NAME: "buildbase:devel"
    strategy:
      matrix:
        target_images: ["ubuntu:devel"]
    #     # platforms: [linux/amd64, linux/arm/v7, linux/arm64/v8]
    steps:
      - uses: actions/checkout@v4
      - name: Set Git config
        run: |
          git config --global --add safe.directory ${GITHUB_WORKSPACE}
      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: latest
          platforms: linux/amd64,linux/arm64
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-flags: "--debug --oci-worker-gc=false"
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASS }}
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # username: ${{ github.actor }}
          # password: ${{ secrets.GITHUB_TOKEN }}
          username: ${{ secrets.PACKAGE_USER }}
          password: ${{ secrets.PACKAGE_TOKEN }}
      - name: Pull Docker image from Docker Hub
        run: |
          docker pull --platform linux/amd64 ${{ matrix.target_images }}
          docker tag ${{ matrix.target_images }} ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME}-amd64

          docker pull --platform linux/arm64/v8 ${{ matrix.target_images }}
          docker tag ${{ matrix.target_images }} ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME}-arm-v8

          docker pull --platform linux/arm64/v7 ${{ matrix.target_images }}
          docker tag ${{ matrix.target_images }} ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME}-arm-v7

          docker images
      - name: Push Docker image to GHCR
        run: |
          docker buildx imagetools create \
              -t ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME} \
              ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME}-amd64 \
              ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME}-arm-v8 \
              ghcr.io/${ORG}/${REPO}/${CREATED_IMAGE_NAME}-arm-v7
