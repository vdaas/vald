name: "Pull Request Labeler"
on:
- pull_request

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/labeler@v2
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
    - name: add labels to the PR
      run: |
        pr_num=`cat $GITHUB_EVENT_PATH | jq -r ".number"`
        branch_name=`cat $GITHUB_EVENT_PATH | jq -r ".pull_request.head.ref"`
        type_labels=(
            "type/test"
            "type/bug"
            "type/documentation"
            "type/feature"
            "type/refactoring"
            "type/security"
            "type/test"
            "type/ci"
            "type/dependency"
        )
        send_labels=()

        echo "branch name: " $branch_name
        for label in ${type_labels[@]}
        do
          if [ "${branch_name%%/*}" = "${label#type/}" ] ; then
            send_labels+=(\"$label\")
          fi
        done

        additions=`cat $GITHUB_EVENT_PATH | jq -r ".pull_request.additions"`
        deletions=`cat $GITHUB_EVENT_PATH | jq -r ".pull_request.deletions"`
        size=`expr ${additions} + ${deletions}`

        if [ $size -le 29 ]; then
          send_labels+=(\"size/S\")
        elif [ $size -le 99 ]; then
          send_labels+=(\"size/M\")
        else
          send_labels+=(\"size/L\")
        fi

        if [ ${#send_labels[@]} -gt 0 ]; then
          str="$(IFS=,; echo "${send_labels[*]}")"
          data="{\"labels\": [$str]}"
          echo "send data: " $data
          curl --request POST \
               --url https://api.github.com/repos/${{ github.repository }}/issues/${pr_num}/labels \
               --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
               --header 'content-type: application/json' \
               --data "$data"
        fi
