#
# Copyright (C) 2019-2020 Vdaas.org Vald team ( kpango, rinx, kmrmt )
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

defaults:
  server_config:
    servers:
      rest:
        enabled: false
        host: 0.0.0.0
        port: 8080
      grpc:
        enabled: false
        host: 0.0.0.0
        port: 8081
    healths:
      liveness:
        enabled: false
        host: 0.0.0.0
        port: 3000
      readiness:
        enabled: false
        host: 0.0.0.0
        port: 3001
    metrics:
      pprof:
        enabled: false
        host: 0.0.0.0
        port: 6060
    full_shutdown_duration: 600s
    tls:
      enabled: false
      cert: /path/to/cert
      key: /path/to/key
      ca: /path/to/ca
  grpc:
    client:
      addrs: []
      health_check_duration: "1s"
      backoff:
        initial_duration: ""
        backoff_time_limit: ""
        maximum_duration: ""
        jitter_limit: ""
        backoff_factor: 0
        retry_count: 0
        enable_error_log: false
      call_option:
        wait_for_ready: true
        max_retry_rpc_buffer_size: 0
        max_recv_msg_size: 0
        max_send_msg_size: 0
      dial_option:
        write_buffer_size: 0
        read_buffer_size: 0
        initial_window_size: 0
        initial_connection_window_size: 0
        max_msg_size: 0
        max_backoff_delay: ""
        enable_backoff: false
        insecure: true
        timeout: ""
        dialer:
          dns:
            cache_enabled: false
            refresh_duration: ""
            cache_expiration: ""
          dialer:
            timeout: ""
            keep_alive: ""
            dual_stack_enabled: true
          tls:
            enabled: false
            cert: /path/to/cert
            key: /path/to/key
            ca: /path/to/ca
        keep_alive:
          time: ""
          timeout: ""
          permit_without_stream: false
      tls:
        enabled: false
        cert: /path/to/cert
        key: /path/to/key
        ca: /path/to/ca

gateway:
  name: vald-gateway
  minReplicas: 3
  maxReplicas: 9
  hpa:
    enabled: true
    targetCPUUtilizationPercentage: 80
  image:
    repository: vdaas/vald-gateway
    tag: nightly
    pullPolicy: Always
  initContainers:
    - type: waitFor
      name: wait-for-manager-compressor
      target: compressor
      image: busybox
      sleepDuration: 2
    - type: waitFor
      name: wait-for-meta
      target: meta
      image: busybox
      sleepDuration: 2
    - type: waitFor
      name: wait-for-discoverer
      target: discoverer
      image: busybox
      sleepDuration: 2
    - type: waitFor
      name: wait-for-agent
      target: agent
      image: busybox
      sleepDuration: 2
  server_config:
    prefix: gateway
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false
  filter:
    egress:
      - ""
    ingress:
      - ""
  ingress:
    annotations:
      nginx.ingress.kubernetes.io/grpc-backend: "true"
    host: vald.gateway.vdaas.org
  resources:
    requests:
      cpu: 200m
    limits:
      cpu: 500m
  gateway_config:
    index_replica: 5
    discoverer:
      duration: "2s"
      discover_client: {}
      agent_client: {}
    meta:
      client: {}
    backup:
      client: {}

agent:
  name: vald-agent-ngt
  minReplicas: 20
  maxReplicas: 300
  maxUnavailable: 1
  image:
    repository: vdaas/vald-agent-ngt
    tag: nightly
    pullPolicy: Always
  server_config:
    prefix: agent
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false
  ngt:
    # index_path: /path/to/index
    auto_index_limit: 10m
    auto_index_check_duration: 1m
    auto_index_length: 100
    dimension: 4096
    bulk_insert_chunk_size: 10
    distance_type: l2
    object_type: float
    creation_edge_size: 20
    search_edge_size: 10
    enable_in_memory_mode: true

discoverer:
  name: vald-discoverer
  minReplicas: 1
  maxReplicas: 2
  image:
    repository: vdaas/vald-discoverer-k8s
    tag: nightly
    pullPolicy: Always
  server_config:
    prefix: discoverer
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false

compressor:
  name: vald-manager-compressor
  minReplicas: 3
  maxReplicas: 15
  hpa:
    enabled: true
    targetCPUUtilizationPercentage: 80
  image:
    repository: vdaas/vald-manager-compressor
    tag: nightly
    pullPolicy: Always
  initContainers:
    - type: waitFor
      name: wait-for-manager-backup
      target: manager-backup
      image: busybox
      sleepDuration: 2
  server_config:
    prefix: manager-compressor
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false
  resources:
    requests:
      cpu: 200m
    limits:
      cpu: 500m
  backup:
    client: {}
  compress:
    compress_algorithm: lz4
    concurrent_limit: 10
    buffer: 100

backupManager:
  name: vald-manager-backup
  minReplicas: 3
  maxReplicas: 15
  hpa:
    enabled: true
    targetCPUUtilizationPercentage: 80
  image:
    repository: vdaas/vald-manager-backup-mysql
    # repository: vdaas/vald-manager-backup-cassandra
    tag: nightly
    pullPolicy: Always
  initContainers:
    - type: waitFor
      name: wait-for-mysql
      image: mysql:latest
      target: custom
      whileCondition: $(mysqladmin -hmysql.default.svc.cluster.local -uroot -p${MYSQL_PASSWORD} --show-warnings=false ping | grep alive | awk '{print $3}') -ne alive
      sleepDuration: 2
      env:
      - name: MYSQL_PASSWORD
        valueFrom:
          secretKeyRef:
            name: mysql-secret
            key: password
    # - type: waitFor
    #   name: wait-for-cassandra
    #   image: cassandra:latest
    #   target: custom
    #   whileCondition: $(cqlsh cassandra.default.svc.cluster.local -uroot -p${CASSANDRA_PASSWORD} -e "select now() from system.local" > /dev/null; echo $?) -ne 0
    #   sleepDuration: 2
    #   env:
    #   - name: CASSANDRA_PASSWORD
    #     valueFrom:
    #       secretKeyRef:
    #         name: cassandra-secret
    #         key: ""
  server_config:
    prefix: backup-manager
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false
  resources:
    requests:
      cpu: 200m
    limits:
      cpu: 500m
  mysql:
    enabled: true
    config:
      db: mysql
      host: mysql.default.svc.cluster.local
      port: 3306
      user: root
      pass: password
      name: vald
      conn_max_life_time: 30s
      max_open_conns: 100
      max_idle_conns: 100
      tls:
        enabled: false
        cert: /path/to/cert
        key: /path/to/key
        ca: /path/to/ca
      tcp:
        dns:
          cache_enabled: true
          refresh_duration: 1h
          cache_expiration: 24h
        dialer:
          timeout: 5s
          keep_alive: 5m
          dual_stack_enabled: false
        tls:
          enabled: false
          cert: /path/to/cert
          key: /path/to/key
          ca: /path/to/ca
  cassandra:
    enabled: false
    config:
      hosts:
        - cassandra-0.cassandra.default.svc.cluster.local
        - cassandra-1.cassandra.default.svc.cluster.local
        - cassandra-2.cassandra.default.svc.cluster.local
      cql_version: 3.0.0
      proto_version: 0
      timeout: 600ms
      connect_timeout: 600ms
      port: 9042
      keyspace: vald
      num_conns: 2
      consistency:  quorum
      username: ""
      password: ""
      retry_policy:
        num_retries: 3
        min_duration: 1s
        max_duration: 30s
      reconnection_policy:
        max_retries: 3
        initial_interval: 1m
      socket_keepalive: 0s
      max_prepared_stmts: 1000
      max_routing_key_info: 1000
      page_size: 5000
      tls:
        enabled: false
        cert: /path/to/cert
        key: /path/to/key
        ca: /path/to/ca
      enable_host_verification: false
      default_timestamp: true
      reconnect_interval: 1m
      max_wait_schema_agreement: 1m
      ignore_peer_addr: false
      disable_initial_host_lookup: false
      disable_node_status_events: false
      disable_topology_events: false
      disable_skip_metadata: false
      default_idempotence: false
      write_coalesce_wait_time: 200ms
      meta_table: meta_vector

indexManager:
  name: vald-index-manager-ngt
  minReplicas: 1
  maxReplicas: 2
  image:
    repository: vdaas/vald-index-manager-ngt
    tag: nightly
    pullPolicy: Always
  server_config:
    prefix: index-manager
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false

meta:
  name: vald-meta
  minReplicas: 2
  maxReplicas: 10
  hpa:
    enabled: true
    targetCPUUtilizationPercentage: 80
  image:
    repository: vdaas/vald-meta-redis
    # repository: vdaas/vald-meta-cassandra
    tag: nightly
    pullPolicy: Always
  initContainers:
    - type: waitFor
      name: wait-for-redis
      image: redis:latest
      target: custom
      whileCondition: $(redis-cli -h redis.default.svc.cluster.local -a ${REDIS_PASSWORD}) -ne 200
      sleepDuration: 2
      env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: password
    # - type: waitFor
    #   name: wait-for-cassandra
    #   image: cassandra:latest
    #   target: custom
    #   whileCondition: $(cqlsh cassandra.default.svc.cluster.local -uroot -p${CASSANDRA_PASSWORD} -e "select now() from system.local" > /dev/null; echo $?) -ne 0
    #   sleepDuration: 2
    #   env:
    #   - name: CASSANDRA_PASSWORD
    #     valueFrom:
    #       secretKeyRef:
    #         name: cassandra-secret
    #         key: ""
  server_config:
    prefix: meta
    servers:
      rest:
        enabled: true
      grpc:
        enabled: true
    healths:
      liveness:
        enabled: true
      readiness:
        enabled: true
    metrics:
      pprof:
        enabled: true
    full_shutdown_duration: 600s
    tls:
      enabled: false
  resources:
    requests:
      cpu: 200m
    limits:
      cpu: 500m
  redis:
    enabled: true
    config:
      addrs:
        - redis.default.svc.cluster.local:6379
      db: 0
      dial_timeout: 5s
      idle_check_frequency: 1m
      idle_timeout: 5m
      key_pref: ""
      max_conn_age: 0s
      max_redirects: 3
      max_retries: 0
      max_retry_backoff: 512ms
      min_idle_conns: 0
      min_retry_backoff: 8ms
      password: password
      pool_size: 10
      pool_timeout: 4s
      read_only: false
      read_timeout: 3s
      write_timeout: 3s
      route_by_latency: false
      route_randomly: true
      tls:
        enabled: false
      tcp:
        dns:
          cache_enabled: true
          refresh_duration: 1h
          cache_expiration: 24h
        dialer:
          timeout: 5s
          keep_alive: 5m
          dual_stack_enabled: false
        tls:
          enabled: false
      kv_prefix: ""
      vk_prefix: ""
      prefix_delimiter: ""
  cassandra:
    enabled: false
    config:
      hosts:
        - cassandra-0.cassandra.default.svc.cluster.local
        - cassandra-1.cassandra.default.svc.cluster.local
        - cassandra-2.cassandra.default.svc.cluster.local
      cql_version: 3.0.0
      proto_version: 0
      timeout: 600ms
      connect_timeout: 600ms
      port: 9042
      keyspace: vald
      num_conns: 2
      consistency:  quorum
      username: ""
      password: ""
      retry_policy:
        num_retries: 3
        min_duration: 1s
        max_duration: 30s
      reconnection_policy:
        max_retries: 3
        initial_interval: 1m
      socket_keepalive: 0s
      max_prepared_stmts: 1000
      max_routing_key_info: 1000
      page_size: 5000
      tls:
        enabled: false
        cert: /path/to/cert
        key: /path/to/key
        ca: /path/to/ca
      enable_host_verification: false
      default_timestamp: true
      reconnect_interval: 1m
      max_wait_schema_agreement: 1m
      ignore_peer_addr: false
      disable_initial_host_lookup: false
      disable_node_status_events: false
      disable_topology_events: false
      disable_skip_metadata: false
      default_idempotence: false
      write_coalesce_wait_time: 200ms
      kv_table: kv
      vk_table: vk
