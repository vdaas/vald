<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Build Proto</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Build Proto"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.5/api/build_proto/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.5/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.5/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.5/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.5 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.5</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.8</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.5/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.5/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/v1.5/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.5/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/v1.5/overview/component/lb-gateway/>LB Gateway</a></li><li class=index><a href=/docs/v1.5/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.5/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/v1.5/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.5/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/v1.5/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/v1.5/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.5/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.5/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/v1.5/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/v1.5/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/v1.5/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/v1.5/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/v1.5/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/v1.5/user-guides/search-config/>Search Config</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.5/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/v1.5/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/v1.5/api/insert/>Insert</a></li><li class=index><a href=/docs/v1.5/api/update/>Update</a></li><li class=index><a href=/docs/v1.5/api/upsert/>Upsert</a></li><li class=index><a href=/docs/v1.5/api/search/>Search</a></li><li class=index><a href=/docs/v1.5/api/remove/>Remove</a></li><li class=index><a href=/docs/v1.5/api/object/>Object</a></li><li class=view><a href=/docs/v1.5/api/build_proto/>Build Proto</a></li><li class=index><a href=/docs/v1.5/api/status/>Status Code</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/v1.5/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/v1.5/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.5/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.5/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/v1.5/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.5/support/contacts/>Contacts</a></li><li class=index><a href=/docs/v1.5/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/v1.5/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=building-grpc-proto>Building gRPC proto</h1><p>This page shows how to build gRPC proto file for calling API to your Vald Cluster.</p><div class=notice>Vald provides the official client libraries (see: <a href=https://vald.vdaas.org/docs/user-guides/sdks>SDK document</a> ).
If you can use one of the SDKs we recommend using it.</div><h2 id=target-proto-files>Target proto files</h2><p>Vald defines the proto file for each API.
Let&rsquo;s check the below table for the details.</p><table><thead><tr><th style=text-align:center>API service name</th><th style=text-align:center>proto</th><th style=text-align:center>dependencies</th><th style=text-align:left>usage</th></tr></thead><tbody><tr><td style=text-align:center>Insert</td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/vald/insert.proto>insert.proto</a></td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/payload/payload.proto>payload.proto</a><br><a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>annotation.proto</a></td><td style=text-align:left>Insert vectors into Vald Agent</td></tr><tr><td style=text-align:center>Update</td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/vald/update.proto>update.proto</a></td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/payload/payload.proto>payload.proto</a><br><a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>annotation.proto</a></td><td style=text-align:left>Update vectors stored in Vald Agent</td></tr><tr><td style=text-align:center>Upsert</td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/vald/upsert.proto>upsert.proto</a></td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/payload/payload.proto>payload.proto</a><br><a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>annotation.proto</a></td><td style=text-align:left>Update vectors stored Vald Agent or Insert vectors into Vald Agent</td></tr><tr><td style=text-align:center>Search</td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/vald/search.proto>search.proto</a></td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/payload/payload.proto>payload.proto</a><br><a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>annotation.proto</a></td><td style=text-align:left>Search similar vectors with query</td></tr><tr><td style=text-align:center>Remove</td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/vald/remove.proto>remove.proto</a></td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/payload/payload.proto>payload.proto</a><br><a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>annotation.proto</a></td><td style=text-align:left>Remove stored vectors from Vald Agent</td></tr><tr><td style=text-align:center>Object</td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/vald/object.proto>object.proto</a></td><td style=text-align:center><a href=https://github.com/vdaas/vald/blob/main/apis/proto/v1/payload/payload.proto>payload.proto</a><br><a href=https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto>annotation.proto</a></td><td style=text-align:left>Get object information of vector stored in Vald Agent</td></tr></tbody></table><h2 id=how-to-build-protobuf>How to build protobuf</h2><h3 id=the-way-to-build-proto-files>The way to build proto files</h3><p>Let&rsquo;s build proto files using your favorite programming language.</p><p>There are 3 steps to building API proto:</p><ol><li><p>Install gRPC tools</p><ul><li>gRPC official document provides <a href=https://grpc.io/docs/languages/>the way to install for each language</a>.<br>If your favorite programming language is not there, you can find 3rd party tools for building.</li></ul></li><li><p>Download Vald api proto files and external dependence</p><ul><li><a href=https://github.com/vdaas/vald/tree/main/apis/proto/v1/vald>vald api proto</a></li><li><a href=https://github.com/vdaas/vald/tree/main/apis/proto/v1/payload>vald payload proto</a></li><li><a href=https://github.com/googleapis/googleapis>googleapis</a></li><li><a href=https://github.com/envoyproxy/protoc-gen-validate>PGV</a></li></ul></li><li><p>Choose proto file(s) and build</p></li></ol><h3 id=example-build-proto-files-in-rust>Example: Build proto files in Rust</h3><p>This section shows the example steps for building proto files using Rust.</p><p>There are many tools for building proto in Rust, we use <a href=https://github.com/hyperium/tonic>tonic</a> as an example.</p><ol><li><p>Check version</p><p>This example runs in this environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo version
</span></span><span style=display:flex><span>cargo 1.58.0 <span style=color:#f92672>(</span>7f08ace4f 2021-11-24<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ rustc -V
</span></span><span style=display:flex><span>rustc 1.58.0 <span style=color:#f92672>(</span>02072b482 2022-01-11<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ rustup -V
</span></span><span style=display:flex><span>rustup 1.24.3 <span style=color:#f92672>(</span>ce5817a94 2021-05-31<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>info: This is the version <span style=color:#66d9ef>for</span> the rustup toolchain manager, not the rustc compiler.
</span></span><span style=display:flex><span>info: The currently active <span style=color:#e6db74>`</span>rustc<span style=color:#e6db74>`</span> version is <span style=color:#e6db74>`</span>rustc 1.57.0 <span style=color:#f92672>(</span>f1edd0429 2021-11-29<span style=color:#f92672>)</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>$ rustup show
</span></span><span style=display:flex><span>Default host: x86_64-unknown-linux-gnu
</span></span><span style=display:flex><span>rustup home:  /home/user/.rustup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stable-x86_64-unknown-linux-gnu <span style=color:#f92672>(</span>default<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>rustc 1.58.0 <span style=color:#f92672>(</span>02072b482 2022-01-11<span style=color:#f92672>)</span>
</span></span></code></pre></div></li><li><p>Create project</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo new --lib vald-grpc
</span></span></code></pre></div></li><li><p>Edit <code>Cargo.toml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd vald-grpc <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>vim Cargo.toml
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>package<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vald-grpc&#34;</span>
</span></span><span style=display:flex><span>version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.1.0&#34;</span>
</span></span><span style=display:flex><span>edition <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2021&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span>bin<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;client&#34;</span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;src/client.rs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>dependencies<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>tonic <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.6.2&#34;</span>
</span></span><span style=display:flex><span>tokio <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.15&#34;</span>
</span></span><span style=display:flex><span>prost <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.9&#34;</span>
</span></span><span style=display:flex><span>prost-types <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.9&#34;</span>
</span></span><span style=display:flex><span>hdf5 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.8.1&#34;</span>
</span></span><span style=display:flex><span>chrono <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;^0.4&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>build-dependencies<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>tonic-build <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.6.2&#34;</span>
</span></span></code></pre></div></li><li><p>Download Vald proto files and dependence proto files</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// create proto file root dir
</span></span><span style=display:flex><span>mkdir -p proto
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// download vald proto files
</span></span><span style=display:flex><span>git clone https://github.com/vdaas/vald <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#f92672>&amp;&amp;</span> cp -R vald/apis/proto/v1/vald proto/vald <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#f92672>&amp;&amp;</span> cp -R vald/apis/proto/v1/payload proto/payload <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#f92672>&amp;&amp;</span> rm -rf vald
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// download googleapis
</span></span><span style=display:flex><span>git clone https://github.com/googleapis/googleapis <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#f92672>&amp;&amp;</span> cp -R googleapis/google proto/google <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#f92672>&amp;&amp;</span> rm -rf googleapis
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// download protoc-gen-validate
</span></span><span style=display:flex><span>git clone https://github.com/envoyproxy/protoc-gen-validate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#f92672>&amp;&amp;</span> mv protoc-gen-validate proto/protoc-gen-validate
</span></span></code></pre></div></li><li><p>Fixing import path</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>find proto/vald -type f -name <span style=color:#e6db74>&#34;*.proto&#34;</span> | xargs sed -i <span style=color:#e6db74>&#34;s/apis\/proto\/v1\///g&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>find proto/vald -type f -name <span style=color:#e6db74>&#34;*.proto&#34;</span> | xargs sed -i <span style=color:#e6db74>&#34;s/github\.com\/googleapis\/googleapis\///g&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>find proto/payload -type f -name <span style=color:#e6db74>&#34;*.proto&#34;</span> | xargs sed -i <span style=color:#e6db74>&#34;s/github\.com\/googleapis\/googleapis\///g&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>find proto/payload -type f -name <span style=color:#e6db74>&#34;*.proto&#34;</span> | xargs sed -i <span style=color:#e6db74>&#34;s/github\.com\/envoyproxy\///g&#34;</span>
</span></span></code></pre></div></li><li><p>Implement <code>build.rs</code> and Build proto</p><ol><li><p><code>build.rs</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>(), Box<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>dyn</span> std::error::Error<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> insert_proto <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./proto/vald/insert.proto&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> update_proto <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./proto/vald/update.proto&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> upsert_proto <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./proto/vald/upsert.proto&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> search_proto <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./proto/vald/search.proto&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> remove_proto <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./proto/vald/remove.proto&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> object_proto <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./proto/vald/object.proto&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tonic_build::configure()
</span></span><span style=display:flex><span>        .build_client(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        .out_dir(<span style=color:#e6db74>&#34;./src/proto&#34;</span>)
</span></span><span style=display:flex><span>        .compile(
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span>[
</span></span><span style=display:flex><span>                insert_proto,
</span></span><span style=display:flex><span>                update_proto,
</span></span><span style=display:flex><span>                upsert_proto,
</span></span><span style=display:flex><span>                search_proto,
</span></span><span style=display:flex><span>                remove_proto,
</span></span><span style=display:flex><span>                object_proto,
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span>[<span style=color:#e6db74>&#34;./proto&#34;</span>],
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        .unwrap_or_else(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> panic!(<span style=color:#e6db74>&#34;protobuf compile error: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, e));
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>build proto</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo build
</span></span></code></pre></div></li></ol></li><li><p>Edit <code>Cargo.toml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd vald-grpc <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>vim Cargo.toml
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>package<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span>bin<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;client&#34;</span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;src/client.rs&#34;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li><li><p>Implement code using client</p><ol><li><p><code>lib.rs</code></p><p>Import build proto in <code>src/lib.rs</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> vald {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> v1 {
</span></span><span style=display:flex><span>        include!(<span style=color:#e6db74>&#34;./proto/vald.v1.rs&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> payload {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> v1 {
</span></span><span style=display:flex><span>        include!(<span style=color:#e6db74>&#34;./proto/payload.v1.rs&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> google {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> rpc {
</span></span><span style=display:flex><span>        include!(<span style=color:#e6db74>&#34;./proto/google.rpc.rs&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> api {
</span></span><span style=display:flex><span>        include!(<span style=color:#e6db74>&#34;./proto/google.api.rs&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> protobuf {
</span></span><span style=display:flex><span>        include!(<span style=color:#e6db74>&#34;./proto/google.protobuf.rs&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><code>src/clinet.rs</code></p><p>There are 4 steps in <code>src/clinet.rs</code>:</p><ol><li>Load dataset</li><li>Insert vector to Vald cluster</li><li>Search nearest neighbor vectors from Vald cluster after indexing finished</li><li>Remove indexed vectors from Vald cluster</li></ol><p>The example is here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// import packages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> chrono::Utc;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> hdf5::{File, Result};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std:<span style=color:#960050;background-color:#1e0010>ðŸ§µ</span>:<span style=color:#a6e22e>sleep</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::time;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tonic::transport::Endpoint;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// import vald protos
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> vald_sample_rust_client::payload::v1::insert;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> vald_sample_rust_client::payload::v1::object;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> vald_sample_rust_client::payload::v1::remove;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> vald_sample_rust_client::payload::v1::search;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> vald_sample_rust_client::vald::v1::insert_client;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> vald_sample_rust_client::vald::v1::remove_client;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> vald_sample_rust_client::vald::v1::search_client;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Dataset file name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>FILE</span>: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fashion-mnist-784-euclidean.hdf5&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// Dataset name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>DATASET</span>: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;train&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// set Vald cluster host
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>HOST</span>: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:8080&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// Time duration for waiting to finish `CreateIndex` and `SaveIndex`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>DURATION</span>: <span style=color:#66d9ef>u64</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// load data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>read_file</span>() -&gt; Result<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>f32</span><span style=color:#f92672>&gt;&gt;&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> file <span style=color:#f92672>=</span> File::open(<span style=color:#66d9ef>FILE</span>).unwrap_or_else(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> panic!(<span style=color:#e6db74>&#34;[ERR] failed to read file: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, e));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> data <span style=color:#f92672>=</span> file
</span></span><span style=display:flex><span>        .dataset(<span style=color:#66d9ef>DATASET</span>)
</span></span><span style=display:flex><span>        .unwrap_or_else(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> panic!(<span style=color:#e6db74>&#34;[ERR] failed to get dataset: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, e));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> vector <span style=color:#f92672>=</span> Vec::new();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> train <span style=color:#66d9ef>in</span> data.read_2d::<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>f32</span><span style=color:#f92672>&gt;</span>()<span style=color:#f92672>?</span>.outer_iter() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> vec: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>f32</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> Vec::new();
</span></span><span style=display:flex><span>        vec.append(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> train.to_vec());
</span></span><span style=display:flex><span>        vector.push(vec);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> vector.len() <span style=color:#f92672>==</span> <span style=color:#ae81ff>500</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Ok(vector)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main(flavor = </span><span style=color:#e6db74>&#34;current_thread&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>(), Box<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>dyn</span> std::error::Error<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[Start] Load </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> file</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>FILE</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> vec <span style=color:#f92672>=</span> read_file()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[End] Success to load </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> file</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>FILE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[Start] Insert phase</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create insert client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> insert_client <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        insert_client::InsertClient::connect(Endpoint::from_static(<span style=color:#66d9ef>HOST</span>)).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> ids: Vec<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> Vec::new();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> v <span style=color:#66d9ef>in</span> vec.iter() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> id <span style=color:#f92672>=</span> Utc::now().timestamp_nanos().to_string();
</span></span><span style=display:flex><span>        ids.push(id.to_string());
</span></span><span style=display:flex><span>        <span style=color:#75715e>// insert vector
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> insert_client
</span></span><span style=display:flex><span>            .insert(insert::Request {
</span></span><span style=display:flex><span>                vector: Some(object::Vector {
</span></span><span style=display:flex><span>                    id: <span style=color:#a6e22e>id</span>.to_string(),
</span></span><span style=display:flex><span>                    vector: <span style=color:#a6e22e>v</span>.to_vec(),
</span></span><span style=display:flex><span>                }),
</span></span><span style=display:flex><span>                config: Some(insert::Config {
</span></span><span style=display:flex><span>                    skip_strict_exist_check: <span style=color:#a6e22e>true</span>,
</span></span><span style=display:flex><span>                    filters: None,
</span></span><span style=display:flex><span>                    timestamp: <span style=color:#a6e22e>Utc</span>::now().timestamp(),
</span></span><span style=display:flex><span>                }),
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>            .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[End] Finish Insert Phase</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[Sleep] Waiting SaveIndex is completed...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    sleep(time::Duration::from_secs(<span style=color:#66d9ef>DURATION</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[Start] Search phase</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create search client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> search_client <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        search_client::SearchClient::connect(Endpoint::from_static(<span style=color:#66d9ef>HOST</span>)).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> id <span style=color:#66d9ef>in</span> ids.clone() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// search nearest neighbor vectors using searchById method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> res <span style=color:#f92672>=</span> search_client
</span></span><span style=display:flex><span>            .search_by_id(search::IdRequest {
</span></span><span style=display:flex><span>                id: <span style=color:#a6e22e>id</span>.to_string(),
</span></span><span style=display:flex><span>                config: Some(search::Config {
</span></span><span style=display:flex><span>                    request_id: <span style=color:#a6e22e>id</span>.to_string(),
</span></span><span style=display:flex><span>                    num: <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>                    radius: <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>                    epsilon: <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>                    timeout: <span style=color:#ae81ff>500</span>,
</span></span><span style=display:flex><span>                    ingress_filters: None,
</span></span><span style=display:flex><span>                    egress_filters: None,
</span></span><span style=display:flex><span>                }),
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>            .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        print!(<span style=color:#e6db74>&#34;[Id]: </span><span style=color:#e6db74>{:?}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, id.to_string());
</span></span><span style=display:flex><span>        print!(<span style=color:#e6db74>&#34;[Result]: </span><span style=color:#e6db74>{:#?}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, res.into_inner().results);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[End] Finish Search Phase</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[Start] Remove phase</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create remove client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> remove_client <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        remove_client::RemoveClient::connect(Endpoint::from_static(<span style=color:#66d9ef>HOST</span>)).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> id <span style=color:#66d9ef>in</span> ids.clone() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// remove vectors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> remove_client
</span></span><span style=display:flex><span>            .remove(remove::Request {
</span></span><span style=display:flex><span>                id: Some(object::Id { id: <span style=color:#a6e22e>id</span>.to_string() }),
</span></span><span style=display:flex><span>                config: None,
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>            .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    print!(<span style=color:#e6db74>&#34;[End] Finish Remove phase</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol></li><li><p>Build</p><p>Build implemented codes before running example code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo build
</span></span></code></pre></div></li><li><p>Running example</p><p>After creating Vald cluster, you can run an example code by the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo run src/client.rs
</span></span></code></pre></div></li></ol></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#target-proto-files>Target proto files</a></li><li><a href=#how-to-build-protobuf>How to build protobuf</a><ul><li><a href=#the-way-to-build-proto-files>The way to build proto files</a></li><li><a href=#example-build-proto-files-in-rust>Example: Build proto files in Rust</a></li></ul></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.5/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.5/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.5/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.5 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>Â©2019-2022 vald.vdaas.org Vald team</p></footer></body></html>