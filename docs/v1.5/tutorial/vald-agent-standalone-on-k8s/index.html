<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Vald Agent Standalone on K8s</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Vald Agent Standalone on K8s"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.5/tutorial/vald-agent-standalone-on-k8s/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.5/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.5/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.5/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.5 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.5</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.5/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.5/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/v1.5/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.5/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/v1.5/overview/component/lb-gateway/>LB Gateway</a></li><li class=index><a href=/docs/v1.5/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.5/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/v1.5/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.5/tutorial/get-started/>Get Started</a></li><li class=view><a href=/docs/v1.5/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/v1.5/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.5/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.5/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/v1.5/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/v1.5/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/v1.5/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/v1.5/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/v1.5/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/v1.5/user-guides/search-config/>Search Config</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.5/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/v1.5/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/v1.5/api/insert/>Insert</a></li><li class=index><a href=/docs/v1.5/api/update/>Update</a></li><li class=index><a href=/docs/v1.5/api/upsert/>Upsert</a></li><li class=index><a href=/docs/v1.5/api/search/>Search</a></li><li class=index><a href=/docs/v1.5/api/remove/>Remove</a></li><li class=index><a href=/docs/v1.5/api/object/>Object</a></li><li class=index><a href=/docs/v1.5/api/build_proto/>Build Proto</a></li><li class=index><a href=/docs/v1.5/api/status/>Status Code</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/v1.5/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/v1.5/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.5/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.5/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/v1.5/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.5/support/contacts/>Contacts</a></li><li class=index><a href=/docs/v1.5/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/v1.5/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=vald-agent-standalone-on-kubernetes>Vald Agent Standalone on Kubernetes</h1><p>This article will show you how to deploy a standalone Vald Agent using Helm and run it on your Kubernetes cluster.</p><h2 id=overview>Overview</h2><p>Vald is made up of multiple microservices.
In <a href=/docs/v1.5/tutorial/get-started>Get Started</a>, you may use 4 kinds of components to deploy Vald.
In this case, you use only 1 component, <code>Vald Agent</code> that is the core component for Vald named <code>vald-agent-ngt</code>, to deploy.
The below image shows the architecture image of this case.</p><img src=/images/v1.5/tutorial/vald-agent-standalone-on-k8s.svg><div class=warning>Using only Vald Agent, the auto indexing function is not in use.</div><p>The 5 steps to Vald Agent Standalone on Kubernetes with Vald:</p><ol><li><a href=#requirements>Check and Satisfy the Requirements</a></li><li><a href=#prepare-the-kubernetes-cluster>Prepare Kubernetes Cluster</a></li><li><a href=#deploy-vald-agent-standalone-on-kubernetes-cluster>Deploy Vald Agent Standalone on Kubernetes cluster</a></li><li><a href=#run-example-code>Run Example Code</a></li><li><a href=#cleanup>Cleanup</a></li></ol><h2 id=requirements>Requirements</h2><ul><li>Kubernetes: v1.19 ~</li><li>Go: v1.15 ~</li><li>Helm: v3 ~</li><li>libhdf5 (<em>only required for tutorial</em>)</li></ul><p>Helm is used to deploying Vald on your Kubernetes, and Hdf5 decodes the sample data.<br>If Helm or HDF5 is not installed, please install <a href=https://helm.sh/docs/intro/install>Helm</a> and <a href=https://www.hdfgroup.org/>HDF5</a>.</p><details><summary>Installation command for Helm</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
</span></span></code></pre></div></details><details><summary>Installation command for HDF5</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># yum</span>
</span></span><span style=display:flex><span>yum install -y hdf5-devel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># apt</span>
</span></span><span style=display:flex><span>apt-get install libhdf5-serial-dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># homebrew</span>
</span></span><span style=display:flex><span>brew install hdf5
</span></span></code></pre></div></details><h2 id=prepare-the-kubernetes-cluster>Prepare the Kubernetes Cluster</h2><ol><li><p>Prepare Kubernetes cluster</p><p>To complete get started, the Kubernetes cluster is required.<br>Vald will run on Cloud Services such as GKE, AWS.
In the sense of trying to &ldquo;Get-Started&rdquo;, <a href=https://k3d.io/>k3d</a> or <a href=https://kind.sigs.k8s.io/>kind</a> are easy Kubernetes tools to use.</p></li></ol><h2 id=deploy-vald-agent-standalone-on-kubernetes-cluster>Deploy Vald Agent Standalone on Kubernetes Cluster</h2><p>This chapter will show you how to deploy a standalone Vald Agent using Helm and run it on your Kubernetes cluster.<br>This chapter uses <a href=https://github.com/yahoojapan/ngt>NGT</a> as Vald Agent to perform vector insertion operation, indexing, and searching operation.<br></p><ol><li><p>Clone the repository</p><p>To use the <code>deployment yaml</code> for deployment, let&rsquo;s clone <a href=https://github.com/vdaas/vald.git><code>vdaas/vald</code></a> repository.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/vdaas/vald.git <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>cd vald
</span></span></code></pre></div></li><li><p>Deploy Vald Agent Standalone using Helm</p><p>There is the <a href=https://github.com/vdaas/vald/blob/main/example/helm/values-standalone-agent-ngt.yaml>values.yaml</a> to deploy standalone Vald Agent.
Each component can be disabled by setting the value <code>false</code> to the <code>[component].enabled</code> field.
This is useful for deploying standalone Vald Agent NGT pods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add vald https://vald.vdaas.org/charts <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>helm install vald-agent-ngt vald/vald --values example/helm/values-standalone-agent-ngt.yaml
</span></span></code></pre></div></li><li><p>Verify</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><details><summary>Example output</summary><br>If the deployment is successful, Vald Agent component should be running.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME               READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>vald-agent-ngt-0   1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>vald-agent-ngt-1   1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>vald-agent-ngt-2   1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span><span style=display:flex><span>vald-agent-ngt-3   1/1     Running   <span style=color:#ae81ff>0</span>          20m
</span></span></code></pre></div></details></li></ol><h2 id=run-example-code>Run Example Code</h2><ol><li><p>Port Forward</p><p>At first, port-forward the vald-lb-gateway is required to make request from your local environment possible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward service/vald-agent-ngt 8081:8081
</span></span></code></pre></div></li><li><p>Download dataset</p><p>Download <a href=https://github.com/zalandoresearch/fashion-mnist>Fashion-MNIST</a> that is used as a dataset for indexing and search query.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># move to the work directory</span>
</span></span><span style=display:flex><span>cd example/client/agent
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># download Fashion-MNIST testing dataset</span>
</span></span><span style=display:flex><span>wget http://ann-benchmarks.com/fashion-mnist-784-euclidean.hdf5
</span></span></code></pre></div></li><li><p>Run Example</p><p>We use <a href=https://github.com/vdaas/vald/blob/main/example/client/agent/main.go><code>example/client/agent/main.go</code></a> to run the example.<br>This example will insert and index 400 vectors into the Vald from the Fashion-MNIST dataset via gRPC.
And then after waiting for indexing, it will request for searching the nearest vector 10 times.
You will get the 10 nearest neighbor vectors for each search query.<br>Run example codes by executing the below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># run example</span>
</span></span><span style=display:flex><span>go run main.go
</span></span></code></pre></div><details><summary>The detailed explanation of example code is here</summary><br>This will execute 6 steps.<ol><li><p>init</p><ul><li><p>Import packages</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/kpango/fuid&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/kpango/glg&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span> <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/v1/agent/core&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/v1/vald&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/v1/payload&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;gonum.org/v1/hdf5&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div></details></li><li><p>Set variables</p><ul><li><p>The constant number of training datasets and test datasets.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>insertCount</span> = <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>testCount</span> = <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div></details></li><li><p>The variables for configuration.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>datasetPath</span>         <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpcServerAddr</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>indexingWaitSeconds</span> <span style=color:#66d9ef>uint</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div></details></li></ul></li><li><p>Recognition parameters.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>datasetPath</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#e6db74>&#34;fashion-mnist-784-euclidean.hdf5&#34;</span>, <span style=color:#e6db74>&#34;set dataset path&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>grpcServerAddr</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;127.0.0.1:8081&#34;</span>, <span style=color:#e6db74>&#34;set gRPC server address&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>UintVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>indexingWaitSeconds</span>, <span style=color:#e6db74>&#34;wait&#34;</span>, <span style=color:#ae81ff>60</span>, <span style=color:#e6db74>&#34;set indexing wait seconds&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li></ul></li><li><p>load</p><ul><li><p>Loading from Fashion-MNIST dataset and set id for each vector that is loaded. This step will return the training dataset, test dataset, and ids list of ids when loading is completed with success.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ids</span>, <span style=color:#a6e22e>train</span>, <span style=color:#a6e22e>test</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>datasetPath</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li></ul></li><li><p>Create the gRPC connection and Vald client with gRPC connection.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>grpcServerAddr</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>())
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>agent</span>.<span style=color:#a6e22e>NewAgentClient</span>(<span style=color:#a6e22e>conn</span>)
</span></span></code></pre></div></details></li><li><p>Insert and Index</p><ul><li><p>Insert and Indexing 400 training datasets to the Vald agent.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ids</span> [:<span style=color:#a6e22e>insertCount</span>] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Inserted %d&#34;</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Insert</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Insert_Request</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Vector</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Object_Vector</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Id</span>: <span style=color:#a6e22e>ids</span>[<span style=color:#a6e22e>i</span>],
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Vector</span>: <span style=color:#a6e22e>train</span>[<span style=color:#a6e22e>i</span>],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Config</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Insert_Config</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>SkipStrictExistCheck</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li><li><p>Wait until indexing finish.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>wt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>indexingWaitSeconds</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Wait %s for indexing to finish&#34;</span>, <span style=color:#a6e22e>wt</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>wt</span>)
</span></span></code></pre></div></details></li><li><p>[Optional] Indexing manually instead of waiting for auto indexing
You can set Agent NGT configuration <code>auto_index_duration_limit</code> and <code>auto_index_check_duration</code> for auto indexing.
In this example, you can create index manually using <code>CreateAndSaveIndex()</code> method in the client library</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CreateAndSaveIndex</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Control_CreateIndexRequest</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PoolSize</span>: uint32(<span style=color:#a6e22e>insertCount</span>),
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li></ul></li><li><p>Search</p><ul><li><p>Search 10 neighbor vectors for each 20 test datasets and return a list of neighbor vectors.</p></li><li><p>When getting approximate vectors, the Vald client sends search config and vector to the server via gRPC.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Start search %d times&#34;</span>, <span style=color:#a6e22e>testCount</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>vec</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>test</span>[:<span style=color:#a6e22e>testCount</span>] {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Search</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Search_Request</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Vector</span>: <span style=color:#a6e22e>vec</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Config</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Search_Config</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Num</span>: <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Radius</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Epsilon</span>: <span style=color:#ae81ff>0.1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>100000000</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalIndent</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>GetResults</span>(), <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;%d - Results : %s\n\n&#34;</span>, <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, string(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li></ul></li><li><p>Remove</p><ul><li><p>Remove indexed 400 training datasets from the Vald agent.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ids</span> [:<span style=color:#a6e22e>insertCount</span>] {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Remove_Request</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Id</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Object_ID</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Id</span>: <span style=color:#a6e22e>ids</span>[<span style=color:#a6e22e>i</span>],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Removed %d&#34;</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li><li><p>Remove from the index manually instead of waiting for auto indexing.
The removed vectors still exist in the NGT graph index before the SaveIndex (or CreateAndSaveIndex) API is called.
If you run the below code, the indexes will be removed completely from the Vald Agent NGT graph and the Backup file.</p><details><summary>example code</summary><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>SaveIndex</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Empty</span>{})
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></li></ul></li></ol></details><div class=caution>It would be best to run CreateIndex() after Insert() without waiting for auto-indexing in your client code, even you can wait for the finishing auto createIndex function, which sometimes takes a long time.
The backup files (e.g., ngt-meta.kvsdb) will be in your mount directory when vald-agent-ngt finishes indexing.</div><div class=warning>If you use Go(v1.16~) and catch the error like `missing go.sum entry to add it` when running `go run main.go`, please run `go mod tidy` and retry.
This error comes from Go Command Changes of Go 1.16 Release Notes.(Please refer to https://golang.org/doc/go1.16#go-command for more details).</div></li></ol><h2 id=cleanup>Cleanup</h2><p>In the last, you can remove all deployed Vald pods by executing the below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm uninstall vald-agent-ngt
</span></span></code></pre></div><h2 id=recommended-documents>Recommended Documents</h2><p>Congratulation! You achieved this tutorial!</p><p>For more information, we recommend you to check:</p><ul><li><a href=/docs/v1.5/overview/architecture>Architecture</a></li><li><a href=/docs/v1.5/user-guides/configuration>Configuration</a></li><li><a href=/docs/v1.5/user-guides/operations>Operations</a></li></ul></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#requirements>Requirements</a></li><li><a href=#prepare-the-kubernetes-cluster>Prepare the Kubernetes Cluster</a></li><li><a href=#deploy-vald-agent-standalone-on-kubernetes-cluster>Deploy Vald Agent Standalone on Kubernetes Cluster</a></li><li><a href=#run-example-code>Run Example Code</a></li><li><a href=#cleanup>Cleanup</a></li><li><a href=#recommended-documents>Recommended Documents</a></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.5/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.5/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.5/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.5 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>Â©2019-2022 vald.vdaas.org Vald team</p></footer></body></html>