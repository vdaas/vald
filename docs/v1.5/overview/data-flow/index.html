<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164223416-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-164223416-1")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Data Flow</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Data Flow"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.5/overview/data-flow/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.5/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.5/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.5/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.5 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.5</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.5/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.5/overview/architecture/>Architecture</a></li><li class=view><a href=/docs/v1.5/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.5/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/v1.5/overview/component/lb-gateway/>LB Gateway</a></li><li class=index><a href=/docs/v1.5/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.5/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/v1.5/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.5/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/v1.5/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/v1.5/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.5/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.5/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/v1.5/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/v1.5/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/v1.5/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/v1.5/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/v1.5/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/v1.5/user-guides/search-config/>Search Config</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.5/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/v1.5/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/v1.5/api/insert/>Insert</a></li><li class=index><a href=/docs/v1.5/api/update/>Update</a></li><li class=index><a href=/docs/v1.5/api/upsert/>Upsert</a></li><li class=index><a href=/docs/v1.5/api/search/>Search</a></li><li class=index><a href=/docs/v1.5/api/remove/>Remove</a></li><li class=index><a href=/docs/v1.5/api/object/>Object</a></li><li class=index><a href=/docs/v1.5/api/build_proto/>Build Proto</a></li><li class=index><a href=/docs/v1.5/api/status/>Status Code</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/v1.5/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/v1.5/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.5/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.5/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/v1.5/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.5/support/contacts/>Contacts</a></li><li class=index><a href=/docs/v1.5/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=data-flow>Data Flow</h1><p>This page describes the data flow inside Vald and how to store vector indexes in the Vald Cluster.
It will help you to understand what Vald does from users&rsquo; requests.</p><p>The below image is the basic Vald architecture.</p><img src=/images/v1.5/overview/vald_basic_architecture.svg><p>We will explain using this image in the following sections.</p><ul><li><a href=#data-flow>Data Flow</a><ul><li><a href=#insert>Insert</a></li><li><a href=#search>Search</a></li><li><a href=#update>Update</a></li><li><a href=#upsert>Upsert</a></li><li><a href=#remove>Remove</a></li></ul></li></ul><h2 id=insert>Insert</h2><p>Users can insert a vector to the Vald cluster using Insert API. When the insert command is processed, Vald will intelligently insert the index into the most suitable Vald Agent(s) based on the memory usage of the Vald Agent and the node.</p><p>To obtain the memory usage of Vald Agent and the node, Vald Discoverer must rank which is the most suitable agent to perform the insert request by talking with the kube-apiserver.</p><p>It requires the <code>CreateIndex</code> instruction to Vald Agent by Vald Index Manager or self-updating the index by Vald Agent to provide high searching performance to users because the insert command is not responsible for indexing.</p><div class=warn>A single Vald cluster supports only one embedding space.<br>If you want to support multiple embedded spaces, you may need to consider deploying multiple Vald clusters to support this use case.</div><img src=/images/v1.5/overview/insert_flow.svg><p>When the user inserts data into Vald:</p><ol><li>Vald LB Gateway receives the request from the user. The request includes the vector and the vector ID. The vector ID is the user-defined unique ID for each vector.</li><li>Vald LB Gateway will determine which Vald Agent(s) to process the request based on the resource usage of the nodes and pods and the number of vector replicas.</li><li>Vald LB Gateway will generate the UUID for each inserting vector and forward the generated UUID and the vector data to the selected Vald Agents in parallel. Vald Agent will insert the vector and UUID in an on-memory vector queue.</li><li>A vector queue will be committed to an ANN graph index by a <code>CreateIndex</code> instruction executed by the Vald Index Manager.</li><li>Vald Agent will start to save index data into the file by <code>SaveIndex instruction</code> after Vald Agent successfully <code>CreateIndex</code>.</li></ol><h2 id=search>Search</h2><p>Users can perform a <em>k</em> nearest neighbor vector searching in Vald. The searching performance is extremely high because of the on-memory graph index structure and optimized Vald structure.</p><p>Vald LB Gateway will broadcast the search request to all Vald Agent Pods to search the top <em>k</em> nearest neighbor vectors from each Vald Agent, and the result will be combined and sorted by the distance of the target vector by the Vald LB Gateway.</p><img src=/images/v1.5/overview/search_flow.svg><p>When the user searches a vector from Vald:</p><ol><li>Vald LB Gateway receives a search request from the user. Vald provides two searching interfaces, search by vector and search by the vector ID, to the user.</li><li>Vald LB Gateway will forward the request to all Vald Agents in parallel. Each Vald Agent will search the <em>k</em> nearest neighbor vectors on a memory graph index.</li><li>Vald Agent returns the search result to the Vald LB Gateway. The search result includes the UUID, the vector distance, and the vector. The number of each outcome will be the same as requested.</li><li>Vald LB Gateway will aggregate all searching results from all Vald Agents, then rank the result by the vector distance.</li><li>Vald LB Gateway will return the aggregated searching result to the user.</li></ol><h2 id=update>Update</h2><p>Users can update a vector by sending an update request to Vald.
Vald will execute deleting and inserting instructions to perform a single update command.</p><img src=/images/v1.5/overview/update_flow.svg><p>When the user updates a vector from Vald:</p><ol><li>Vald LB Gateway receives the request from the user. The request includes the existing vector ID(s) and the new vector(s) to be updated.</li><li>Vald LB Gateway will generate the UUID(s) for each vector and broadcast the remove request with the generated UUID(s) to the Vald Agents. Each Vald Agent will remove the vector data and the metadata if the corresponding UUID(s) exist on the in-memory graph index.</li><li>Each Vald Agent will return the result to the Vald LB Gateway if completed to remove the requested data successfully.</li><li>The insertion step will start after the deletion steps. It is the same as insert flow; please refer to the <a href=#insert>Insert</a> section.</li><li>If Vald Agent successfully inserts the request data, it will return success (e.g., IP address of pod) to the Vald LB Gateway.</li><li>Vald LB Gateway will return the result to the user.</li></ol><h2 id=upsert>Upsert</h2><p>Upsert request updates the existing vector if the same vector ID already exists or inserts the vector into Vald.</p><img src=/images/v1.5/overview/upsert_flow.svg><p>When the user upserts a vector to Vald:</p><ol><li>Vald LB Gateway receives the request from the user, including the user&rsquo;s vector ID(s) and the vector(s).</li><li>Vald LB Gateway will broadcast an existing check request to the Vald Agent(s) to check if the vector exists.</li><li>Vald Agent returns the existing check result to Vald LB Gateway.</li><li>If the vector with the same vector ID exists, Vald LB Gateway will send an update request to Vald Agent(s), same as the <a href=#update>update flow</a> step 2 to step 4. If the vector does not exist, Vald LB Gateway will process the <a href=#insert>insert flow</a> from step 2 to step 3. Vald Index Manager will send <code>CreateIndex</code> requests to each Vald Agent regularly.</li><li>Vald Agent(s) return the result to Vald LB Gateway.</li><li>Vald Filter Gateway will return the result to the user.</li></ol><h2 id=remove>Remove</h2><p>Remove request will remove the vector in the Vald cluster.
Vald will broadcast the remove request to all Vald Agents to remove the vector inside the cluster.
It requires the <code>CreateIndex</code> instruction to Vald Agent by the Vald Index Manager or self-updating the index by Vald Agent because the remove command is not responsible for deleting indexes.</p><img src=/images/v1.5/overview/remove_flow.svg><p>When the user removes a vector that exists in the in-memory graph index in Vald Agent:</p><ol><li>Vald LB Gateway receives the remove request from the user. The request includes the vector ID(s), which the user specifies.</li><li>Vald LB Gateway will broadcast the remove request with UUID(s) to the Vald Agents. Each Vald Agent will remove the vector data and the metadata if the corresponding UUID(s) exists in the in-memory graph index.</li><li>If Vald Agent successfully removes the request data, it will return success to the Vald LB Gateway.</li><li>Vald LB Gateway will return the result to the user.</li></ol></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#insert>Insert</a></li><li><a href=#search>Search</a></li><li><a href=#update>Update</a></li><li><a href=#upsert>Upsert</a></li><li><a href=#remove>Remove</a></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.5/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.5/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.5/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.5 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>Â©2019-2022 vald.vdaas.org Vald team</p></footer></body></html>