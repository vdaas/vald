<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164223416-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-164223416-1")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Data Flow</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Data Flow"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.4/overview/data-flow/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.4/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.4/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.4/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.4 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.4</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.4/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.4/overview/architecture/>Architecture</a></li><li class=view><a href=/docs/v1.4/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.4/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/v1.4/overview/component/lb-gateway/>LB Gateway</a></li><li class=index><a href=/docs/v1.4/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/v1.4/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.4/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/v1.4/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li><li class=index><a href=/docs/v1.4/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.4/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.4/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/v1.4/user-guides/sdks/>Sdks</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.4/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/v1.4/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/v1.4/api/insert/>Insert</a></li><li class=index><a href=/docs/v1.4/api/update/>Update</a></li><li class=index><a href=/docs/v1.4/api/upsert/>Upsert</a></li><li class=index><a href=/docs/v1.4/api/search/>Search</a></li><li class=index><a href=/docs/v1.4/api/remove/>Remove</a></li><li class=index><a href=/docs/v1.4/api/object/>Object</a></li><li class=index><a href=/docs/v1.4/api/build_proto/>Build Proto</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.4/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.4/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/v1.4/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.4/support/contacts/>Contacts</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/v1.4/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=data-flow>Data Flow</h1><p>On this page, we describe the data flow inside Vald and how vector indexes are stored in the Vald Cluster.
It will help you to understand what Vald does from users&rsquo; requests.</p><p>The below image is the basic Vald architecture.</p><img src=/images/v1.4/overview/vald_basic_architecture.svg><p>We will explain using this image in the following sections.</p><ul><li><a href=#data-flow>Data Flow</a><ul><li><a href=#insert>Insert</a></li><li><a href=#search>Search</a></li><li><a href=#update>Update</a></li><li><a href=#upsert>Upsert</a></li><li><a href=#delete>Delete</a></li></ul></li></ul><h2 id=insert>Insert</h2><p>Users can insert a vector to Vald cluster using Insert API. When the insert command is processed, Vald will intelligently insert the index into the most suitable Vald Agent(s) based on the memory usage of the Vald Agent and the node.</p><p>To obtain the memory usage of Vald Agent and the node, Vald Discoverer is required to rank which is the most suitable agent to perform the insert request by talking with the kube-apiserver.</p><p>To make the insert command effective, the <code>CreateIndex</code> instruction is required by the Vald Index Manager or Vald Agent itself to update the index to provide extremely high searching performance to users.</p><p>Please note that only one embedding space is supported in a single Vald Cluster, if you want to support multiple embedded spaces, you may need to consider to deploy multiple Vald cluster to support this use case.</p><img src=/images/v1.4/overview/insert_flow_v2.svg><p>When the user inserts data into Vald:</p><ol><li>Vald Ingress receives the request from the user. The request includes the vector and the vector ID. The vector ID is the user-defined unique ID for each vector.</li><li>Vald Ingress will forward the request to the Vald LB Gateway to process the request.</li><li>Vald LB Gateway will determine which Vald Agent(s) to process the request based on the resource usage of the nodes and pods, and the number of vector replicas.</li><li>Vald LB Gateway will generate the UUID, and forward the generated UUID and the vector data to the selected Vald Agents in parallel. Vald Agent will insert the vector and UUID in an on-memory vector queue. A vector queue will be committed to an ANN graph index by a <code>CreateIndex</code> instruction executed by the Vald Index Manager.</li><li>If Vald Agent successfully inserts the request data, it will return success to the Vald LB Gateway.</li><li>Vald LB Gateway will return success to the Vald Ingress.</li><li>Vald Ingress will return the insert result to the user.</li></ol><h2 id=search>Search</h2><p>Users can perform a <em>k</em> nearest neighbor vector searching in Vald. The searching performance is extremely high because of the on-memory graph index structure and optimized Vald structure.</p><p>The search request will be broadcast to all Vald Agents to search the top <em>k</em> nearest neighbor vectors from each Vald Agents, and the result will be combined and sorted by the distance of the target vector by the Vald LB Gateway.</p><img src=/images/v1.4/overview/search_flow_v2.svg><p>When the user searches a vector from Vald:</p><ol><li>Vald Ingress receives a search request from the user. Vald provides 2 searching interfaces to the user, the user can search by vector or search by the vector ID.</li><li>Vald Ingress will forward the request to the Vald LB Gateway to process the request.</li><li>Vald LB Gateway will forward the request to all Vald Agents in parallel. Each Vald Agent will search the <em>k</em> nearest neighbor vectors in an on memory graph index.</li><li>Vald Agent returns the searching result to the Vald LB Gateway. The searching result includes the UUID, the vector distance, and the vector. The number of the result will be the same as requested.</li><li>Vald LB Gateway will aggregate all searching results from all Vald Agents, and rank the result by the vector distance.</li><li>Vald LB Gateway will return the aggregated searching result to the Vald Ingress.</li><li>Vald Ingress will return the aggregated searching result to the user.</li></ol><h2 id=update>Update</h2><p>Users can update a vector by sending an update request to Vald. Vald will perform delete and insert requests to perform a single update command.</p><img src=/images/v1.4/overview/update_flow_v2.svg><p>When the user updates a vector from Vald:</p><ol><li>Vald Ingress receives the request from the user. The request includes the existing vector ID(s) and the new vector(s) to be updated.</li><li>Vald Ingress will forward the request to the Vald LB Gateway to process the request.</li><li>Vald LB Gateway will generate the UUID(s), and broadcast the delete request with the generated UUID(s) to the Vald Agents. Each Vald Agent will delete the vector data and the metadata if the corresponding UUID(s) is found in the in-memory graph index.</li><li>Each Vald Agent will return success to the Vald LB Gateway if completed to delete the requested data successfully.</li><li>The insertion step will start after the deletion steps. It is the same as insert flow, please refer <a href=#insert>here</a>.</li><li>If Vald Agent successfully inserts the request data, it will return success (e.g. IP address of pod) to the Vald LB Gateway.</li><li>Vald LB Gateway will return success to the Vald Ingress.</li><li>Vald Ingress will return success to the user.</li></ol><h2 id=upsert>Upsert</h2><p>Upsert request updates the existing vector if the same vector ID exists, or inserts the vector into Vald.</p><img src=/images/v1.4/overview/upsert_flow_v2.svg><p>When the user upserts a vector to Vald:</p><ol><li>Vald Ingress receives the request from the user. The request includes the vector ID(s) and the vector(s).</li><li>Vald Ingress will forward the request to the Vald LB Gateway to process the request.</li><li>Vald LB Gateway will broadcast an existing check request to Vald Agent(s) to check if the vector exists.</li><li>Vald Agent returns the existing check result to Vald LB Gateway.</li><li>If the vector with the same vector ID exists, Vald LB Gateway will send an update request to Vald Agent(s) same as the <a href=#update>update flow</a> step 3 to step 5. If the vector does not exist, Vald LB Gateway will process the <a href=#insert>insert flow</a> from step 3 to step 4.</li><li>Vald Agent(s) return success to Vald LB Gateway.</li><li>Vald Filter Gateway will return success to the Vald Ingress.</li><li>Vald Ingress will return success to the user.</li></ol><h2 id=delete>Delete</h2><p>Delete request will delete the vector in Vald cluster. Vald will broadcast the delete request to all Vald Agents to delete the vector inside the cluster. To make the delete command effective, the <code>CreateIndex</code> command is required by the Vald Index Manager or Vald Agent itself to update the vector index.</p><img src=/images/v1.4/overview/delete_flow_v2.svg><p>When the user deletes a vector that is indexed in Vald Agent:</p><ol><li>Vald Ingress receives the delete request from the user. The request includes the vector ID(s), which is specified by the user.</li><li>Vald Ingress will forward the request to the Vald LB Gateway.</li><li>Vald LB Gateway will broadcast the delete request with UUID(s) to the Vald Agents. Each Vald Agent will delete the vector data and the metadata if the corresponding UUID(s) is found in the in-memory graph index.</li><li>If Vald Agent successfully deletes the request data, it will return success to the Vald LB Gateway.</li><li>Vald LB Gateway will return success to the Vald Ingress.</li><li>Vald Ingress will return success to the user.</li></ol></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#insert>Insert</a></li><li><a href=#search>Search</a></li><li><a href=#update>Update</a></li><li><a href=#upsert>Upsert</a></li><li><a href=#delete>Delete</a></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.4/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.4/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.4/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.4 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>Â©2019-2022 vald.vdaas.org Vald team</p></footer></body></html>