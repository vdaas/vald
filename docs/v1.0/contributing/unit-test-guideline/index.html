<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Unit Test Guideline</title>
<meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Unit Test Guideline"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.0/contributing/unit-test-guideline/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt>
</picture></a><a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.0/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.0/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.0/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.0 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.0</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.9</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.0/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.0/overview/architecture/>Architecture</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.0/overview/component/>Component</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.0/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/v1.0/tutorial/agent-on-docker/>Agent on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.0/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.0/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/v1.0/user-guides/operations/>Operations</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.0/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/v1.0/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.0/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.0/contributing/coding-style/>Coding Style</a></li><li class=view><a href=/docs/v1.0/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.0/support/contacts/>Contacts</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/v1.0/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=unit-test-guideline>Unit Test Guideline</h1><h2 id=about>About</h2><p>The goal of the unit test is to check whether the unit is implemented correctly in various cases.
A good unit test is to check various cases even which we do not expect as supposed usage.
When we create the unit test for each function or package, we have to consider test coverage not only code coverage.
This guideline will help you to create good unit tests.</p><h2 id=unit-test>Unit Test</h2><p>Before considering the unit test, we should define what is the unit.
Unit is a set of procedures or functions, in a procedural or functional language.
Also, it is a class and its needed classes, in an object or object-oriented language.
Unit testing validates the basic units of the program in isolation.</p><h2 id=guideline>Guideline</h2><h3 id=strategy>Strategy</h3><p>Before creating the unit tests, we must know the essentials of strategy.</p><ol><li>Know what you are testing<ul><li>Purpose/Consumers of target function or classes or etc / designed by contract defensive program.</li></ul></li><li>Test behaviors and results, not implementation<ul><li>ensures that tests only fail when there is an actual effect and not due to internal changes.</li></ul></li><li>Test one thing at a time<ul><li>Each test should have a clear, concise, singular objective.</li></ul></li><li>Make tests readable and understandable<ul><li>Hold test code to a similar standard as production code.</li></ul></li><li>Make tests deterministic<ul><li>A test should pass all the time or fail all the time until fixed.</li></ul></li><li>Make tests independent and self-sufficient<ul><li>Setup, execution, and verification steps in a given test should not depend on running other tests before it. To keep unit tests simple, fast running, and easy to debug, it may be necessary to isolate the class under test.</li></ul></li><li>Repeat yourself when necessary<ul><li>It is okay to violate the &lsquo;do not repeat yourself&rsquo; principle if it makes tests simpler and easier to read.</li></ul></li><li>Measure code coverage but focus on test coverage<ul><li>Do not simply to archive code coverage.</li></ul></li></ol><h3 id=test-case>Test case</h3><h4 id=basic>Basic</h4><p>It is not perfect to improve test coverage, but we should try to cover all codes at first.
To cover all code, the basic way is to create test cases to complete all branches in the target unit.</p><p>Let&rsquo;s see the below function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>calcSum</span>(<span style=color:#a6e22e>val</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>sum</span> <span style=color:#66d9ef>int32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>val</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>val</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sum</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When the above function is given, we should create 2 tests to achieving 100% code coverage at least.</p><ul><li>When val is not given<ul><li>In other words, the default value is given</li></ul></li><li>When val(int32) is given<ul><li><code>var val int32 = 1</code></li></ul></li></ul><p>It seems enough for the given function, but we have to take care of some test cases that are remaining for improving test coverage.
In this case, there is at least one more test case to complete test coverage.</p><ul><li>When val([]int32) is given<ul><li><code>var val []int32 = {1, 2}</code></li><li><code>var val []int32 = {math.MaxInt32, -1}</code></li><li><code>var val []int32 = {math.MaxInt32, 0}</code></li><li><code>var val []int32 = {math.MaxInt32, 1}</code></li><li><code>var val []int32 = {math.MinInt32, -1}</code></li><li><code>var val []int32 = {math.MinInt32, 0}</code></li><li><code>var val []int32 = {math.MinInt32, -1}</code></li><li><code>var val []int32 = {math.MaxInt32, math.MaxInt32}</code></li><li><code>var val []int32 = {math.MinInt32, math.MinInt32}</code></li></ul></li></ul><p>That is the focus on test coverage.</p><p>Therefore, we should consider all cases to improve test coverage for the target unit.
To improve test coverage, the basic but critical thinking way is thinking about input patterns.
It is not only a single input, but also multi inputs.</p><p>If a function or method accept multiple inputs, we should try to create test cases to cover all the inputs.</p><p>(Note: The below <code>calcSum()</code> is diffrent function from <code>calsSum(val ...int32)</code> which we mention before.)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>calcAverageDiff</span>(<span style=color:#a6e22e>val1</span> []<span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>val2</span> []<span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>diff</span> <span style=color:#66d9ef>float64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ave1</span>, <span style=color:#a6e22e>ave2</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>val1</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>val2</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>val1</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ave1</span> = float64(<span style=color:#a6e22e>calcSum</span>(<span style=color:#a6e22e>val1</span>)) <span style=color:#f92672>/</span> float64(len(<span style=color:#a6e22e>val1</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>val2</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ave2</span> = float64(<span style=color:#a6e22e>calcSum</span>(<span style=color:#a6e22e>val2</span>)) <span style=color:#f92672>/</span> float64(len(<span style=color:#a6e22e>val2</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>diff</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Abs</span>(<span style=color:#a6e22e>ave1</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>ave2</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When <code>calcAverageDiff()</code> is given, the test patterns are below:</p><table><thead><tr><th style=text-align:center>len(val1)</th><th style=text-align:center>len(val2)</th><th style=text-align:center>option</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>>0</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>>0</td><td style=text-align:center>0</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>>0</td><td style=text-align:center>>0</td><td style=text-align:center>ave1 > ave2</td></tr><tr><td style=text-align:center>>0</td><td style=text-align:center>>0</td><td style=text-align:center>ave1 &lt; ave2</td></tr><tr><td style=text-align:center>>0</td><td style=text-align:center>>0</td><td style=text-align:center>ave1 = ave2</td></tr><tr><td style=text-align:center>>0</td><td style=text-align:center>>0</td><td style=text-align:center>ave1 = {math.MinInt32}, ave2 = {math.MaxInt32}</td></tr><tr><td style=text-align:center>>0</td><td style=text-align:center>>0</td><td style=text-align:center>ave1 = {math.MaxInt32, math.MaxInt32}, ave2 = {0}</td></tr></tbody></table><p>At a glance, one of the last 2 patterns is enough, but these will help us to notice the bug in dependency.
It will avoid the unexpected error due to update dependencies.</p><p>You have to create unit tests for error patterns as the same as success patterns.</p><h4 id=advanced>Advanced</h4><h5 id=robust-boudary-test>Robust boudary test</h5><p>The previous section is about the basic test cases.
To cover more test coverage, the (robust) boundary test should be applied.
A boundary test is testing values on or near the boundaries of allowed inputs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AgeTest</span>(<span style=color:#a6e22e>val</span> <span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>20</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>val</span> &lt; <span style=color:#ae81ff>65</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ok</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When the above function is given as target, the minimum number of tests based on the &ldquo;Robust Boundary&rdquo; test is 7.</p><ul><li>the input <code>val</code> cases: 19, 20, 21, 30, 64, 65, 66</li></ul><p>The robust boundary test requires 6N+1 test cases (N is the number of inputs for target function).
Increasing the input arguments will also increase the number of required test cases.
Sometimes, it requires a lot of resources to create/maintain test.
So, you may test the critical cases using boundary value and have a sense of purpose.</p><h4 id=equivalence-class-testing>Equivalence Class Testing</h4><p>Equivalence Class Testing is grouping the values together such that all members of the group are considered the same and testing one value from each.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AgeTest</span>(<span style=color:#a6e22e>val</span> <span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>20</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>val</span> &lt; <span style=color:#ae81ff>65</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ok</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When the above function is given as target, you have to create 3 groups and pick one value from each group.</p><table><thead><tr><th style=text-align:center>Desc</th><th style=text-align:center>Input range</th><th style=text-align:center>Chose Input</th></tr></thead><tbody><tr><td style=text-align:center>Under 20</td><td style=text-align:center>{0, &mldr;, 19 }</td><td style=text-align:center>5</td></tr><tr><td style=text-align:center>worker range</td><td style=text-align:center>{20, &mldr;, 64}</td><td style=text-align:center>29</td></tr><tr><td style=text-align:center>Senior</td><td style=text-align:center>{65, &mldr; }</td><td style=text-align:center>72</td></tr></tbody></table><h3 id=vald-style>Vald Style</h3><p>In the Vald, we create unit tests based on the basic test case.
And, you may also create unit tests based on robust boundary tests or equivalence class tests if needed.</p><p>But, we have to take care about that the Vald is developed using Go.
As you know as Go has many coding features as other languages.
One of the features is the Go will convert a single value to a slice value when the Function or Method receives variadic argument (e.g. <code>...[]int</code>, <code>...[]string</code>, <code>...interface{}</code>, or etc) as the input.</p><p>And we apply the table-driven test for running unit tests.
For example, when we create the unit test of <code>func getMeta(...[]int)</code>, the test code will be more complex than other functions&rsquo; test which don&rsquo;t use variadic argument as the input if we create the test for all input patterns.
Considering those, we define the basic unit case which is a little diffrent from <a href=#basic>the basic test case</a>.</p><p>This change is very clear and you can apply it easily.
Our basic test case depends on the type of 2 variadic argument.</p><ol><li>When input is <code>...interface{}</code><ul><li>we have to write all test cases which satisfies <code>...interface{}</code> as same as <a href=#basic>basic test case</a>. for example, <code>val = 1</code>, <code>val = "input"</code>, <code>val = []float64{2020.12}</code> and so on.</li></ul></li><li>When input is not <code>...interface{}</code> but <code>...[]int</code>, <code>...[]string</code> or etc<ul><li>we have to create only slice pattern test cases, which is the same as not create test cases with a single vale.</li><li>we should test with boundary cases, for example, we should test with <code>val = []int{math.MaxInt64()}</code> when the input value is <code>...[]int</code>.</li></ul></li></ol><p>Summarize Vald unit test guideline:</p><ul><li>apply basic test case, but take care of input variable pattern, in particular, the variadic argument (<code>...interface{}</code> or not)</li><li>apply robust boundary tests including edge cases (e.g. <code>math.MaxInt64()</code>)</li><li>apply equivalence class testing when needed.</li></ul><h2 id=coding-style>Coding Style</h2><p>Please refer <a href=/docs/v1.0/contributing/coding-style#test>here</a></p></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#about>About</a></li><li><a href=#unit-test>Unit Test</a></li><li><a href=#guideline>Guideline</a><ul><li><a href=#strategy>Strategy</a></li><li><a href=#test-case>Test case</a></li><li><a href=#vald-style>Vald Style</a></li></ul></li><li><a href=#coding-style>Coding Style</a></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.0/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.0/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.0/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.0 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>Â©2019-2021 vald.vdaas.org Vald team</p></footer></body></html>