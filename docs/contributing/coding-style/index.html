<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164223416-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-164223416-1")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Coding Style</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Coding Style"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/contributing/coding-style/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.6.1</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.6.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/overview/component/lb-gateway/>Lb Gateway</a></li><li class=index><a href=/docs/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/user-guides/client-api-config/>Client Api Config</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/api/insert/>Insert</a></li><li class=index><a href=/docs/api/update/>Update</a></li><li class=index><a href=/docs/api/upsert/>Upsert</a></li><li class=index><a href=/docs/api/search/>Search</a></li><li class=index><a href=/docs/api/remove/>Remove</a></li><li class=index><a href=/docs/api/object/>Object</a></li><li class=index><a href=/docs/api/build_proto/>Build Proto</a></li><li class=index><a href=/docs/api/status/>Status Code</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/contributing/contributing-guide/>Contributing Guide</a></li><li class=view><a href=/docs/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/support/contacts/>Contacts</a></li><li class=index><a href=/docs/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=go-style-guide-in-vald>Go Style Guide in Vald</h1><h2 id=introduction>Introduction</h2><p>This guideline includes the coding style for all Vald contributors and reviewers.
Everyone should follow this guideline to keep the style consistent, so everyone can understand and contribute to Vald easier once they learn it.
You should have the basic knowledge of how to write Go before contributing to Vald.
If you find any bugs, please create <a href="https://github.com/vdaas/vald/issues/new?assignees=&labels=type%2Fbug%2C+priority%2Fmedium%2C+team%2Fcore&template=bug_report&title=">a GitHub issue</a>, and we will work on it.</p><p>Please also read the <a href=/docs/contributing/contributing-guide>Contribution guideline</a> before you start contributing to Vald.</p><h2 id=code-formatting-and-naming-convention>Code Formatting and Naming Convention</h2><p>Code formatting and naming conventions affect coding readability and maintainability.
Every developer has a different coding style.
Luckily Go provides tools to format source code and check for potential issues in the source code.
We recommend using <a href=https://github.com/segmentio/golines>golines</a>, <a href=https://github.com/mvdan/gofumpt>gofumpt</a>, and <a href=https://github.com/golang/tools/tree/master/cmd/goimports>goimports</a> to format the source code in Vald and <a href=https://github.com/golangci/golangci-lint>golangci-lint</a> with the <code>--enable-all</code> option.
We suggest everyone install the plugin for your editor to format the code once you edit the code automatically and use <code>make format/go</code> command if you want to format the source code manually.</p><p>But having tools to format source code does not mean you do not need to care about the formatting of the code, for example:</p><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>badStr</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;apiVersion: v1\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;kind: Service\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;metadata:\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;  name: grafana\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;spec:\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;  ports:\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;    - name: grafana\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;      port: 3000\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;      targetPort: 3000\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;      protocol: TCP\n&#34;</span>
</span></span></code></pre></div></td><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>goodStr</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: grafana
</span></span></span><span style=display:flex><span><span style=color:#e6db74>spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ports:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - name: grafana
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>
</span></span></code></pre></div></td></tr></tbody></table><h3 id=project-layout>Project Layout</h3><p>The project layout includes the folder and the file structure in the project. We follow the <a href=https://github.com/golang-standards/project-layout>project-layout</a> example in Vald.</p><h3 id=packages>Packages</h3><p>The package defines the context of the objects in the package; for example, the corresponding methods and structs belong to the corresponding package.
Unlike other languages like Java, in Go, we use the package name to declare which context of the object we are going to use.
For example, the <a href=https://golang.org/pkg/time/>time package</a> defines all the objects about time, like <code>time.Now()</code> method to get the current time.</p><p>Here are the naming conventions of the package:</p><ul><li><p>All lower case.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>ioUtil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>ioutil</span>
</span></span></code></pre></div></li><li><p>No plurals.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>times</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>time</span>
</span></span></code></pre></div></li><li><p>Should be the same as the folder name.</p></li><li><p>Should keep as simple as it should and contain only one specific context in the package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>encodebase64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>base64</span> <span style=color:#75715e>// inside the encoding/base64 folder
</span></span></span></code></pre></div></li><li><p>Should not be too general, for example, <code>util</code> or <code>helper</code>, which will cause all the objects from different contexts to be stored in one package.
If you want to name the package as <code>util</code>, please define the more specific package name more <code>ioutil</code> or <code>httputil</code>.</p></li></ul><p>All packages should contain a <code>doc.go</code> file under the package to describe what is the package is. For example, under the folder name called <code>cache</code>, should contain a file named <code>doc.go</code>, which contains the package documentation. Here is the example <code>doc.go</code> of the cache package.</p><pre><code>```go
// Package cache provides an implementation of cache
package cache
````
</code></pre><h3 id=general-style>General style</h3><p>This section describes the general guideline for the Vald programming style, every Vald contributor should keep these general guidelines in mind while working on the implementation of Vald.</p><h4 id=order-of-declaration>Order of declaration</h4><p>Put the higher priority or frequently used declaration on top of other declarations.
It makes it easier for Vald to read and search its target source code in Vald.</p><p>For example, the interface declaration should have higher priority than the struct or function declaration; hence it should be put above other declarations.</p><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>S</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>S</span>) <span style=color:#a6e22e>fn</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>I</span> <span style=color:#66d9ef>interface</span> {}
</span></span></code></pre></div></td><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>I</span> <span style=color:#66d9ef>interface</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>S</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>S</span>) <span style=color:#a6e22e>fn</span>() {}
</span></span></code></pre></div></td></tr></tbody></table><h4 id=group-similar-definition>Group similar definition</h4><p>Group similar definitions such as a struct or an interface declaration.
We should not group an interface and a struct declaration in the same block, for example:</p><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>I</span> <span style=color:#66d9ef>interface</span> {}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>I2</span> <span style=color:#66d9ef>interface</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s2</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>)
</span></span></code></pre></div></td><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>I</span> <span style=color:#66d9ef>interface</span> {}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>I2</span> <span style=color:#66d9ef>interface</span> {}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s2</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span>)
</span></span></code></pre></div></td></tr></tbody></table><h3 id=interfaces>Interfaces</h3><p>The interface defines the program interface for usability and future extendability.
Unlike other languages like Java, Go supports implicit interface implementation.
The type implements do not need to specify the interface name; to &ldquo;implement&rdquo; the interface, the structs only need to define the methods the same as the interface, so please be careful to define the method name inside the interface.</p><p>The interface should be named as:</p><ul><li><p>Use MixedCaps</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Roundtripper</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// interface definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RoundTripper</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// interface definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></li><li><p>Use understandable common short form.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ATSigner</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// interface definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AccessTokenSigner</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// interface definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HTTPServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// interface definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></li></ul><h3 id=structs>Structs</h3><p>Structs in Go is the object definition; we can attach any fields and methods to the struct. The naming convention is the same as the interface one.
If the structs are implementing the interface, the structs name should be related to the interface, for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Listener</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// interface definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Listener instance for file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileListener</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// implement listener interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Listener instance for HTTP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HTTPListener</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// implement listener interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h4 id=struct-initialization>Struct initialization</h4><p>There are many ways to initialize structs in Go; based on the use case, we can decide which way to initialize structs in Go.
To initialize struct, it is suggested to use <code>new(T)</code> instead of <code>&T{}</code> unless you need to initialize with values. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Something</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>Something</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>Something</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;Mary&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// use this syntax instead of b
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Something</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;Mary&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To initialize complex structs, we can use a <a href=https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis>functional option pattern</a>. Please read <a href=https://github.com/vdaas/vald/blob/main/internal/servers/servers.go>server.go</a> and <a href=https://github.com/vdaas/vald/blob/main/internal/servers/option.go>option.go</a> for the reference implementation.
The options implementation should be separated as another file called <code>option.go</code> to improve the readability of the source code, and the method name should start with <code>With</code> word to differentiate it from other methods.</p><h3 id=variables-and-constant>Variables and Constant</h3><p>The variable and the constant should be named as:</p><ul><li><p>Use MixedCaps</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>yamlprocessor</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>something</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>yamlProcessor</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>something</span>)
</span></span></code></pre></div></li><li><p>Use short form.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>yamlString</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;something&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>yamlStr</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;something&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// in some case it is acceptable and actually if it is easier to read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>something</span>)
</span></span></code></pre></div></li></ul><p>The variable and the constant name may lead to misunderstanding or confusion, so if the variable and constant name are different to understand, please write some comments, even if it is a private member.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// somebody may not understand this variable, so write a simple comment to the variable definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>sac</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>something</span>) <span style=color:#75715e>// signed access token
</span></span></span></code></pre></div><p>If the multiple variables and the constants have the same grouping, please use the grouping name as the prefix of the variable and constant name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Same group of variable (error), so add a prefix `Err` to each error variables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ErrInvalidCacherType</span> = <span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;invalid cacher type&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// ErrXXXXXXX
</span></span></span></code></pre></div><h3 id=methods>Methods</h3><p>In this section, rules also apply to the <code>function</code> (without receiver). The method name should be named as:</p><ul><li><p>Use MixedCaps.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>somemethod</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>some_method</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>someMethod</span>() {}
</span></span></code></pre></div></li><li><p>Avoid using long function name.</p></li><li><p>Do not use short form unless the function name is too long.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// bad
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>genereateRandomNumber</span>() <span style=color:#66d9ef>int</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// good
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>genRandNum</span>() <span style=color:#66d9ef>int</span> {}
</span></span></code></pre></div></li><li><p>It should be understandable for everyone even if it is a private method.</p></li></ul><h4 id=getter-and-setter>Getter and Setter</h4><p>The Getter and Setter are almost the same as other languages, but the naming convention of the Getter method is different from other languages. Instead of <code>GetVar1()</code>, the getter of <code>Var1</code> should be the same as the variable named <code>Var1()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// getter of the `signedTok`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>SignedTok</span>() <span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>signedTok</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// setter of the `signedTok`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>something</span>) <span style=color:#a6e22e>SetSignedTok</span>(<span style=color:#a6e22e>st</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>signedTok</span> = <span style=color:#a6e22e>st</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=unused-variables>Unused Variables</h3><p>An unused variable may increase the complexity of the source code.
It may confuse the developer hence introducing a new bug.
So please delete the unused variable.</p><p>Generally, the unused variable should be reported during compilation, but in some cases, the compiler may not report an error.
This is an example of an unused variable declaration that does not cause a compilation error.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// In this case, this example are not using `port` field, but dose not cause a compilation error.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// So please delete `port` field of `server`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>int</span>  <span style=color:#75715e>// you have to delete this field.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The `port` field of `server` is not used.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addr</span>: <span style=color:#e6db74>&#34;192.168.33.10:1234&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Run</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=error-handling>Error handling</h3><p>All errors should define in <a href=https://github.com/vdaas/vald/blob/main/internal/errors>internal/errors package</a>. All errors should be start with <code>Err</code> prefix, and all errors should be handle if possible.</p><p>Please use <a href=https://github.com/vdaas/vald/blob/main/internal/errgroup>internal/errgroup</a> for synchronized error handling on multi-goroutine processing.</p><h3 id=error-checking>Error checking</h3><p>All functions return an <code>error</code> if the function can fail.
It is very important to ensure that error checking is performed.
To reduce human mistakes that miss the error checking, please check the error using the following style:</p><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// handle error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></td><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// handle error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></td></tr></tbody></table><p>If you need the value outside the if statement, please use the following style:</p><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#e6db74>&#34;localhost:80&#34;</span>);  <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// handle error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// use the conn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></td><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#e6db74>&#34;localhost:80&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// handle error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// use the conn
</span></span></span></code></pre></div></td></tr></tbody></table><h3 id=logging>Logging</h3><p>We define our own logging interface in <a href=https://github.com/vdaas/vald/blob/main/internal/log>internal/log package</a>.
By default, we use <a href=https://github.com/kpango/glg>glg</a> to do the logging internally.
We defined the following logging levels.</p><table><thead><tr><th>Log level</th><th>Description</th><th>Example situation</th><th>Example message</th></tr></thead><tbody><tr><td>DEBUG</td><td>Fine-grained information for debugging and diagnosing the application.<br>Enabling this logging level in the production environment may cause performance issues.</td><td>An entry that will insert into the database with details.<br>An HTTP request and response will send and receive from the server with details.</td><td>User 1 will insert into the database, name: Mary, Age: 19.<br>An HTTP request will send to <a href=http://example.com>http://example.com</a>, with the body:<br>key1:value1, key2:value2.<br>The response of the HTTP request: body: HTTPResponseBody</td></tr><tr><td>INFO</td><td>Normal application behavior to trace what is happening inside the application.</td><td>Inserted entry into the database without details.<br>HTTP requests are sent to the server without details.<br>The server is started or stopped.</td><td>User 1 is inserted into the database.<br>The HTTP request is sent to XXX server successfully.</td></tr><tr><td>WARN</td><td>The message that indicates the application may have an issue or occurring unusual situation,<br>but does not affect the application behavior.<br>Someone should investigate the warning later.</td><td>Failed to insert an entry into the database, but successful with the retry.<br>Failed to update the cache, and the cache is not important.</td><td>User 1 is successfully inserted into the database with retry,<br>retry count: 1, error: ErrMsg1, retry count: 2, error: ErrMsg2</td></tr><tr><td>ERROR</td><td>The message indicates the application has a serious issue or,<br>represents the failure of some important thing going on in the application.<br>It does not cause the application to go down.<br>Someone must investigate the error later.</td><td>Failed to insert an entry into the database, with retry count exceeded.<br>Failed to update the cache, and the cache is not important.</td><td>User 1 is failed to insert in the database with errors:<br>retry count: 1, error: ErrMsg1, retry count: 2, error: ErrMsg2, &mldr;.</td></tr><tr><td>FATAL</td><td>The message indicates the application is corrupting or has a serious issue.<br>The application will go down after logging the fatal error.<br>Someone must investigate and resolve the fatality as soon as possible.</td><td>Failed to init the required cache during the application start.</td><td></td></tr></tbody></table><h2 id=implementation>Implementation</h2><p>This section includes some examples of general implementation widely used in Vald.
The implementation may differ based on your use case.</p><h3 id=functional-option>Functional Option</h3><p>The functional option pattern is widely used in Vald.
You can refer to <a href=#struct-initialization>this section</a> for more details of the use case of this pattern.</p><p>We provide the following errors to describe the error to apply the option.</p><table><thead><tr><th>Error</th><th>Description</th></tr></thead><tbody><tr><td>errors.ErrInvalidOption</td><td>Error to apply the option, and the error is ignorable and the warning log will be printed</td></tr><tr><td>errors.ErrCriticalOption</td><td>Critical error to apply the option, the error cannot be ignored and should be handled</td></tr><tr><td>errors.ErrIgnoredOption</td><td>The option is ignored, and the debug log will be printed</td></tr></tbody></table><p>We strongly recommend the following implementation to set the value using the functional option.</p><p>If an invalid value is set to the functional option, the <code>ErrInvalidOption</code> error defined in the <a href=https://github.com/vdaas/vald/blob/main/internal/errors/option.go>internal/errors/option.go</a> should be returned.</p><p>The name argument (the first argument) of the <code>ErrInvalidOption</code> error should be the same as the functional option name without the <code>With</code> prefix.</p><p>For example, the functional option name <code>WithVersion</code> should return the error with the argument <code>name</code> as <code>version</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithVersion</span>(<span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>Option</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>client</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>version</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrInvalidOption</span>(<span style=color:#e6db74>&#34;version&#34;</span>, <span style=color:#a6e22e>version</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>version</span> = <span style=color:#a6e22e>version</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We recommend the following implementation to parse the time string and set the time to the target struct.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>dur</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>Option</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>client</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dur</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrInvalidOption</span>(<span style=color:#e6db74>&#34;timeout&#34;</span>, <span style=color:#a6e22e>dur</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>timeutil</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>dur</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrInvalidOption</span>(<span style=color:#e6db74>&#34;timeout&#34;</span>, <span style=color:#a6e22e>dur</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timeout</span> = <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We recommend the following implementation to append the value to the slice if the value is not nil.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithHosts</span>(<span style=color:#a6e22e>hosts</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>Option</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>client</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>hosts</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrInvalidOption</span>(<span style=color:#e6db74>&#34;hosts&#34;</span>, <span style=color:#a6e22e>hosts</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>hosts</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>hosts</span> = <span style=color:#a6e22e>hosts</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>hosts</span> = append(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>hosts</span>, <span style=color:#a6e22e>hosts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If the functional option error is critical, we should return <code>ErrCriticalOption</code> error instead of <code>ErrInvalidOption</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithConnectTimeout</span>(<span style=color:#a6e22e>dur</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>Option</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>client</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dur</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrInvalidOption</span>(<span style=color:#e6db74>&#34;connectTimeout&#34;</span>, <span style=color:#a6e22e>dur</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>timeutil</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>dur</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrCriticalOption</span>(<span style=color:#e6db74>&#34;connectTimeout&#34;</span>, <span style=color:#a6e22e>dur</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>connectTimeout</span> = <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We need to handle the error returned from the functional option on the caller side.</p><p>If the option fails to apply, an error wrapped with <code>ErrOptionFailed</code> defined in the <a href=https://github.com/vdaas/vald/blob/main/internal/errors/errors.go>internal/errors/errors.go</a> should be returned.</p><p>We recommend the following implementation to apply the options.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Option</span>) (<span style=color:#a6e22e>Server</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>opt</span>(<span style=color:#a6e22e>srv</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>werr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrOptionFailed</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>opt</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrCriticalOption</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>werr</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>werr</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#a6e22e>werr</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=constructor>Constructor</h3><p>In Vald, the functional option pattern is widely used when we create an object.</p><p>When setting the value with the functional option, the value is validated inside the option method.</p><p>However, we may forget to set the required fields when creating the object; hence the target object will remain nil.
Therefore, we strongly suggest validating the object during initialization.</p><p>If we forget to set the options method, an error will be returned so we can handle it properly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>Option</span>) (<span style=color:#a6e22e>Server</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> append(<span style=color:#a6e22e>defaultOptions</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>opt</span>(<span style=color:#a6e22e>srv</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>werr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrOptionFailed</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>opt</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrCriticalOption</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>werr</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>werr</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ue</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrIgnoredOption</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ue</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Debug</span>(<span style=color:#a6e22e>werr</span>)
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#a6e22e>werr</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>eg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrInvalidOption</span>(<span style=color:#e6db74>&#34;eg&#34;</span>, <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>eg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>srv</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We also recommend that you use the default options and the unexported functional option to set the objects so that we cannot use them externally.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultOptions</span> = []<span style=color:#a6e22e>Option</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>server</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ctxio</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=program-comments>Program comments</h2><p>Program comments make it easier to understand the source code.
We suggest not writing many comments inside the source code unless the source code is very complicated and confusing; otherwise, we should divide the source code into methods to keep readability and usability of the source code.</p><p>Everyone should comment on all the public objects on your source code, like public packages, interfaces, structs, methods, and even public constants and variables.
The <code>Godoc</code> will be generated based on the comment of the source code.</p><h2 id=documentation>Documentation</h2><p>Documentation is generated from the program comments. Please refer to <a href=https://pkg.go.dev/github.com/vdaas/vald>Godoc</a> for the program documentation.</p><h2 id=internal-packages>Internal packages</h2><p>Vald implements its internal package to extend and customize the standard library and third-party library functionality.
We should use the internal package instead of the standard library to implement Vald.
Please refer to <a href=https://pkg.go.dev/github.com/vdaas/vald/internal>Godoc</a> for the internal package document.</p><h2 id=dependency-management-and-build>Dependency management and Build</h2><p>We should use <code>go mod tidy</code> to manage the <code>go.mod</code> file in the project.</p><h2 id=test>Test</h2><p>The testing guideline has three essential rules for coding quality and readability:</p><ol><li>Use Table-Driven-Test</li><li>Keep code coverage over 85%<ul><li>test coverage != high testing quality, but low coverage means bad testing quality</li><li>check with the following commands <code>go test -cover ./...</code></li></ul></li><li>Test all use cases and error cases</li></ol><h3 id=table-driven-test>Table-Driven-Test</h3><p>Use table-driven tests with subtests to avoid duplicating code.</p><table><thead><tr><th>Bad</th><th>Good</th></tr></thead><tbody><tr><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>SplitHostPort</span>(<span style=color:#e6db74>&#34;192.0.2.0:8000&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error is not nil: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;192.0.2.0&#34;</span>, <span style=color:#a6e22e>host</span>; <span style=color:#a6e22e>want</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>got</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;host is not equals. want: %s, but got: %s&#34;</span>, <span style=color:#a6e22e>want</span>: <span style=color:#f92672>%</span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;8000&#34;</span>, <span style=color:#a6e22e>port</span>; <span style=color:#a6e22e>want</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>got</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;port is not equals. want: %s, but got: %s&#34;</span>, <span style=color:#a6e22e>want</span>: <span style=color:#f92672>%</span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#a6e22e>case2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>SplitHostPort</span>(<span style=color:#e6db74>&#34;192.0.2.0:http&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error is not nil: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;192.0.2.0&#34;</span>, <span style=color:#a6e22e>host</span>; <span style=color:#a6e22e>want</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>got</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;host is not equals. want: %s, but got: %s&#34;</span>, <span style=color:#a6e22e>want</span>: <span style=color:#f92672>%</span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;http&#34;</span>, <span style=color:#a6e22e>port</span>; <span style=color:#a6e22e>want</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>got</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;port is not equals. want: %s, but got: %s&#34;</span>, <span style=color:#a6e22e>want</span>: <span style=color:#f92672>%</span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></td><td><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>str</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wantHost</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wantPort</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>} {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>str</span>: <span style=color:#e6db74>&#34;192.0.2.0:8000&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wantHost</span>: <span style=color:#e6db74>&#34;192.0.2.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wantPort</span>: <span style=color:#e6db74>&#34;8000&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>str</span>: <span style=color:#e6db74>&#34;192.0.2.0:8000&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wantHost</span>: <span style=color:#e6db74>&#34;192.0.2.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wantPort</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>str</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>SplitHostPort</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error is not nil: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantHost</span>, <span style=color:#a6e22e>host</span>; <span style=color:#a6e22e>want</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>got</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;host is not equals. want: %s, but got: %s&#34;</span>, <span style=color:#a6e22e>want</span>: <span style=color:#f92672>%</span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>got</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantPort</span>, <span style=color:#a6e22e>port</span>; <span style=color:#a6e22e>want</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>got</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;port is not equals. want: %s, but got: %s&#34;</span>, <span style=color:#a6e22e>want</span>: <span style=color:#f92672>%</span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>got</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></td></tr></tbody></table><p>Table-Driven-Test makes it easy to add a new test case.</p><p>We define the test case table as <code>map[string]func(*testing.T)test</code>, which is referred to as the test case name and the test case implementation <code>tt</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) <span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;test case name&#34;</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) <span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>args</span>: <span style=color:#a6e22e>args</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>host</span>: <span style=color:#e6db74>&#34;host&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>port</span>: <span style=color:#e6db74>&#34;port&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>field</span>: <span style=color:#a6e22e>field</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>timeout</span>: <span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=create-a-table-driven-test>Create a Table-Driven-Test</h3><h4 id=structures>Structures</h4><ol><li><p><code>args</code> structure</p><p>If two or more arguments are passed to the method, create an <code>args</code> structure. If there is only one argument, do not create an <code>args</code> structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>args</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><code>field</code> structure</p><p>If you create an object and test its methods, create a <code>field</code> struct if the object has two or more fields to initialize. If there is only one field, do not create a <code>field</code> structure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>field</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><code>test</code> structure</p><p><code>test</code> structure has <code>args</code> and <code>field</code> structure and <code>checkFunc</code> function.
Create a field or an args structure if you need it.
The <code>checkFunc</code> function is used to check the return value of the function being tested.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>test</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>args</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>field</span> <span style=color:#a6e22e>field</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>checkFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h4 id=inputs>Inputs</h4><ol><li><p>test case name</p><p>Test case names should be readable, meaningful, and understandable easily.
If you create a new test, the test name should be named based on the below-naming templates</p><ul><li>Success cases:<ul><li>Start with <code>success</code> or <code>{verb} success</code> or <code>success {verb}</code></li><li>End with the condition <code>when {condition}</code> or `with {condition}</li><li>e.g.: <code>set success when the value is default value</code></li></ul></li><li>Fail/Error cases:<ul><li>Start with <code>fail</code> or <code>{verb} fail</code> or <code>fail {verb}</code></li><li>End with the condition <code>when {condition}</code> or `with {condition}</li><li>e.g.: <code>fail option setting when value is invalid value(string)</code></li></ul></li><li>Return cases:<ul><li>If the test case do not match with <code>Success</code> or <code>Fails</code>, please use <code>Return</code> pattern.</li><li>Start with <code>Returns {Object}</code></li><li>End with the condition <code>when {condition}</code> or `with {condition}</li><li>e.g.: <code>return invalid error when the input is invalid</code></li></ul></li></ul></li><li><p>testing arguments</p><p>Input arguments for testing should be a meaningful value.
We should test with more realistic values to produce a more realistic testing result.</p><p>For example, to test the function with <code>host</code> argument, you should set your hostname (e.g., <code>vald.vdaas.com</code>) as the input value to the <code>host</code> argument.</p></li></ol><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>args</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>field</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>want</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>test</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>       <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span>       <span style=color:#a6e22e>args</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>field</span>      <span style=color:#a6e22e>field</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>want</span>       <span style=color:#a6e22e>want</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>checkFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>defaultCheckFunc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;got error: %v, want: %v&#34;</span>, <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;success send when host and port are correct value&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>args</span>: <span style=color:#a6e22e>args</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>host</span>: <span style=color:#e6db74>&#34;vdaas.vald.org&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>port</span>: <span style=color:#e6db74>&#34;80&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>field</span>: <span style=color:#a6e22e>field</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>host</span>: <span style=color:#e6db74>&#34;vdaas.vald.org&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>port</span>: <span style=color:#e6db74>&#34;80&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>want</span>: <span style=color:#a6e22e>want</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tesint</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>checkFunc</span> = <span style=color:#a6e22e>defaultCheckFunc</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>checkFunc</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>checkFunc</span> = <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>checkFunc</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>timeout</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>txt</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>checkFunc</span>(<span style=color:#a6e22e>err</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error = %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=generate-test-code>Generate test code</h3><p>We implement our own <a href=https://github.com/cweill/gotests>gotests</a> template to generate test code.
If you want to install <code>gotest</code> tools, please execute the following command under the project root directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make gotests/install
</span></span></code></pre></div><p>If you use the following command to generate the missing test code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make gotests/gen
</span></span></code></pre></div><p>After executing the command above, the file <code>*target*_test.go</code> will be generated for each Go source file.
The test code generated follows the table-driven test format.
You can implement your test code under the <code>tests</code> variable generated following the table-driven test format.</p><h3 id=customize-test-case>Customize test case</h3><p>We do not suggest modifying the generated code other than the <code>tests</code> variable
Still, in some cases, you may need to change the generated code to meet your requirement, for example:</p><ol><li><p>init() function</p><p>init() function is executed automatically before the test is started.
You may need to initialize some singleton before running your test cases.
For example, Vald uses <a href=https://github.com/kpango/glg>glg</a> library for logging by default; if the logger is not initialized before the test, the nil pointer error may be thrown during the test is running.
You may need to implement <code>init()</code> function like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Init</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And place it on the header of the test file.</p></li><li><p>goleak option</p><p>The generated test code will default use the <a href=https://github.com/uber-go/goleak>goleak</a> library to test if there is any goroutine leak.
Sometimes you may want to skip the detection; for example, Vald uses the <a href=https://github.com/kpango/fastime>fastime</a> library, but the internal goroutine is not closed due to the needs of the library.
To skip the goleak detection, we need to create the following variable to store the ignore function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e>// goroutine leak is detected by `fastime`, but it should be ignored in the test because it is an external package.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>goleakIgnoreOptions</span> = []<span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>Option</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>IgnoreTopFunction</span>(<span style=color:#e6db74>&#34;github.com/kpango/fastime.(*fastime).StartTimerD.func1&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>And use it in <code>VerifyNone()</code> in the test case.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// modify the following line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>VerifyNone</span>(<span style=color:#a6e22e>tt</span>, <span style=color:#a6e22e>goleakIgnoreOptions</span><span style=color:#f92672>...</span>)
</span></span></code></pre></div><p>In Vald, we implemented <a href=https://github.com/vdaas/vald/blob/main/internal/test/goleak/goleak.go>internal goleak package</a> and wrap the goleak validation logic to ignore the common goleak functions.
In test implementation, we can easily import the internal goleak package and ignore all the necessary goleak functions by default.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// import internal goleak package
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/vdaas/vald/internal/test/goleak&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// use internal goleak to ignore necessary function by default
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>VerifyNone</span>(<span style=color:#a6e22e>tt</span>, <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>IgnoreCurrent</span>())
</span></span></code></pre></div></li><li><p>goleak usage</p><p>There are two methods for valid goroutine leak:</p><ol><li>Use <code>goleak.VerifyNone()</code> to validate it on each test cases.</li><li>Use <code>goleak.VerifyTestMain()</code> to validate it on each package.</li></ol><p>By default, the goroutine leak validation is executed in each test case.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>VerifyNone</span>(<span style=color:#a6e22e>tt</span>, <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>IgnoreCurrent</span>())
</span></span></code></pre></div><p>In some cases, it may not work as some cleanup or asynchronous processes remaining in the background, and validating it on the test case using <code>goleak.VerifyNone()</code> may cause a false alarm.</p><p>To resolve it, we can consider using <code>goleak.VerifyTestMain()</code> to validate goleak when all test cases are passed in each package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// implement TestMain and verify it at package level
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestMain</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>M</span>) {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>VerifyTestMain</span>(<span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>         <span style=color:#75715e>// use VerifyTestMain() above to detect goroutine leak
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#75715e>// defer goleak.VerifyNone(tt, goleak.IgnoreCurrent())
</span></span></span></code></pre></div><p>Please note that the <code>TestMain()</code> can only implement once in each package, you may need to find the right place to implement this function on the package.</p></li><li><p>Defer function</p><p>By default, the template provides <code>beforeFunc()</code> and <code>afterFunc()</code> to initialize and finalize the test case, but in some cases, it may not support your use case.
For example, <code>recover()</code> function only works in <code>defer()</code> function.
If you need to use the <code>recover()</code> function to handle the panic in your test code, you may need to implement your custom <code>defer()</code> function and change the generated test code.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>VerifyNone</span>(<span style=color:#a6e22e>tt</span>, <span style=color:#a6e22e>goleak</span>.<span style=color:#a6e22e>IgnoreCurrent</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>// insert your defer function here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// implement your defer func logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span><span style=color:#f92672>:=</span> recover(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                 <span style=color:#75715e>// check the panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             }
</span></span><span style=display:flex><span>         }(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>want</span>, <span style=color:#a6e22e>tt</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>beforeFunc</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>beforeFunc</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#75715e>// generated test code
</span></span></span></code></pre></div></li><li><p>Unused fields</p><p>By default, the template provides the <code>fields</code> structure to initialize an object of the test target.
But in some cases, not all <code>fields</code> are needed, so please delete the unnecessary fields.
For example, the following struct and the corresponding function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>server</span>) <span style=color:#a6e22e>Addr</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>addr</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the generated test code is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_server_Addr</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>want</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// generated test code
</span></span></span></code></pre></div><p>Since the <code>port</code> variable is not used in this test case, you can delete the <code>port</code> definition in the test case.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_server_Addr</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// port int   &lt;-- this line should be deleted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>want</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// generated test code
</span></span></span></code></pre></div></li><li><p>Context</p><p>If the target function accepts context as an input argument, the test code generated will include it in <code>args</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>args</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>But in test implementation, it is hard to manage the context lifecycle.
We want to guarantee the context is closed after each test is executed to avoid any missing termination of the process.</p><p>In Vald, we suggest customizing the test implementation from the generated test code to create the context and manage the lifecycle in every test.</p><p>We can remove the context from the <code>args</code> struct and create the context in the test execution code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span> <span style=color:#75715e>// we can remove the ctx from args list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>args</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>     <span style=color:#75715e>// ctx context.Context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>         <span style=color:#75715e>// create context here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>         <span style=color:#75715e>// handle the context lifecycle by canceling the context after the test is executed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>// use the context created above
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#a6e22e>got</span>, <span style=color:#a6e22e>gotErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>someFunc</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>...</span>
</span></span></code></pre></div></li><li><p>Struct initialization</p><p>By default, when testing the function of the struct, the target struct initialization is implemented by setting the data from the <code>fields</code> defined in the test case.
This initialization method has a few disadvantages:</p><ol><li>When there are many fields in the struct, it is hard to set them all.</li><li>The default value is the zero value of the type, not the struct default value from the struct initialization function.</li></ol><p>To resolve these problems, we can modify the test implementation to use the struct initialization function instead of setting the struct fields on the test cases.</p><p>For example, the current implementation may look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_server_SaveIndex</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// all the fields to initialize the target struct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>name</span>              <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>ip</span>                <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>ngt</span>               <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>NGT</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>eg</span>                <span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>Group</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>streamConcurrency</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>Parallel</span>()
</span></span><span style=display:flex><span>             <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>// we initialize the target struct using fields defined in test case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>server</span>{
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>name</span>:              <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>ip</span>:                <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>ngt</span>:               <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>ngt</span>,
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>eg</span>:                <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>eg</span>,
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>streamConcurrency</span>: <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>streamConcurrency</span>,
</span></span><span style=display:flex><span>                 <span style=color:#75715e>// we may have more fields defined in the struct, 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                 <span style=color:#75715e>// and we need to set them all here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>gotRes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>SaveIndex</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>in1</span>)
</span></span><span style=display:flex><span>             <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>We can customize the implementation to use the struct initialization function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_server_SaveIndex</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// we customize the fields to initialize the target struct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>fields</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>         <span style=color:#75715e>// options to configure server struct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#a6e22e>srvOpts</span> []<span style=color:#a6e22e>Option</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>// options to configure ngt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#a6e22e>svcCfg</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>NGT</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>svcOpts</span> []<span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Option</span>
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>Parallel</span>()
</span></span><span style=display:flex><span>             <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>// initialize required fields of server struct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#a6e22e>eg</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ngt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>svcCfg</span>, append(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>svcOpts</span>, <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>WithErrGroup</span>(<span style=color:#a6e22e>eg</span>))<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to init ngt service, error = %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>// we use the struct initialization function instead of setting the fields,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#75715e>// by combining the use of the functional option, we can configure the struct,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#75715e>// and the default values of the struct will be set automatically if we are not defining it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>             <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>(append(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>srvOpts</span>, <span style=color:#a6e22e>WithNGT</span>(<span style=color:#a6e22e>ngt</span>), <span style=color:#a6e22e>WithErrGroup</span>(<span style=color:#a6e22e>eg</span>))<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to init server, error= %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>gotRes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>SaveIndex</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>in1</span>)
</span></span><span style=display:flex><span>             <span style=color:#f92672>...</span>
</span></span></code></pre></div></li></ol><h3 id=parallel-test>Parallel test</h3><p>In Vald, we use parallel tests to accelerate the execution of tests by default.
There are two layers of enabling parallel tests.</p><ol><li>Parallel for the test function</li><li>Parallel for the subtests in the test function</li></ol><p>The generated test case will enable these two parallel modes by default. It is implemented by:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_server_CreateIndex</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Parallel</span>() <span style=color:#75715e>// parallel for the test function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>args</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tc</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>tt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>Parallel</span>() <span style=color:#75715e>// parallel for subtests
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Be careful of using the parallel test, avoid using share object used in the test, to avoid race detector to detect the race in test and fail the test.</p><h3 id=helper-function>Helper function</h3><p>In golang testing package, they defined the helper functions in testing types to indicate the current function is a test helper function and skip printing the file and line information to the output.</p><p>In Vald, we can apply it to the different helper functions like <code>beforeFunc()</code> or <code>afterFunc()</code> defined in the test case struct.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>test</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) <span style=color:#75715e>// helper function to initialze testing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>afterFunc</span>  <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) <span style=color:#75715e>// helper function to cleanup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;send success when host and port are correct value&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>args</span>: <span style=color:#a6e22e>args</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>host</span>: <span style=color:#e6db74>&#34;vdaas.vald.org&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>port</span>: <span style=color:#e6db74>&#34;80&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>field</span>: <span style=color:#a6e22e>field</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>host</span>: <span style=color:#e6db74>&#34;vdaas.vald.org&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>port</span>: <span style=color:#e6db74>&#34;80&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>beforeFunc</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>() <span style=color:#75715e>// indicate the current function is helper function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>/* initialization logic of testing environment */</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>want</span>: <span style=color:#a6e22e>want</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>afterFunc</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>() <span style=color:#75715e>// indicate the current function is helper function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>/* cleanup logic */</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=using-mock>Using Mock</h3><p>In Vald, we use a lot of external libraries, and there are a lot of dependencies between libraries.</p><p>As a result, due to the complexity, it has become hard to determine whether or not to mock dependencies.</p><h4 id=condition>Condition</h4><p>When dependencies have the following factor, you can decide to mock the dependencies.</p><ul><li>Incomplete implementation</li><li>I/O<ul><li>e.g., Network access, disk operation, etc.</li></ul></li><li>Hardware dependent<ul><li>e.g., CPU, Memory usage, disk I/O, etc.</li></ul></li><li>Hard to create the error of dependencies</li><li>Difficult to initialize<ul><li>e.g., Random number and time, file I/O initialization, environment dependent, etc.</li></ul></li><li>The test result may change in each runtime<ul><li>e.g., the only test result may change in each runtime, System call inside implementation, etc.</li></ul></li></ul><h4 id=risk>Risk</h4><p>Before applying mock to the object, you should understand the following risks.</p><ul><li>We <strong>do not</strong> know whether the dependencies are correctly implemented or not.</li><li>We cannot notice the changes in dependencies.</li></ul><h4 id=implementation-1>Implementation</h4><p>The implementation of the mock object should be:</p><ul><li>Same package as the mock target.</li><li>File name is <code>xxx_mock.go</code></li><li>Struct name is <code>Mock{Interface name}</code></li></ul><p>For example, we decided to mock the following implementation <code>Encoder</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Encoder</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>interface</span>{}) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>encoder</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>encoder</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Encoder</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>encoder</span>) <span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>interface</span>{}) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>encoder</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The following is an example of mock implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MockEncoder</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>EncoderFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>interface</span>{}) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MockEncoder</span>) <span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>interface</span>{}) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>EncodeFunc</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The following is an example implementation of test code to create the mock object and mock the implementation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;returns (byte{}, nil) when encode success&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fields</span>: <span style=color:#a6e22e>fields</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>encoding</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MockEncoder</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>EncoderFunc</span>: <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>interface</span>{}) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> []<span style=color:#66d9ef>byte</span>{}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#f92672>......</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#code-formatting-and-naming-convention>Code Formatting and Naming Convention</a><ul><li><a href=#project-layout>Project Layout</a></li><li><a href=#packages>Packages</a></li><li><a href=#general-style>General style</a></li><li><a href=#interfaces>Interfaces</a></li><li><a href=#structs>Structs</a></li><li><a href=#variables-and-constant>Variables and Constant</a></li><li><a href=#methods>Methods</a></li><li><a href=#unused-variables>Unused Variables</a></li><li><a href=#error-handling>Error handling</a></li><li><a href=#error-checking>Error checking</a></li><li><a href=#logging>Logging</a></li></ul></li><li><a href=#implementation>Implementation</a><ul><li><a href=#functional-option>Functional Option</a></li><li><a href=#constructor>Constructor</a></li></ul></li><li><a href=#program-comments>Program comments</a></li><li><a href=#documentation>Documentation</a></li><li><a href=#internal-packages>Internal packages</a></li><li><a href=#dependency-management-and-build>Dependency management and Build</a></li><li><a href=#test>Test</a><ul><li><a href=#table-driven-test>Table-Driven-Test</a></li><li><a href=#create-a-table-driven-test>Create a Table-Driven-Test</a></li><li><a href=#generate-test-code>Generate test code</a></li><li><a href=#customize-test-case>Customize test case</a></li><li><a href=#parallel-test>Parallel test</a></li><li><a href=#helper-function>Helper function</a></li><li><a href=#using-mock>Using Mock</a></li></ul></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>2019-2022 vald.vdaas.org Vald team</p></footer></body></html>