<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Cluster Role Binding</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Cluster Role Binding"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/user-guides/cluster-role-binding/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.7.7</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/overview/component/lb-gateway/>LB Gateway</a></li><li class=index><a href=/docs/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=view><a href=/docs/user-guides/cluster-role-binding/>Cluster Role Binding</a></li><li class=index><a href=/docs/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/user-guides/client-api-config/>Client Api Config</a></li><li class=index><a href=/docs/user-guides/observability-configuration/>Observability Configuration</a></li><li class=index><a href=/docs/user-guides/network-policy/>Network Policy</a></li><li class=index><a href=/docs/user-guides/sdks/>Sdks</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/performance/loadtest/>Loadtest</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/api/insert/>Insert</a></li><li class=index><a href=/docs/api/update/>Update</a></li><li class=index><a href=/docs/api/upsert/>Upsert</a></li><li class=index><a href=/docs/api/search/>Search</a></li><li class=index><a href=/docs/api/remove/>Remove</a></li><li class=index><a href=/docs/api/object/>Object</a></li><li class=index><a href=/docs/api/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/api/status/>Status</a></li><li class=index><a href=/docs/api/build_proto/>Build Proto</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/contributing/development/>Development</a></li><li class=index><a href=/docs/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/support/contacts/>Contacts</a></li><li class=index><a href=/docs/support/faq/>Faq</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=cluster-role-configuration>Cluster Role Configuration</h1><p>The <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>cluster role</a> feature provided by Kubernetes contains rules that represent a set of permission to grant access to a specific target depending on the binding rule.</p><p>This page describes why we need a cluster role for the Vald cluster and how to configure it.</p><h2 id=what-are-cluster-role-and-cluster-role-binding-for-the-vald-cluster>What are cluster role and cluster role binding for the Vald cluster?</h2><p>Vald applies the distributed index system across the Kubernetes cluster depending on the resource usage of the Kubernetes Node, it requires configuration to grant permission to a specific role to retrieve cluster information on Kubernetes.</p><p>By default, the cluster role configurations are deployed automatically when using Helm.</p><p>The following manifest will be deployed by default.</p><ul><li><a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrole.yaml>clusterrole.yaml</a></li><li><a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrolebinding.yaml>clusterrolebinding.yaml</a></li></ul><p>These configurations allow the service account <code>discoverer</code>, which is for the Vald Discoverer components, to access different resources in the Kubernetes cluster.</p><p>This service account allows <a href=/docs/overview/component/discoverer>Vald Discoverer</a> to retrieve Node and Pod resource usage from <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a>, and share it to other components in the Vald cluster.</p><p>For example, <a href=/docs/overview/component/lb-gateway>Vald LB Gateway</a> will control which Vald Agent to insert based on the Node and Pod resource usage retrieved by Vald Discoverer.</p><p>If you are interested, please refer to the <a href=/docs/overview/data-flow#insert>insert data flow</a> for more detail.</p><h2 id=configuration-for-vald-discoverer>Configuration for Vald Discoverer</h2><p>As described in the above section, Vald Discoverer requires configuration on cluster role and cluster role binding to retrieve Node and Pod information from the Kubernetes Cluster.</p><p>In this section, we will describe how to configure it and how to customize these configurations.</p><h3 id=cluster-role-configuration-for-vald-discoverer>Cluster role configuration for Vald Discoverer</h3><p>By looking at the <a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrole.yaml>cluster role configuration</a>, the access right of the following resources are granted to the cluster role <code>discoverer</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>apps</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>replicasets</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>watch</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>nodes</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>nodes/proxy</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>services</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>endpoints</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>pods</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>watch</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>nonResourceURLs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/metrics</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;metrics.k8s.io&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>nodes</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>pods</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>list</span>
</span></span></code></pre></div><p>All of these rules are required to retrieve Node and Pod resource usage from <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a> and also used to discover new Vald Agent Pods or Nodes created on the cluster.</p><h3 id=cluster-role-binding-configuration-for-vald-discoverer>Cluster role binding configuration for Vald Discoverer</h3><p>The cluster role binding configuration binds the cluster role <code>discoverer</code> described in the previous section to the service account <code>vald</code> according to the <a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrolebinding.yaml>configuration file</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vald</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span></code></pre></div><p>When the role binds to the service account, the access right of the role will be granted to the service account.
In this case, all the access rights of the role <code>discoverer</code> will be granted to the service account <code>vald</code>.</p><p>The service account <code>vald</code> is required for <a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/deployment.yaml#l155>Vald Discoverer</a> to retrieve the required information to operate the vald cluster.</p><p>For more information about Vald Discoverer, please refer <a href=/docs/overview/component/discoverer>here</a>.</p><h2 id=customize-cluster-role-and-cluster-role-binding-configuration-on-helm-chart-for-vald-discoverer>Customize cluster role and cluster role binding configuration on Helm chart for Vald Discoverer</h2><p>To customize the cluster role configuration on the Helm chart for Vald Discoverer, you may need to change the <code>discoverer.clusterRole</code> configuration on the Helm chart file. The cluster role configurations are enabled by default.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>discoverer</span>:
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>clusterRole</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># discoverer.clusterRole.enabled -- creates clusterRole resource</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># discoverer.clusterRole.name -- name of clusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>clusterRoleBinding</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># discoverer.clusterRoleBinding.enabled -- creates clusterRoleBinding resource</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># discoverer.clusterRoleBinding.name -- name of clusterRoleBinding</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>serviceAccount</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># discoverer.serviceAccount.enabled -- creates service account</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># discoverer.serviceAccount.name -- name of service account</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vald</span>
</span></span></code></pre></div><div class=warning>If you disable these configurations, the Vald Discoverer will not work, and the Vald cluster will not be functional.</div><p>If you want to modify or disable these configurations, you need to grant the <a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrole.yaml>cluster role configuration</a> and bind it to the Vald Discoverer to retrieve required information to operate the Vald cluster.</p><h2 id=customize-cluster-role-configuration-on-cloud-providers>Customize cluster role configuration on Cloud Providers</h2><p>Please refer to the official guidelines to configure cluster role configuration for your cloud provider, and configure the service account name for Vald Discoverer.</p><p>For example:</p><ul><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html>Amazon EKS</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control>GKE</a></li></ul><p>For other cloud providers, you may need to find the related document on their official website, or you can enable the cluster role and the cluster role binding configurations on the Helm chart.</p><h2 id=related-documents>Related Documents</h2><ul><li><a href=/docs/overview/component/discoverer>Vald Discoverer</a></li><li><a href=/docs/overview/data-flow>Data Flow</a></li><li><a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>Using RBAC Authorization (External Site)</a></li></ul><h2>See also</h2><div class=cardlist><a href=/docs/user-guides/configuration/ class=cardlist__card><p class=card__title>Configuration</p><p class=card__text>Describes the basic configuration for deploying a Vald cluster.</p></a><a href=/docs/user-guides/backup-configuration/ class=cardlist__card><p class=card__title>Backup Configuration</p><p class=card__text>How to set the backup configuration.</p></a><a href=/docs/user-guides/filtering-configuration/ class=cardlist__card><p class=card__title>Filtering Configuration</p><p class=card__text>Explains how to use the filter function in Vald.</p></a><a href=/docs/user-guides/deployment/ class=cardlist__card><p class=card__title>Deployment</p><p class=card__text>Introducing how to deploy the Vald cluster.</p></a></div></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#what-are-cluster-role-and-cluster-role-binding-for-the-vald-cluster>What are cluster role and cluster role binding for the Vald cluster?</a></li><li><a href=#configuration-for-vald-discoverer>Configuration for Vald Discoverer</a><ul><li><a href=#cluster-role-configuration-for-vald-discoverer>Cluster role configuration for Vald Discoverer</a></li><li><a href=#cluster-role-binding-configuration-for-vald-discoverer>Cluster role binding configuration for Vald Discoverer</a></li></ul></li><li><a href=#customize-cluster-role-and-cluster-role-binding-configuration-on-helm-chart-for-vald-discoverer>Customize cluster role and cluster role binding configuration on Helm chart for Vald Discoverer</a></li><li><a href=#customize-cluster-role-configuration-on-cloud-providers>Customize cluster role configuration on Cloud Providers</a></li><li><a href=#related-documents>Related Documents</a></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>Â©2019-2023 vald.vdaas.org Vald team</p></footer></body></html>