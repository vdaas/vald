<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content='index, follow'><title>Vald | Configuration</title>
<meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Configuration"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/user-guides/configuration/"><meta property="og:image" content="https://vald.vdaas.org//images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org//favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org/ class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org//images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org//images/vald_color_1.svg alt>
</picture></a><a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.7.16</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.16</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org//images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org//images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/overview/component/lb-gateway/>Lb Gateway</a></li><li class=index><a href=/docs/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/overview/component/index-manager/>Index Manager</a></li><li class=index><a href=/docs/overview/component/mirror-gateway/>Mirror Gateway</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/tutorial/get-started-with-faiss-agent/>Get Started With Faiss Agent</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li><li class=index><a href=/docs/tutorial/vald-multicluster-on-k8s/>Vald Multicluster on K8s</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=view><a href=/docs/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/user-guides/mirroring-configuration/>Mirroring Configuration</a></li><li class=index><a href=/docs/user-guides/cluster-role-binding/>Cluster Role Binding</a></li><li class=index><a href=/docs/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/user-guides/client-api-config/>Client Api Config</a></li><li class=index><a href=/docs/user-guides/observability-configuration/>Observability Configuration</a></li><li class=index><a href=/docs/user-guides/network-policy/>Network Policy</a></li><li class=index><a href=/docs/user-guides/index-correction/>Index Correction</a></li><li class=index><a href=/docs/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/user-guides/read-replica-and-rotator/>Read Replica and Rotator</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/performance/loadtest/>Loadtest</a></li><li class=index><a href=/docs/performance/continuous-benchmark/>Continuous Benchmark</a></li><li class=index><a href=/docs/performance/tuning-search-performance/>Tuning Search Performance</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/api/insert/>Insert</a></li><li class=index><a href=/docs/api/update/>Update</a></li><li class=index><a href=/docs/api/upsert/>Upsert</a></li><li class=index><a href=/docs/api/search/>Search</a></li><li class=index><a href=/docs/api/remove/>Remove</a></li><li class=index><a href=/docs/api/flush/>Flush</a></li><li class=index><a href=/docs/api/object/>Object</a></li><li class=index><a href=/docs/api/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/api/mirror-gateway/>Mirror Gateway</a></li><li class=index><a href=/docs/api/status/>Status</a></li><li class=index><a href=/docs/api/build_proto/>Build</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/troubleshooting/client-side/>Client Side</a></li><li class=index><a href=/docs/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/troubleshooting/mirror-gateway/>Mirror Gateway</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/contributing/development/>Development</a></li><li class=index><a href=/docs/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/contributing/unit-test-guideline/>Unit Test Guideline</a></li><li class=index><a href=/docs/contributing/reviewer-guideline/>Reviewer Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/support/contacts/>Contacts</a></li><li class=index><a href=/docs/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=configurations>Configurations</h1><p>This page introduces best practices for setting up values for the Vald Helm Chart.</p><p>Before reading, please read the overview of Vald Helm Chart in <a href=https://github.com/vdaas/vald/tree/main/charts/vald>its README</a>.</p><div class=notice>This page shows the notable fields in Vald Helm Chart.<br>It is highly recommended to verify before deployment.</div><h2 id=general>General</h2><h3 id=specify-image-tag>Specify image tag</h3><p>It is highly recommended to specify the Vald version.
You can specify the image version by setting <code>image.tag</code> field in each component (<code>[component].image.tag</code>) or <code>defaults</code> section.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>defaults</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>v1.5.6</span>
</span></span></code></pre></div><p>or you can use the older image only for a target component, e.g., the agent,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>v1.5.5</span>
</span></span></code></pre></div><h3 id=specify-appropriate-logging-level-and-format>Specify appropriate logging level and format</h3><p>The default logging levels and formats are configured in <code>defaults.logging.level</code> and <code>defaults.logging.format</code>.
You can also specify them in each component section (<code>[component].logging</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>defaults</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>level</span>: <span style=color:#ae81ff>info</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>format</span>: <span style=color:#ae81ff>raw</span>
</span></span></code></pre></div><p>You can specify log level <code>debug</code> and JSON format for lb-gateway by the followings:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>lb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>level</span>: <span style=color:#ae81ff>debug</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>format</span>: <span style=color:#ae81ff>json</span>
</span></span></code></pre></div><p>The logging level is defined in <a href=/docs/contributing/coding-style#logging>the Coding Style Guide</a>.</p><h3 id=servers>Servers</h3><p>Each Vald component has several types of servers.
They can be configured by specifying the values in <code>defaults.server_config</code>.</p><p>Examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>defaults</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>server_config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>grpc</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>0.0.0.0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>servicePort</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>GRPC</span>
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>In addition, they can be overwritten by setting each <code>[component].server_config</code>, e.g., <code>gateway.lb.server_config</code> is following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>lb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>rest</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>host</span>: <span style=color:#ae81ff>0.0.0.0</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>servicePort</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>REST</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><h4 id=grpc-server>gRPC server</h4><p>gRPC server should be enabled because all Vald components use gRPC to communicate with others.
The API specs are placed in <a href=/docs/api>Vald APIs</a>.</p><h4 id=rest-server>REST server</h4><p>REST server is optional.
The swagger specs are placed in <a href=https://github.com/vdaas/vald/tree/main/apis/swagger>Vald APIs Swagger</a>.</p><h4 id=health-check-servers>Health check servers</h4><p>There are two built-in health check servers: liveness and readiness.
They are used as servers for <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>Kubernetes liveness and readiness probe</a>.
The liveness health server is disabled by default due to the liveness probe may accidentally kill the Vald Agent component.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>server_config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>healths</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>liveness</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h3 id=metrics-servers>Metrics servers</h3><p>The metrics server enables easier debugging and monitoring of Vald components.
There are two types of metrics servers: pprof and Prometheus.</p><p>pprof server is implemented using Go&rsquo;s <code>net/http/pprof</code> package.
You can use <a href=https://github.com/google/pprof>google&rsquo;s pprof</a> to analyze the exported profile result.</p><p>Prometheus server is a <a href=https://prometheus.io/>Prometheus</a> exporter.
It is required to set the <code>observability</code> section on each Vald component to enable the monitoring using Prometheus.
Please refer to the next section.</p><h3 id=observability>Observability</h3><p>The observability features are useful for monitoring Vald components.
These settings can be enabled by setting the <code>defaults.observability.enabled</code> field to the value <code>true</code> or by overriding it in each component (<code>[component].observability.enabled</code>).
And also, enable each feature by setting the value <code>true</code> on its <code>enabled</code> field.</p><p>If observability features are enabled, the metrics will be collected periodically.
The duration can be set on <code>observability.collector.duration</code>.
Please refer to <a href=/docs/user-guides/configuration>the Vald operation guide</a> for more detail.</p><h2 id=component-basic-configuration>Component basic configuration</h2><h3 id=agents>Agents</h3><h4 id=ngt>NGT</h4><p>Vald Agent NGT uses <a href=https://github.com/yahoojapan/NGT>yahoojapan/NGT</a> as a core library for searching vectors.
The behaviors of NGT can be configured by setting <code>agent.ngt</code> field object.</p><p>The important parameters are the followings:</p><ul><li><code>agent.ngt.dimension</code></li><li><code>agent.ngt.distance_type</code></li><li><code>agent.ngt.object_type</code></li></ul><p>Users should configure these parameters first to fit their use case.
For further details, please read <a href=https://github.com/yahoojapan/NGT/wiki>the NGT wiki</a>.</p><p>Vald Agent NGT has a feature to start indexing automatically.
The behavior of this feature can be configured with these parameters:</p><ul><li><code>agent.ngt.auto_index_duration_limit</code></li><li><code>agent.ngt.auto_index_check_duration</code></li><li><code>agent.ngt.auto_index_length</code></li></ul><div class=notice>While the Vald Agent NGT is in the process of creating indexes, it will ignore all search requests to the target pods.</div><div class=warning>When deploying Vald Index Manager, the above parameters should be set much longer than the Vald Index Manager settings (Please refer to the Vald Index Manager section).<br>E.g., set agent.ngt.auto_index_duration_limit to "720h" and agent.ngt.auto_index_check_duration to "24h".<br>This is because the Vald Index Manager accurately grasps the index information of each Vald Agent NGT and controls the execution timing of indexing.<br><br>When the setting parameter of Vald Agent NGT is shorter than the setting value of Vald Index Manager, Vald Agent NGT may start indexing by itself without the execution command from Vald Index Manager.
If this happens, the Index Manager may not function properly.</div><h4 id=faiss>Faiss</h4><p>Vald Agent Faiss uses <a href=https://github.com/facebookresearch/faiss>facebookresearch/faiss</a> as a core library for searching vectors.
The behaviors of Faiss can be configured by setting <code>agent.faiss</code> field object.</p><p>The important parameters are the followings:</p><ul><li><code>agent.faiss.dimension</code></li><li><code>agent.faiss.distance_type</code></li><li><code>agent.faiss.m</code></li><li><code>agent.faiss.metric_type</code></li><li><code>agent.faiss.nbits_per_idx</code></li><li><code>agent.faiss.nlist</code></li></ul><p>Users should configure these parameters first to fit their use case.
For further details, please read <a href=https://github.com/facebookresearch/faiss/wiki>the Faiss wiki</a>.</p><p>Vald Agent Faiss has a feature to start indexing automatically.
The behavior of this feature can be configured with these parameters:</p><ul><li><code>agent.faiss.auto_index_duration_limit</code></li><li><code>agent.faiss.auto_index_check_duration</code></li><li><code>agent.faiss.auto_index_length</code></li></ul><div class=notice>While the Vald Agent Faiss is in the process of creating indexes, it will ignore all search requests to the target pods.</div><div class=warning>When deploying Vald Index Manager, the above parameters should be set much longer than the Vald Index Manager settings (Please refer to the Vald Index Manager section) or minus value.<br>E.g., set agent.faiss.auto_index_duration_limit to "720h" or "-1h" and agent.faiss.auto_index_check_duration to "24h" or "-1h".<br>This is because the Vald Index Manager accurately grasps the index information of each Vald Agent Faiss and controls the execution timing of indexing.<br><br>When the setting parameter of Vald Agent Faiss is shorter than the setting value of Vald Index Manager, Vald Agent Faiss may start indexing by itself without the execution command from Vald Index Manager.
If this happens, the Index Manager may not function properly.</div><h4 id=resource-requests-and-limits-pod-priorities>Resource requests and limits, Pod priorities</h4><p>Because the Vald Agent pod places indexes on memory, termination of agent pods causes loss of indexes.
It is important to set the resource requests and limits appropriately to avoid terminating the Vald Agent pods.</p><p>Requesting 40% of cluster memory for agent pods is highly recommended.
Also, it is highly recommended not to set the resource limits for the Vald Agent pods.</p><p>Pod priorities are also useful for saving agent pods from eviction.
By default, very high priority is set to agent pods in the Chart.</p><p><a href=/docs/user-guides/capacity-planning>The capacity planning page</a> helps to estimate the resources.</p><h4 id=pod-scheduling>Pod scheduling</h4><p>It is recommended to schedule agent pods on different nodes as much as possible.</p><div class=warning>The affinity setting for Vald Agent is significant for the Vald cluster.<br>Please DO NOT remove the default settings.</div><p>To achieve this, the following <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity>podAntiAffinity</a> is set by default.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>affinity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>podAntiAffinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>preferredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>podAffinityTerm</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>topologyKey</span>: <span style=color:#ae81ff>kubernetes.io/hostname</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>labelSelector</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>matchExpressions</span>:
</span></span><span style=display:flex><span>                - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>In</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ae81ff>vald-agent-ngt</span>
</span></span></code></pre></div><p>It can also be achieved by using <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/>pod topology spread constraints</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>topologySpreadConstraints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>topologyKey</span>: <span style=color:#ae81ff>node</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxSkew</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>whenUnsatisfiable</span>: <span style=color:#ae81ff>ScheduleAnyway</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labelSelector</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>app</span>: <span style=color:#ae81ff>vald-agent-ngt</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>affinity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>podAntiAffinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>preferredDuringSchedulingIgnoredDuringExecution</span>: [] <span style=color:#75715e># to disable default settings</span>
</span></span></code></pre></div><h3 id=gateway-lb>Gateway LB</h3><h4 id=ingress>Ingress</h4><p>Ingress for gateways can be configured by <code>gateway.{filter,lb}.ingress</code> field object.
It is important to set your host to <code>gateway.{filter,lb}.ingress.host</code> field.
<code>gateway.{filter,lb}.ingress.servicePort</code> should be <code>grpc</code> or <code>rest</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>lb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ingress</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>host</span>: <span style=color:#ae81ff>vald.vdaas.org</span> <span style=color:#75715e># Set correct hostname here</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>servicePort</span>: <span style=color:#ae81ff>grpc</span>
</span></span></code></pre></div><h4 id=index-replica>Index replica</h4><p><code>gateway.lb.gateway_config.index_replica</code> represents how many Vald Agent pods a vector will be inserted into.
The maximum value of the index replica should be 30% of the Vald Agent pods deployed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>lb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>index_replica</span>: <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>// By setting the index replica to 3, the number of Vald Agent pods deployed should be more than 9 (3 / 0.3).</span>
</span></span></code></pre></div><h4 id=resource-requests-and-limits>Resource requests and limits</h4><p>The gateway&rsquo;s resource requests and limits depend on the request traffic and available resources.
If the request traffic varies largely, enabling HPA for the gateway and adjusting the resource requests is recommended.</p><h4 id=discoverer-request-duration>Discoverer request duration</h4><p><code>gateway.lb.gateway_config.discoverer.duration</code> represents the frequency of sending requests to the discoverer.
If the discoverer&rsquo;s CPU utilization is too high, make this value longer or reduce the number of LB gateway pods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>lb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>discoverer</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>duration</span>: <span style=color:#ae81ff>2s</span>
</span></span></code></pre></div><h3 id=discoverer>Discoverer</h3><h4 id=cluster-role>Cluster Role</h4><p>Vald Discoverer gets the Node and Pod metrics from <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a> as described in <a href=/docs/overview/component/discoverer>Vald Discoverer</a>.
Vald&rsquo;s Helm deployment supports RBAC as default, and the default configuration is the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>discoverer</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterRole</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># if true, the clusterRole configuration will be created.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterRoleBinding</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># if true, the clusterRoleBinding configuration will be created.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>discoverer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceAccount</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># if true, the serviceAccount configuration will be created.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vald</span>
</span></span></code></pre></div><p>When <code>RBAC</code> is unavailable in your environment, or you would like to put some restrictions, please modify it and grant the permissions to the user executing the discoverer.
Each configuration file is the following:</p><ul><li><a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrole.yaml>Cluster role</a></li><li><a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/clusterrolebinding.yaml>Cluster role binding</a></li><li><a href=https://github.com/vdaas/vald/blob/main/k8s/discoverer/serviceaccount.yaml>Service account</a></li></ul><h4 id=resource-requests-and-limits-1>Resource requests and limits</h4><p>The number of discoverer pods and resource limits can be estimated by the configurations of your LB gateways and index managers because its APIs are called by them.
Discoverer CPU loads almost depend on API request traffic.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># The API traffic formula</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>the number of LB gateways x its request frequency<span style=color:#f92672>)</span> + <span style=color:#f92672>(</span>the number of index managers x its request frequency<span style=color:#f92672>)</span>.
</span></span></code></pre></div><h3 id=index-manager>Index Manager</h3><h4 id=execution-index-command-to-vald-agent>Execution index command to Vald Agent</h4><p>Vald Index Manager controls the indexing timing for all Vald Agent pods in the Vald cluster.
These parameters are related to the control process.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>manager</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>index</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>indexer</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e># namespace of agent pods to manage</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>agent_namespace</span>: <span style=color:#ae81ff>vald</span> <span style=color:#75715e># namespace of agent pods to manage</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># check duration of automatic indexing</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>auto_index_check_duration</span>: <span style=color:#e6db74>&#34;1m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># limit duration of automatic indexing</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>auto_index_duration_limit</span>: <span style=color:#e6db74>&#34;30m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># number of caches to trigger automatic indexing</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>auto_index_length</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># limit duration of automatic index saving</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>auto_save_index_duration_limit</span>: <span style=color:#e6db74>&#34;3h&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># duration of automatic index saving wait duration for next saving</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>auto_save_index_wait_duration</span>: <span style=color:#e6db74>&#34;10m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># the number of Agent Pods indexing at the same time</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>concurrency</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># number of pool size of creating index processing</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>creation_pool_size</span>: <span style=color:#ae81ff>10000</span>
</span></span></code></pre></div><h4 id=discoverer-request-duration-1>Discoverer request duration</h4><p>Same as LB gateway, <code>manager.index.indexer.discoverer.duration</code> represents the frequency of sending requests to the discoverer.</p><h2 id=references>References</h2><p>For further details, there are references to the Helm values in the Vald GitHub repository.</p><ul><li><a href=https://github.com/vdaas/vald/tree/main/charts/vald>README of Vald Helm Chart</a></li><li><a href=https://github.com/vdaas/vald/tree/main/charts/vald-helm-operator>README of Vald-Helm-Operator Chart</a></li></ul><h2>See also</h2><div class=cardlist><a href=/docs/user-guides/backup-configuration/ class=cardlist__card><p class=card__title>Backup Configuration</p><p class=card__text>Applies backup feature for saving and restoring indexes</p></a><a href=/docs/user-guides/filtering-configuration/ class=cardlist__card><p class=card__title>Filtering Configuration</p><p class=card__text>Applies filtering feature to the Vald cluster</p></a><a href=/docs/user-guides/mirroring-configuration/ class=cardlist__card><p class=card__title>Mirroring Configuration</p><p class=card__text>Applies mirror gateway for running multi Vald clusters</p></a><a href=/docs/user-guides/cluster-role-binding/ class=cardlist__card><p class=card__title>Cluster Role Binding</p><p class=card__text>Configures cluster role for Vald cluster</p></a></div></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#general>General</a><ul><li><a href=#specify-image-tag>Specify image tag</a></li><li><a href=#specify-appropriate-logging-level-and-format>Specify appropriate logging level and format</a></li><li><a href=#servers>Servers</a></li><li><a href=#metrics-servers>Metrics servers</a></li><li><a href=#observability>Observability</a></li></ul></li><li><a href=#component-basic-configuration>Component basic configuration</a><ul><li><a href=#agents>Agents</a></li><li><a href=#gateway-lb>Gateway LB</a></li><li><a href=#discoverer>Discoverer</a></li><li><a href=#index-manager>Index Manager</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></aside></div></div></main><footer class=footer><div class=footer__content><ul class=footer__index><li class=footer__item><a href=/docs/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li></ul><ul class=footer__sns><li class=footer__item><a class="footer__item footer__icon" href=https://x.com/vdaas_vald target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_x_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_x_black.svg alt=x class=icon__image></picture></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://join.slack.com/t/vald-community/shared_invite/zt-db2ky9o4-R_9p2sVp8xRwztVa8gfnPA target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_slack_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_slack_black.svg alt=slack class=icon__image></picture></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>©2019-2024 vald.vdaas.org Vald team</p></footer></body></html>