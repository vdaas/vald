<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content='index, follow'><title>Vald | Operations</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Operations"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/user-guides/operations/"><meta property="og:image" content="https://vald.vdaas.org//images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org//favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org/ class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org//images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org//images/vald_color_1.svg alt>
</picture></a><a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.7.16</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.16</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org//images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org//images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/overview/component/lb-gateway/>Lb Gateway</a></li><li class=index><a href=/docs/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/overview/component/index-manager/>Index Manager</a></li><li class=index><a href=/docs/overview/component/mirror-gateway/>Mirror Gateway</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/tutorial/get-started-with-faiss-agent/>Get Started With Faiss Agent</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li><li class=index><a href=/docs/tutorial/vald-multicluster-on-k8s/>Vald Multicluster on K8s</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/user-guides/mirroring-configuration/>Mirroring Configuration</a></li><li class=index><a href=/docs/user-guides/cluster-role-binding/>Cluster Role Binding</a></li><li class=index><a href=/docs/user-guides/deployment/>Deployment</a></li><li class=view><a href=/docs/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/user-guides/client-api-config/>Client Api Config</a></li><li class=index><a href=/docs/user-guides/observability-configuration/>Observability Configuration</a></li><li class=index><a href=/docs/user-guides/network-policy/>Network Policy</a></li><li class=index><a href=/docs/user-guides/index-correction/>Index Correction</a></li><li class=index><a href=/docs/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/user-guides/read-replica-and-rotator/>Read Replica and Rotator</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/performance/loadtest/>Loadtest</a></li><li class=index><a href=/docs/performance/continuous-benchmark/>Continuous Benchmark</a></li><li class=index><a href=/docs/performance/tuning-search-performance/>Tuning Search Performance</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/api/insert/>Insert</a></li><li class=index><a href=/docs/api/update/>Update</a></li><li class=index><a href=/docs/api/upsert/>Upsert</a></li><li class=index><a href=/docs/api/search/>Search</a></li><li class=index><a href=/docs/api/remove/>Remove</a></li><li class=index><a href=/docs/api/flush/>Flush</a></li><li class=index><a href=/docs/api/object/>Object</a></li><li class=index><a href=/docs/api/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/api/mirror-gateway/>Mirror Gateway</a></li><li class=index><a href=/docs/api/status/>Status</a></li><li class=index><a href=/docs/api/build_proto/>Build</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/troubleshooting/client-side/>Client Side</a></li><li class=index><a href=/docs/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/troubleshooting/mirror-gateway/>Mirror Gateway</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/contributing/development/>Development</a></li><li class=index><a href=/docs/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/contributing/unit-test-guideline/>Unit Test Guideline</a></li><li class=index><a href=/docs/contributing/reviewer-guideline/>Reviewer Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/support/contacts/>Contacts</a></li><li class=index><a href=/docs/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=operations>Operations</h1><p>This page introduces best practices for operating a Vald cluster.</p><h2 id=deployment>Deployment</h2><h3 id=kubernetes-cluster>Kubernetes cluster</h3><p>Since Vald agents stores vector data on their memory space, unexpected disruption or eviction of agents may cause loss of indices.
Also, disruption or deletion of worker nodes that have Vald agents may cause loss of indices.
If you need to prevent low accuracy effects caused by indices loss, it is better to increase the number of nodes and pods.</p><p>However, to maximize the efficiency of search operations, it is better to have a certain amount of vectors in each NGT vector space.</p><p>We recommend having more than 3 worker nodes with enough memory for the workload.
Deploying 2 or 3 Vald agent pods to each worker node is better.
If you want to store 100 million vectors with 128 dimensions, <code>8 bytes (64bit float) x 128 (dimension) x 100 million x N replicas</code>, 100 GB x N memory space is needed.
If the number of index replicas is three, which means N=3, the total amount of memory space for the whole cluster will be 300 GB at least.</p><p>For example:</p><ul><li>10 worker nodes with 24 GB RAM and 3 Vald agents on each worker node (total: 240 GB RAM, 30 Vald agents)</li><li>20 worker nodes with 16 GB RAM and 2 Vald agents on each worker node (total: 320 GB RAM, 40 Vald agents)</li></ul><h3 id=on-multi-tenant-cluster>On multi-tenant cluster</h3><p>If you’re going to deploy Vald on the multi-tenant cluster, please take care of the followings.</p><ul><li>It is recommended to define PriorityClasses for agents not to be evicted.<ul><li>For more info, please visit the page <a href=https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/>Pod Priority and Preemption</a>.</li><li>If you are using <a href=https://github.com/vdaas/vald/tree/main/charts/vald>the Vald chart</a>, PriorityClasses are defined by default.</li></ul></li><li>Defining unique namespaces for each Vald and the other apps are recommended.</li><li>Then, please define ResourceQuotas for the namespace for the other apps to limit their memory usage.<ul><li>For more info, please visit this page, <a href=https://kubernetes.io/docs/concepts/policy/resource-quotas/>Resource Quotas</a>.</li></ul></li></ul><h2 id=monitoring>Monitoring</h2><h3 id=logging>Logging</h3><p>The logging level of Vald components can be configured by <code>defaults.logging.level</code> (or <code>[component].logging.level</code>) field in Helm Chart values.
The level must be a one of <code>debug</code>, <code>info</code>, <code>warn</code>, <code>error</code>, and <code>fatal</code>.
The levels are defined in <a href=/docs/contributing/coding-style#logging>the Coding Style document</a>.</p><h3 id=observability-features-of-vald>Observability features of Vald</h3><p>The observability features are useful for monitoring Vald components.
Vald has various exporters, such as Prometheus, Jaeger, etc.
Using this feature, you can observe and visualize the internal stats or the events, like the number of NGT indexes, when to createIndex, or the number of RPCs.</p><h3 id=enabling-observability-feature>Enabling observability feature</h3><p>By setting <code>defaults.observability.enabled</code> (or <code>[component].observability.enabled</code>) in the Helm Chart value set to <code>true</code>, the observability features become enabled.
If observability features are enabled, the metrics will be collected periodically.
The duration can be set on <code>observability.collector.duration</code>.</p><p>If you&rsquo;d like to use the tracing feature, you should enable it by setting <code>observability.trace.enabled</code> set to <code>true</code>. The sampling rate can be configured with <code>observability.trace.sampling_rate</code></p><h3 id=monitoring-vald-cluster-using-prometheus-and-grafana>Monitoring Vald cluster using Prometheus and Grafana</h3><p>In this section, an example of monitoring the Vald cluster using <a href=https://prometheus.io/>Prometheus</a> and <a href=https://grafana.com>Grafana</a> will be shown.</p><h4 id=vald-configuration>Vald configuration</h4><p>To use the Prometheus exporter, you should enable it by setting both <code>observability.prometheus.enabled</code> and <code>server_config.metrics.prometheus.enabled</code> set to <code>true</code>.
The exporter port and endpoint are specified in each <code>server_config.metrics.prometheus.port</code> and <code>observability.prometheus.endpoint</code>.</p><p>Now it&rsquo;s ready to scrape Vald metrics.
Please deploy Prometheus and Grafana to your cluster.</p><h4 id=deploy-prometheus>Deploy Prometheus</h4><p>Prometheus can be installed using one of the following.</p><ul><li><a href=https://github.com/coreos/prometheus-operator>Prometheus Operator</a></li><li><a href=https://github.com/vdaas/vald/tree/main/k8s/metrics/prometheus>Prometheus deployments in Vald repository</a></li></ul><p>If you use Prometheus Operator, it is required to set configurations properly along with <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/>Prometheus Configuration</a> page.
It is recommended to use the endpoints role of the service discovery.</p><h4 id=deploy-grafana>Deploy Grafana</h4><p>Grafana can be installed using one of the following.</p><ul><li><a href=https://operatorhub.io/operator/grafana-operator>Grafana Operator</a></li><li><a href=https://github.com/vdaas/vald/tree/main/k8s/metrics/grafana>Grafana deployments in Vald repository</a></li></ul><p>It is required to set your Prometheus to a data source.</p><h4 id=example-dashboard>Example dashboard</h4><p>Now you can construct your own Grafana dashboard to monitor Vald metrics.
This is an example of a custom dashboard. It is based on <a href=https://github.com/vdaas/vald/tree/main/k8s/metrics/grafana/dashboards>our standard dashboard settings</a>.</p><img src=/images/guides/operations/grafana-example.png><h2 id=upgrading>Upgrading</h2><p>Our versioning strategy is based on <a href=https://semver.org/>Semantic Versioning</a>.
Upgrading to a new version, such as minor or major, may require changing your configurations.
Please read the <a href=https://vald.vdaas.org/docs/release/changelog/>CHANGELOG</a> before upgrading.</p><h3 id=in-case-of-manual-deploy>In case of manual deploy</h3><p>In manual deployments, it is generally required to update your ConfigMaps first.
After that, please update the image tags of Vald components in your deployments.</p><h3 id=in-case-of-using-helm>In case of using Helm</h3><p>In case of using Helm and Vald&rsquo;s chart, please update <code>defaults.image.tag</code> field and install it.</p><h3 id=in-case-of-using-vald-helm-operator>In case of using Vald-Helm-Operator</h3><p>If using Vald-Helm-Operator, please upgrade the CRDs first because Helm doesn’t have support to upgrade CRDs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>VERSION<span style=color:#f92672>=</span>v1.4.1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl replace -f https://raw.githubusercontent.com/vdaas/vald/<span style=color:#e6db74>${</span>VERSION<span style=color:#e6db74>}</span>/charts/vald-helm-operator/crds/valdrelease.yaml <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>kubectl replace -f https://raw.githubusercontent.com/vdaas/vald/<span style=color:#e6db74>${</span>VERSION<span style=color:#e6db74>}</span>/charts/vald-helm-operator/crds/valdhelmoperatorrelease.yaml
</span></span></code></pre></div><p>After upgrading CRDs, please upgrade the operator.
If you&rsquo;re using <code>valdhelmoperatorrelease</code> (or <code>vhor</code>) resource, please update the <code>spec.image.tag</code> field of it.
On the other hand, please update the operator&rsquo;s deployment manually.</p><p>After that, please update <code>image.tag</code> field in your valdrelease (or <code>vr</code>) resource.
The operator will automatically detect the changes and update the deployed Vald cluster.</p><h3 id=references>References</h3><ul><li><a href=https://github.com/vdaas/vald/tree/main/charts/vald>vald-helm-chart</a></li><li><a href=https://github.com/vdaas/vald/tree/main/charts/vald-helm-operator>vald-helm-operator-chart</a></li><li><a href=https://vald.vdaas.org/docs/release/changelog/>CHANGELOG</a></li></ul><h2>See also</h2><div class=cardlist><a href=/docs/user-guides/configuration/ class=cardlist__card><p class=card__title>Configuration</p><p class=card__text>Applies basic configuration for running Vald cluster</p></a><a href=/docs/user-guides/backup-configuration/ class=cardlist__card><p class=card__title>Backup Configuration</p><p class=card__text>Applies backup feature for saving and restoring indexes</p></a><a href=/docs/user-guides/filtering-configuration/ class=cardlist__card><p class=card__title>Filtering Configuration</p><p class=card__text>Applies filtering feature to the Vald cluster</p></a><a href=/docs/user-guides/mirroring-configuration/ class=cardlist__card><p class=card__title>Mirroring Configuration</p><p class=card__text>Applies mirror gateway for running multi Vald clusters</p></a></div></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#deployment>Deployment</a><ul><li><a href=#kubernetes-cluster>Kubernetes cluster</a></li><li><a href=#on-multi-tenant-cluster>On multi-tenant cluster</a></li></ul></li><li><a href=#monitoring>Monitoring</a><ul><li><a href=#logging>Logging</a></li><li><a href=#observability-features-of-vald>Observability features of Vald</a></li><li><a href=#enabling-observability-feature>Enabling observability feature</a></li><li><a href=#monitoring-vald-cluster-using-prometheus-and-grafana>Monitoring Vald cluster using Prometheus and Grafana</a></li></ul></li><li><a href=#upgrading>Upgrading</a><ul><li><a href=#in-case-of-manual-deploy>In case of manual deploy</a></li><li><a href=#in-case-of-using-helm>In case of using Helm</a></li><li><a href=#in-case-of-using-vald-helm-operator>In case of using Vald-Helm-Operator</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></aside></div></div></main><footer class=footer><div class=footer__content><ul class=footer__index><li class=footer__item><a href=/docs/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li></ul><ul class=footer__sns><li class=footer__item><a class="footer__item footer__icon" href=https://x.com/vdaas_vald target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_x_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_x_black.svg alt=x class=icon__image></picture></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://join.slack.com/t/vald-community/shared_invite/zt-db2ky9o4-R_9p2sVp8xRwztVa8gfnPA target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_slack_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_slack_black.svg alt=slack class=icon__image></picture></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>©2019-2024 vald.vdaas.org Vald team</p></footer></body></html>