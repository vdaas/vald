<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content='index, follow'><title>Vald | Read Replica and Rotator</title>
<meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Read Replica and Rotator"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/user-guides/read-replica-and-rotator/"><meta property="og:image" content="https://vald.vdaas.org//images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org//favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org/ class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org//images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org//images/vald_color_1.svg alt>
</picture></a><a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.7.13</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.13</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org//images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org//images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/overview/component/lb-gateway/>Lb Gateway</a></li><li class=index><a href=/docs/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/overview/component/index-manager/>Index Manager</a></li><li class=index><a href=/docs/overview/component/mirror-gateway/>Mirror Gateway</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/tutorial/get-started-with-faiss-agent/>Get Started With Faiss Agent</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li><li class=index><a href=/docs/tutorial/vald-multicluster-on-k8s/>Vald Multicluster on K8s</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/user-guides/mirroring-configuration/>Mirroring Configuration</a></li><li class=index><a href=/docs/user-guides/cluster-role-binding/>Cluster Role Binding</a></li><li class=index><a href=/docs/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/user-guides/client-api-config/>Client Api Config</a></li><li class=index><a href=/docs/user-guides/observability-configuration/>Observability Configuration</a></li><li class=index><a href=/docs/user-guides/network-policy/>Network Policy</a></li><li class=index><a href=/docs/user-guides/index-correction/>Index Correction</a></li><li class=index><a href=/docs/user-guides/sdks/>Sdks</a></li><li class=view><a href=/docs/user-guides/read-replica-and-rotator/>Read Replica and Rotator</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/performance/benchmark/>Benchmark</a></li><li class=index><a href=/docs/performance/loadtest/>Loadtest</a></li><li class=index><a href=/docs/performance/continuous-benchmark/>Continuous Benchmark</a></li><li class=index><a href=/docs/performance/tuning-search-performance/>Tuning Search Performance</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/api/insert/>Insert</a></li><li class=index><a href=/docs/api/update/>Update</a></li><li class=index><a href=/docs/api/upsert/>Upsert</a></li><li class=index><a href=/docs/api/search/>Search</a></li><li class=index><a href=/docs/api/remove/>Remove</a></li><li class=index><a href=/docs/api/object/>Object</a></li><li class=index><a href=/docs/api/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/api/mirror-gateway/>Mirror Gateway</a></li><li class=index><a href=/docs/api/status/>Status</a></li><li class=index><a href=/docs/api/build_proto/>Build</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/troubleshooting/client-side/>Client Side</a></li><li class=index><a href=/docs/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/troubleshooting/mirror-gateway/>Mirror Gateway</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/contributing/development/>Development</a></li><li class=index><a href=/docs/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/contributing/unit-test-guideline/>Unit Test Guideline</a></li><li class=index><a href=/docs/contributing/reviewer-guideline/>Reviewer Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/support/contacts/>Contacts</a></li><li class=index><a href=/docs/support/faq/>FAQ</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=read-replica-and-rotator>Read Replica and Rotator</h1><p>Read replica enhances the search QPS (Queries Per Second) of the Vald cluster by deploying read-only agents in addition to the regular agents and distributing the requests among them. Read replica is deployed as Kubernetes deployments, and depending on the number of replicas (N), QPS increases by approximately 1.7 to 1.8 times * N.</p><div class=notice>The increase in QPS is possible with sufficient infrastructure (see <a href=#important-notes>Important notes</a>).</div><h2 id=how-to-deploy-read-replica>How to deploy read replica</h2><p>The read replica is managed with a separate chart from the Vald cluster and is deployed as an addon to the Vald cluster. The Vald cluster should be deployed first, followed by the deployment of the read replica.</p><blockquote><p>The reason Vald and Vald-readreplica are in separate charts is to avoid conflicts between the read replica&rsquo;s restart and the Helm operator&rsquo;s processes when Vald is managed by a helm operator. Therefore, the read replica will always be deployed using Helm commands.</p></blockquote><h3 id=when-you-deploy-vald-with-helm-command>When you deploy Vald with Helm command</h3><ol><li><p>Edit <code>values.yaml</code> like below (Please refer to <a href=/docs/user-guides/deployment>deployment</a> for other fields.)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>ngt</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>export_index_info_to_k8s</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>readreplica</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>minReplicas</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># if you don&#39;t use hpa, this will be the replicas of the Deployment</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>maxReplicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hpa</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># if you prefer to use hpa</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetCPUUtilizationPercentage</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span><span style=color:#f92672>manager</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>index</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>operator</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>rotation_job_concurrency</span>: <span style=color:#ae81ff>2</span>
</span></span></code></pre></div></li><li><p>Deploy Vald cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install vald vald/vald --values values.yaml
</span></span></code></pre></div></li><li><p>Deploy <code>vald-readreplica</code> with the same <code>values.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install vald-readreplica vald/vald-readreplica --values values.yaml
</span></span></code></pre></div></li></ol><h3 id=when-you-deploy-vald-cluster-with-vald-helm-operator>When you deploy Vald cluster with <code>vald-helm-operator</code></h3><ol><li><p>Edit <code>valdrelease.yaml</code> with the same fields as above</p></li><li><p>Deploy Vald cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install vald-helm-operator-release vald/vald-helm-operator
</span></span><span style=display:flex><span>kubectl apply -f valdrelease.yaml
</span></span></code></pre></div></li><li><p>Deploy <code>vald-readreplica</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install vald-readreplica vald/vald-readreplica --values &lt;YOUR VALUES YAML FILE PATH&gt;
</span></span></code></pre></div></li></ol><h2 id=architecture>Architecture</h2><p>Read replica mainly consists of the following four parts.</p><img src=/images/guides/read-replica-and-rotator/architecture.png alt="Read Replica Architecture"><h3 id=read-replica-deployment>Read replica deployment</h3><p>The deployment that generates Pods where the actual processing of read replica takes place. Read replica accepts read requests (search) and reads the index from the read replica PVC.</p><h3 id=read-replica-pvc>Read replica PVC</h3><p>The PVC for read replica Pods is used to read the index. It is generated based on the latest snapshot from the PVC of the regular agent. Unlike the agent PVC, it is generated as ROX, allowing it to be read from multiple Pods.</p><h3 id=index-operator>Index operator</h3><p>The operator handles the following processes:</p><ol><li>Monitoring the time when the agent saved the index to the PVC and when the read replica performed index rotation</li><li>Generating <a href=#read-replica-rotator>Read replica rotator</a> job when an index save occurs after the most recent rotation</li></ol><blockquote><p>The Index operator also manages the timing of index create/save operations other than those mentioned above. Please refer to another document for details.</p></blockquote><h3 id=read-replica-rotator>Read replica rotator</h3><p>The Kubernetes job handles the following processes:</p><ol><li>Creating a snapshot from the agent&rsquo;s PVC</li><li>Generating a PVC for read replica from the snapshot</li><li>Rolling update of the read replica deployment to launch a group of read replica pods with the latest index</li></ol><h2 id=important-notes>Important notes</h2><p>Result consistency is guaranteed</p><p>There is a time lag between index insertion, agent save, and the completion of read replica rotation. During this time, there may be inconsistencies between the index in the agent itself and the index in the read replica.</p><ul><li><p>Sufficient infrastructure is required for QPS scaling</p><p>Even if read replicas are deployed, QPS will not scale if sufficient resources are not available in the Kubernetes cluster. Specifically, agent resources and read replica resources should be deployed on separate nodes. Vald sets <code>podAntiAffinity</code> to ensure that agent resources and read replica resources are deployed on separate nodes as much as possible.</p></li></ul><h2>See also</h2><div class=cardlist><a href=/docs/user-guides/configuration/ class=cardlist__card><p class=card__title>Configuration</p><p class=card__text>Applies basic configuration for running Vald cluster</p></a><a href=/docs/user-guides/backup-configuration/ class=cardlist__card><p class=card__title>Backup Configuration</p><p class=card__text>Applies backup feature for saving and restoring indexes</p></a><a href=/docs/user-guides/filtering-configuration/ class=cardlist__card><p class=card__title>Filtering Configuration</p><p class=card__text>Applies filtering feature to the Vald cluster</p></a><a href=/docs/user-guides/mirroring-configuration/ class=cardlist__card><p class=card__title>Mirroring Configuration</p><p class=card__text>Applies mirror gateway for running multi Vald clusters</p></a></div></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#how-to-deploy-read-replica>How to deploy read replica</a><ul><li><a href=#when-you-deploy-vald-with-helm-command>When you deploy Vald with Helm command</a></li><li><a href=#when-you-deploy-vald-cluster-with-vald-helm-operator>When you deploy Vald cluster with <code>vald-helm-operator</code></a></li></ul></li><li><a href=#architecture>Architecture</a><ul><li><a href=#read-replica-deployment>Read replica deployment</a></li><li><a href=#read-replica-pvc>Read replica PVC</a></li><li><a href=#index-operator>Index operator</a></li><li><a href=#read-replica-rotator>Read replica rotator</a></li></ul></li><li><a href=#important-notes>Important notes</a></li></ul></nav></aside></div></div></main><footer class=footer><div class=footer__content><ul class=footer__index><li class=footer__item><a href=/docs/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li></ul><ul class=footer__sns><li class=footer__item><a class="footer__item footer__icon" href=https://twitter.com/vdaas_vald target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_x_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_x_black.svg alt=x class=icon__image></picture></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://join.slack.com/t/vald-community/shared_invite/zt-db2ky9o4-R_9p2sVp8xRwztVa8gfnPA target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_slack_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_slack_black.svg alt=slack class=icon__image></picture></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org//images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org//images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>©2019-2024 vald.vdaas.org Vald team</p></footer></body></html>