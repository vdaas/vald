<!doctype html><html><head><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="noindex"><title>Vald | Get Started</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Get Started"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org"><meta property="og:image" content="https://vald.netlify.app/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.netlify.app/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script></head><body><header class=header id=header><div class=header__content><nav class="header__nav cf"><a href=https://vald.netlify.app class=header-nav__link><picture>
<source srcset=https://vald.netlify.app/images/vald_white.svg media="(prefers-color-scheme: dark)" class=header-nav__image><img src=https://vald.netlify.app/images/vald_color_1.svg alt class=header-nav__image></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=https://vald.netlify.app/docs/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=https://vald.netlify.app/docs/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=https://medium.com/@vdaas_vald target=_blank class=header__link>Blog<br></a></li><li class=header__item><a href=https://github.com/vdaas/vald target=_blank class="header__link header__link--button">Github</a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><button class=index id=list-button>Pages</button><ul id=list-body><li class=withchild id=menu_Overview>Overview<ul><ul><li class=index><a href=/docs/v0.0.46/overview/about-vald/>About Vald</a></li><ul><li class=index><a href=/docs/v0.0.46/overview/architecture/>Architecture</a></li></ul></li><li class=withchild id=menu_Tutorial>Tutorial<ul><ul><li class=index><a href=/docs/v0.0.46/tutorial/agent-on-docker/>Agent on Docker</a></li><ul><li class=view><a href=/docs/v0.0.46/tutorial/get-started/>Get Started</a></li></ul></li><li class=withchild id="menu_User Guides">User Guides<ul><ul><li class=index><a href=/docs/v0.0.46/user-guides/configuration/>Configuration</a></li></ul></li><li class=withchild id=menu_Usecase>Usecase<ul><ul><li class=index><a href=/docs/v0.0.46/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id=menu_Contributing>Contributing<ul><ul><li class=index><a href=/docs/v0.0.46/contributing/coding-style/>Coding Style</a></li><ul><li class=index><a href=/docs/v0.0.46/contributing/contributing-guide/>Contributing Guide</a></li></ul></li><li class=withchild id=menu_Support>Support<ul><ul><li class=index><a href=/docs/v0.0.46/support/contacts/>Contacts</a></li></ul></li><li class=withchild id=menu_Release>Release<ul><ul><li class=index><a href=/docs/v0.0.46/release/changelog/>Changelog</a></li></ul></li></ul><nav></aside><div class=content><div class=markdown id=markdown><h1 id=get-started>Get Started</h1><p>Vald is a highly scalable distributed fast approximate nearest neighbor dense vector search engine.<br>Vald is designed and implemented based on Cloud-Native architecture.</p><p>This article will show you how to deploy and run the Vald components on your kubernetes cluster.
Fashion-mnist is used as an example of a dataset.</p><h2 id=requirements>Requirements</h2><ul><li>kubernetes: v1.17 ~</li><li>go: v1.14 ~</li><li>helm: v3 ~</li><li>libhdf5 (<em>only required for this tutorial.</em>)</li></ul><p>Helm and hdf5 is required for this tutorial. If helm or hdf5 is not installed, please install <a href=https://helm.sh/docs/intro/install>helm</a> and <a href=https://www.hdfgroup.org/>hdf5</a>.</p><details><summary>[Optional] Install helm</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
</code></pre></div></details><details><summary>[Optional] Install hdf5</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># yum</span>
yum install -y hdf5-devel

<span style=color:#75715e># apt</span>
apt-get install libhdf5-serial-dev

<span style=color:#75715e># homebrew</span>
brew install hdf5
</code></pre></div></details><h2 id=deploy-and-run-vald-on-kubernetes>Deploy and Run Vald on kubernetes</h2><h3 id=deploy>Deploy</h3><p>This chapter will show you how to deploy using Helm and run Vald on your kubernetes cluster.<br>This chapter uses Scylla DB as a backend data store for indexing and data backup.<br>If you want to learn about Scylla, please refer to <a href=https://www.scylladb.com/>the official website</a>.</p><ol><li><p>Confirm which cluster to deploy</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl cluster-info
</code></pre></div></li><li><p>Prepare Scylla DB and kubernetes metrics-server</p><p>Deploy Scylla as a backup database.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f k8s/jobs/db/initialize/cassandra/configmap.yaml
kubectl apply -f k8s/external/scylla
</code></pre></div><p>Apply kubernetes metrics-server</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f k8s/metrics/metrics-server
</code></pre></div></li><li><p>Deploy Vald using helm</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm repo add vald https://vald.vdaas.org/charts
helm install vald vald/vald --values example/helm/values-scylla.yaml
</code></pre></div></li><li><p>Verify</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pods
</code></pre></div><details><summary>Example output</summary><br>If the deployment is successful, all Vald components should be running.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAME                                       READY   STATUS    RESTARTS   AGE
scylla-0                                   1/1     Running   <span style=color:#ae81ff>0</span>          13m
scylla-1                                   1/1     Running   <span style=color:#ae81ff>0</span>          12m
scylla-2                                   1/1     Running   <span style=color:#ae81ff>0</span>          10m
vald-agent-ngt-0                           1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-agent-ngt-1                           1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-agent-ngt-2                           1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-agent-ngt-3                           1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-agent-ngt-4                           1/1     Runnnig   <span style=color:#ae81ff>0</span>          5m49s
vald-discoverer-97c88678b-wj6xn            1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-gateway-5bf95f8d97-2v76g              1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-gateway-5bf95f8d97-5wtb2              1/1     Running   <span style=color:#ae81ff>0</span>          78s
vald-gateway-5bf95f8d97-7d6j7              1/1     Running   <span style=color:#ae81ff>0</span>          78s
vald-gateway-5bf95f8d97-gx45c              1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-gateway-5bf95f8d97-kx2c5              1/1     Running   <span style=color:#ae81ff>0</span>          78s
vald-gateway-5bf95f8d97-np2lc              1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-backup-6c9695b69b-9xngp       1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-backup-6c9695b69b-jvwft       1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-backup-6c9695b69b-mjs2r       1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-compressor-6c95bdbfb5-m5t7t   1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-compressor-6c95bdbfb5-q8hc6   1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-compressor-6c95bdbfb5-zp8hb   1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-manager-index-59676f54bb-nzfwt        1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-meta-559744db-bcrdw                   1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
vald-meta-559744db-hz7gd                   1/1     Running   <span style=color:#ae81ff>0</span>          5m49s
</code></pre></div></details></li></ol><h3 id=run-using-example-code>Run using example code</h3><p>This chapter shows how to perform a search action in Vald with fashion-mnist dataset.</p><ol><li><p>Port Forward</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl port-forward deployment/vald-gateway 8081:8081
</code></pre></div></li><li><p>Download dataset</p><p>In this tutorial. we use <a href=https://github.com/zalandoresearch/fashion-mnist>fashion-mnist</a> as a dataset for indexing and search query.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># move to working directory</span>
cd example/client

<span style=color:#75715e># download fashion-mnist testing dataset</span>
wget http://ann-benchmarks.com/fashion-mnist-784-euclidean.hdf5
</code></pre></div></li><li><p>Running example</p><p>Vald provides multiple language client libraries such as Go, Java, Node.js, Python, and so on.<br>In this example, the fashion-mnist dataset will insert into the Vald cluster and perform a search using <a href=https://github.com/vdaas/vald-client-go>vald-client-go</a>.</p><p>We use <a href=https://github.com/vdaas/vald/blob/master/example/client/main.go><code>example/client/main.go</code></a> to run the example.
This will execute 4 steps.</p><ol><li><p>init</p><ul><li><p>Import packages</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;context&#34;</span>
    <span style=color:#e6db74>&#34;encoding/json&#34;</span>
    <span style=color:#e6db74>&#34;flag&#34;</span>
    <span style=color:#e6db74>&#34;time&#34;</span>

    <span style=color:#e6db74>&#34;github.com/kpango/fuid&#34;</span>
    <span style=color:#e6db74>&#34;github.com/kpango/glg&#34;</span>
    <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/gateway/vald&#34;</span>
    <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/payload&#34;</span>

    <span style=color:#e6db74>&#34;gonum.org/v1/hdf5&#34;</span>
    <span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
)
</code></pre></div></details></li><li><p>Set variables</p><ul><li><p>The constant number of training datasets and test datasets.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>const</span> (
    <span style=color:#a6e22e>insertCount</span> = <span style=color:#ae81ff>400</span>
    <span style=color:#a6e22e>testCount</span> = <span style=color:#ae81ff>20</span>
)
</code></pre></div></details></li><li><p>The variables for configuration.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>const</span> (
    <span style=color:#a6e22e>datasetPath</span>         <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>grpcServerAddr</span>      <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>indexingWaitSeconds</span> <span style=color:#66d9ef>uint</span>
)
</code></pre></div></details></li></ul></li><li><p>Recognition parameters.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>datasetPath</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#e6db74>&#34;fashion-mnist-784-euclidean.hdf5&#34;</span>, <span style=color:#e6db74>&#34;set dataset path&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>grpcServerAddr</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;127.0.0.1:8081&#34;</span>, <span style=color:#e6db74>&#34;set gRPC server address&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>UintVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>indexingWaitSeconds</span>, <span style=color:#e6db74>&#34;wait&#34;</span>, <span style=color:#ae81ff>60</span>, <span style=color:#e6db74>&#34;set indexing wait seconds&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
}
</code></pre></div></details></li></ul></li><li><p>load</p><ul><li><p>Loading from fashion-mnist dataset and set id for each vector that is loaded. This step will return the training dataset, test dataset, and ids list of ids when loading is completed with success.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ids</span>, <span style=color:#a6e22e>train</span>, <span style=color:#a6e22e>test</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>datasetPath</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
}
</code></pre></div></details></li></ul></li><li><p>Create the gRPC connection and Vald client with gRPC connection.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()

<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>grpcServerAddr</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>())
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
}

<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vald</span>.<span style=color:#a6e22e>NewValdClient</span>(<span style=color:#a6e22e>conn</span>)
</code></pre></div></details></li><li><p>Insert and Index</p><ul><li><p>Insert and Indexing 400 training datasets to the Vald agent.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ids</span> [:<span style=color:#a6e22e>insertCount</span>] {
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Inserted %d&#34;</span>, <span style=color:#a6e22e>i</span>)
    }
    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Insert</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Object_Vector</span>{
        <span style=color:#a6e22e>Id</span>: <span style=color:#a6e22e>ids</span>[<span style=color:#a6e22e>i</span>],
        <span style=color:#a6e22e>Vector</span>: <span style=color:#a6e22e>train</span>[<span style=color:#a6e22e>i</span>],
    })
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
    }
}
</code></pre></div></details></li><li><p>Wait until indexing finish.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>wt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>indexingWaitSeconds</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
<span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Wait %s for indexing to finish&#34;</span>, <span style=color:#a6e22e>wt</span>)
<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>wt</span>)
</code></pre></div></details></li></ul></li><li><p>Search</p><ul><li><p>Search 10 neighbor vectors for each 20 test datasets and return list of neighbor vector.</p></li><li><p>When getting approximate vectors, the Vald client sends search config and vector to the server via gRPC.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Start search %d times&#34;</span>, <span style=color:#a6e22e>testCount</span>)
<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>vec</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>test</span>[:<span style=color:#a6e22e>testCount</span>] {
    <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Search</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Search_Request</span>){
        <span style=color:#a6e22e>Vector</span>: <span style=color:#a6e22e>vec</span>,
        <span style=color:#a6e22e>Config</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Search_Config</span>{
            <span style=color:#a6e22e>Num</span>: <span style=color:#ae81ff>10</span>,
            <span style=color:#a6e22e>Radius</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
            <span style=color:#a6e22e>Epsilon</span>: <span style=color:#ae81ff>0.01</span>,
        }
    }
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
    }

    <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalIndent</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>GetResults</span>(), <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34; &#34;</span>)
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;%d - Results : %s\n\n&#34;</span>, <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, string(<span style=color:#a6e22e>b</span>))
    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
}
</code></pre></div></details></li></ul></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># run example</span>
go run main.go
</code></pre></div></li><li><p>Cleanup</p><p>Remove the Vald pods by executing:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm uninstall vald
</code></pre></div></li></ol><h2 id=deploy-and-run-standalone-vald-agent-on-kubernetes>Deploy and Run standalone Vald Agent on kubernetes</h2><h3 id=deploy-1>Deploy</h3><p>This chapter will show you how to deploy a standalone Vald Agent using Helm and run it on your kubernetes cluster.<br>This chapter uses <a href=https://github.com/yahoojapan/ngt>NGT</a> as Vald Agent to perform vector insertion operation, indexing and searching operations.<br></p><ol><li><p>Confirm which cluster to deploy</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl cluster-info
</code></pre></div></li><li><p>Deploy Vald Agent using helm</p><p>There is the <a href=https://github.com/vdaas/vald/blob/master/example/helm/values-standalone-agent-ngt.yaml>values.yaml</a> to deploy standalone Vald Agent.
Each component can be disabled by setting the value <code>false</code> to the <code>[component].enabled</code> field.
This is useful for deploying standalone Vald Agent NGT pods.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm repo add vald https://vald.vdaas.org/charts
helm install --values example/helm/values-standalone-agent-ngt.yaml vald-agent-ngt vald/vald
</code></pre></div></li><li><p>Verify</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pods
</code></pre></div><details><summary>Example output</summary><br>If the deployment is successful, Vald Agent component should be running.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAME               READY   STATUS    RESTARTS   AGE
vald-agent-ngt-0   1/1     Running   <span style=color:#ae81ff>0</span>          20m
vald-agent-ngt-1   1/1     Running   <span style=color:#ae81ff>0</span>          20m
vald-agent-ngt-2   1/1     Running   <span style=color:#ae81ff>0</span>          20m
vald-agent-ngt-3   1/1     Running   <span style=color:#ae81ff>0</span>          20m
</code></pre></div></details></li></ol><h3 id=run-using-example-code-1>Run using example code</h3><ol><li><p>Port Forward</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl port-forward service/vald-agent-ngt 8081:8081
</code></pre></div></li><li><p>Download dataset</p><p>In this tutorial. we use <a href=https://github.com/zalandoresearch/fashion-mnist>fashion-mnist</a> as a dataset for indexing and search query.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># move to working directory</span>
cd example/client/agent

<span style=color:#75715e># download fashion-mnist testing dataset</span>
wget http://ann-benchmarks.com/fashion-mnist-784-euclidean.hdf5
</code></pre></div></li><li><p>Running example</p><p>Vald provides multiple languages client library such as Go, Java, Node.js, Python and so on.<br>In this example, the fashion-mnist dataset will insert into the Vald and search using <a href=https://github.com/vdaas/vald-client-go>vald-client-go</a>.</p><p>We use <a href=https://github.com/vdaas/vald/blob/master/example/client/agent/main.go><code>example/client/agent/main.go</code></a> to run the example.
This will execute 4 steps.</p><ol><li><p>init</p><ul><li><p>Import packages</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;context&#34;</span>
    <span style=color:#e6db74>&#34;encoding/json&#34;</span>
    <span style=color:#e6db74>&#34;flag&#34;</span>
    <span style=color:#e6db74>&#34;time&#34;</span>

    <span style=color:#e6db74>&#34;github.com/kpango/fuid&#34;</span>
    <span style=color:#e6db74>&#34;github.com/kpango/glg&#34;</span>
    <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/agent&#34;</span>
    <span style=color:#e6db74>&#34;github.com/vdaas/vald-client-go/payload&#34;</span>

    <span style=color:#e6db74>&#34;gonum.org/v1/hdf5&#34;</span>
    <span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
)
</code></pre></div></details></li><li><p>Set variables</p><ul><li><p>The constant number of training datasets and test datasets.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>const</span> (
    <span style=color:#a6e22e>insertCount</span> = <span style=color:#ae81ff>400</span>
    <span style=color:#a6e22e>testCount</span> = <span style=color:#ae81ff>20</span>
)
</code></pre></div></details></li><li><p>The variables for configuration.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>const</span> (
    <span style=color:#a6e22e>datasetPath</span>         <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>grpcServerAddr</span>      <span style=color:#66d9ef>string</span>
    <span style=color:#a6e22e>indexingWaitSeconds</span> <span style=color:#66d9ef>uint</span>
)
</code></pre></div></details></li></ul></li><li><p>Recognition parameters.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>datasetPath</span>, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#e6db74>&#34;fashion-mnist-784-euclidean.hdf5&#34;</span>, <span style=color:#e6db74>&#34;set dataset path&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>grpcServerAddr</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;127.0.0.1:8081&#34;</span>, <span style=color:#e6db74>&#34;set gRPC server address&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>UintVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>indexingWaitSeconds</span>, <span style=color:#e6db74>&#34;wait&#34;</span>, <span style=color:#ae81ff>60</span>, <span style=color:#e6db74>&#34;set indexing wait seconds&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
}
</code></pre></div></details></li></ul></li><li><p>load</p><ul><li><p>Loading from fashion-mnist dataset and set id for each vector that is loaded. This step will return the training dataset, test dataset, and ids list of ids when loading is completed with success.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ids</span>, <span style=color:#a6e22e>train</span>, <span style=color:#a6e22e>test</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>datasetPath</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
}
</code></pre></div></details></li></ul></li><li><p>Create the gRPC connection and Vald client with gRPC connection.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()

<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>grpcServerAddr</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>())
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
}

<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>agent</span>.<span style=color:#a6e22e>NewAgentClient</span>(<span style=color:#a6e22e>conn</span>)
</code></pre></div></details></li><li><p>Insert and Index</p><ul><li><p>Insert and Indexing 400 training datasets to the Vald agent.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ids</span> [:<span style=color:#a6e22e>insertCount</span>] {
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span><span style=color:#f92672>%</span><span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Inserted %d&#34;</span>, <span style=color:#a6e22e>i</span>)
    }
    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Insert</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Object_Vector</span>{
        <span style=color:#a6e22e>Id</span>: <span style=color:#a6e22e>ids</span>[<span style=color:#a6e22e>i</span>],
        <span style=color:#a6e22e>Vector</span>: <span style=color:#a6e22e>train</span>[<span style=color:#a6e22e>i</span>],
    })
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
    }
}
</code></pre></div></details></li><li><p>Wait until indexing finish.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>wt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>indexingWaitSeconds</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
<span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Wait %s for indexing to finish&#34;</span>, <span style=color:#a6e22e>wt</span>)
<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>wt</span>)
</code></pre></div></details></li><li><p>[Optional] Indexing manually instead of waiting for auto indexing
You can set Agent NGT configuration <code>auto_index_duration_limit</code> and <code>auto_index_check_duration</code> for auto indexing.
In this example, you can create index manually using <code>CreateIndex()</code> mthod in the client library.
<detail><summary>example code</summary><br></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CreateIndex</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Control_CreateIndexRequest</span>{
    <span style=color:#a6e22e>PoolSize</span>: uint32(<span style=color:#a6e22e>insertCount</span>),
})
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
}
</code></pre></div></detail></li></ul></li><li><p>Search</p><ul><li><p>Search 10 neighbor vectors for each 20 test datasets and return list of neighbor vector.</p></li><li><p>When getting approximate vectors, the Vald client sends search config and vector to the server via gRPC.</p><details><summary>example code</summary><br><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Start search %d times&#34;</span>, <span style=color:#a6e22e>testCount</span>)
<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>vec</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>test</span>[:<span style=color:#a6e22e>testCount</span>] {
    <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Search</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Search_Request</span>){
        <span style=color:#a6e22e>Vector</span>: <span style=color:#a6e22e>vec</span>,
        <span style=color:#a6e22e>Config</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Search_Config</span>{
            <span style=color:#a6e22e>Num</span>: <span style=color:#ae81ff>10</span>,
            <span style=color:#a6e22e>Radius</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
            <span style=color:#a6e22e>Epsilon</span>: <span style=color:#ae81ff>0.01</span>,
        }
    }
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
    }

    <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalIndent</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>GetResults</span>(), <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34; &#34;</span>)
    <span style=color:#a6e22e>glg</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;%d - Results : %s\n\n&#34;</span>, <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, string(<span style=color:#a6e22e>b</span>))
    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
}
</code></pre></div></details></li></ul></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># run example</span>
go run main.go
</code></pre></div></li><li><p>Cleanup</p><p>Remove the Vald Agent pods by executing:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm uninstall vald-agent-ngt
</code></pre></div></li></ol></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#requirements>Requirements</a></li><li><a href=#deploy-and-run-vald-on-kubernetes>Deploy and Run Vald on kubernetes</a><ul><li><a href=#deploy>Deploy</a></li><li><a href=#run-using-example-code>Run using example code</a></li></ul></li><li><a href=#deploy-and-run-standalone-vald-agent-on-kubernetes>Deploy and Run standalone Vald Agent on kubernetes</a><ul><li><a href=#deploy-1>Deploy</a></li><li><a href=#run-using-example-code-1>Run using example code</a></li></ul></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=https://vald.netlify.app/docs/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=https://vald.netlify.app/docs/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=https://medium.com/@vdaas_vald target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a href=https://github.com/vdaas/vald target=_blank class="footer__link footer__link--button">Github<br></a></li></ul></div><p class=footer__copylight>Â©2019-2020 vald.vdaas.org Vald team</p></footer></body></html>