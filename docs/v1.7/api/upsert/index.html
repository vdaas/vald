<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Upsert</title>
<meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Upsert"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.7/api/upsert/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt>
</picture></a><a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.7/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.7/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.7/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.7 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.7</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.9</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.7/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.7/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/v1.7/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.7/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/v1.7/overview/component/lb-gateway/>Lb Gateway</a></li><li class=index><a href=/docs/v1.7/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.7/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/v1.7/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.7/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/v1.7/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/v1.7/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.7/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.7/user-guides/configuration/>Configuration</a></li><li class=index><a href=/docs/v1.7/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/v1.7/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/v1.7/user-guides/cluster-role-binding/>Cluster Role Binding</a></li><li class=index><a href=/docs/v1.7/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/v1.7/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/v1.7/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/v1.7/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/v1.7/user-guides/client-api-config/>Client Api Config</a></li><li class=index><a href=/docs/v1.7/user-guides/network-policy/>Network Policy</a></li><li class=index><a href=/docs/v1.7/user-guides/index-correction/>Index Correction</a></li><li class=index><a href=/docs/v1.7/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/v1.7/user-guides/observability-configuration/>Observability Configuration</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.7/performance/loadtest/>Loadtest</a></li><li class=index><a href=/docs/v1.7/performance/benchmark/>Benchmark</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/v1.7/api/insert/>Insert</a></li><li class=index><a href=/docs/v1.7/api/update/>Update</a></li><li class=view><a href=/docs/v1.7/api/upsert/>Upsert</a></li><li class=index><a href=/docs/v1.7/api/search/>Search</a></li><li class=index><a href=/docs/v1.7/api/remove/>Remove</a></li><li class=index><a href=/docs/v1.7/api/object/>Object</a></li><li class=index><a href=/docs/v1.7/api/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.7/api/status/>Status</a></li><li class=index><a href=/docs/v1.7/api/build_proto/>Build Proto</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/v1.7/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/v1.7/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.7/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.7/contributing/development/>Development</a></li><li class=index><a href=/docs/v1.7/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/v1.7/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.7/support/contacts/>Contacts</a></li><li class=index><a href=/docs/v1.7/support/faq/>Faq</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/v1.7/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=vald-upsert-apis>Vald Upsert APIs</h1><h2 id=overview>Overview</h2><p>Upsert Service is responsible for updating existing vectors in the <code>vald-agent</code> or inserting new vectors into the <code>vald-agent</code> if the vector does not exist.</p><pre tabindex=0><code class=language-rpc data-lang=rpc>service Upsert {

  rpc Upsert(payload.v1.Upsert.Request)
      returns (payload.v1.Object.Location) {}

  rpc StreamUpsert(stream payload.v1.Upsert.Request)
      returns (stream payload.v1.Object.StreamLocation) {}

  rpc MultiUpsert(payload.v1.Upsert.MultiRequest)
      returns (payload.v1.Object.Locations) {}
}
</code></pre><h2 id=upsert-rpc>Upsert RPC</h2><p>Upsert RPC is the method to update the inserted vector to a new single vector or add a new single vector if not inserted before.</p><h3 id=input>Input</h3><ul><li><p>the scheme of <code>payload.v1.Upsert.Request</code></p><pre tabindex=0><code class=language-rpc data-lang=rpc>message Upsert {
  message Request {
    Object.Vector vector = 1 [ (validate.rules).repeated .min_items = 2 ];
    Config config = 2;
  }

  message Config {
    bool skip_strict_exist_check = 1;
    Filter.Config filters = 2;
    int64 timestamp = 3;
  }
}

message Object {
    message Vector {
        string id = 1 [ (validate.rules).string.min_len = 1 ];
        repeated float vector = 2 [ (validate.rules).repeated .min_items = 2 ];
    }
}
</code></pre><ul><li><p>Upsert.Request</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>vector</td><td style=text-align:left>Object.Vector</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The information of vector.</td></tr><tr><td style=text-align:center>config</td><td style=text-align:left>Config</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The configuration of the update request.</td></tr></tbody></table></li><li><p>Upsert.Config</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>skip_strict_exist_check</td><td style=text-align:left>bool</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>Check whether the same vector is already inserted or not.<br>The ID should be unique if the value is <code>true</code>.</td></tr><tr><td style=text-align:center>timestamp</td><td style=text-align:left>int64</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>The timestamp of the vector inserted.<br>If it is N/A, the current time will be used.</td></tr><tr><td style=text-align:center>filters</td><td style=text-align:left>Filter.Config</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>Configuration for filter.</td></tr><tr><td style=text-align:center>disable_balanced_update</td><td style=text-align:left>bool</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>A flag to disable balanced update (split remove -> insert operation) during update operation.</td></tr></tbody></table></li><li><p>Object.Vector</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>id</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The ID of a vector. ID should consist of 1 or more characters.</td></tr><tr><td style=text-align:center>vector</td><td style=text-align:left>float</td><td style=text-align:left>repeated(Array[float])</td><td style=text-align:center>*</td><td style=text-align:left>The vector data. Its dimension is between 2 and 65,536.</td></tr></tbody></table></li></ul></li></ul><h3 id=output>Output</h3><ul><li><p>the scheme of <code>payload.v1.Object.Location</code></p><pre tabindex=0><code class=language-rpc data-lang=rpc>message Object {
    message Location {
      string name = 1;
      string uuid = 2;
      repeated string ips = 3;
    }
}
</code></pre><ul><li>Object.Location<table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>name</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>The name of vald agent pod where the request vector is updated/inserted.</td></tr><tr><td style=text-align:center>uuid</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>The ID of the updated/inserted vector. It is the same as an <code>Object.Vector</code>.</td></tr><tr><td style=text-align:center>ips</td><td style=text-align:left>string</td><td style=text-align:left>repeated(Array[string])</td><td style=text-align:left>The IP list of <code>vald-agent</code> pods where the request vector is updated/inserted.</td></tr></tbody></table></li></ul></li></ul><h3 id=status-code>Status Code</h3><table><thead><tr><th style=text-align:center>code</th><th style=text-align:left>name</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:left>OK</td></tr><tr><td style=text-align:center>1</td><td style=text-align:left>CANCELLED</td></tr><tr><td style=text-align:center>3</td><td style=text-align:left>INVALID_ARGUMENT</td></tr><tr><td style=text-align:center>4</td><td style=text-align:left>DEADLINE_EXCEEDED</td></tr><tr><td style=text-align:center>6</td><td style=text-align:left>ALREADY_EXISTS</td></tr><tr><td style=text-align:center>13</td><td style=text-align:left>INTERNAL</td></tr></tbody></table><p>Please refer to <a href=./status>Response Status Code</a> for more details.</p><h3 id=troubleshooting>Troubleshooting</h3><p>The request process may not be completed when the response code is NOT <code>0 (OK)</code>.</p><p>Here are some common reasons and how to resolve each error.</p><table><thead><tr><th style=text-align:left>name</th><th style=text-align:left>common reason</th><th style=text-align:left>how to resolve</th></tr></thead><tbody><tr><td style=text-align:left>CANCELLED</td><td style=text-align:left>Executed cancel() of rpc from client/server-side or network problems between client and server.</td><td style=text-align:left>Check the code, especially around timeout and connection management, and fix if needed.</td></tr><tr><td style=text-align:left>INVALID_ARGUMENT</td><td style=text-align:left>The Dimension of the request vector is NOT the same as Vald Agent&rsquo;s config, the requested vector&rsquo;s ID is empty, or some request payload is invalid.</td><td style=text-align:left>Check Agent config, request payload, and fix request payload or Agent config.</td></tr><tr><td style=text-align:left>DEADLINE_EXCEEDED</td><td style=text-align:left>The RPC timeout setting is too short on the client/server side.</td><td style=text-align:left>Check the gRPC timeout setting on both the client and server sides and fix it if needed.</td></tr><tr><td style=text-align:left>ALREADY_EXISTS</td><td style=text-align:left>Requested pair of ID and vector is already inserted</td><td style=text-align:left>Change request payload or nothing to do if update is unnecessary.</td></tr><tr><td style=text-align:left>INTERNAL</td><td style=text-align:left>Target Vald cluster or network route has some critical error.</td><td style=text-align:left>Check target Vald cluster first and check network route including ingress as second.</td></tr></tbody></table><h2 id=streamupsert-rpc>StreamUpsert RPC</h2><p>StreamUpsert RPC is the method to update multiple existing vectors or add new multiple vectors using the <a href=https://grpc.io/docs/what-is-grpc/core-concepts/#bidirectional-streaming-rpc>bidirectional streaming RPC</a>.<br>Using the bidirectional streaming RPC, the upsert request can be communicated in any order between the client and server.
Each Upsert request and response are independent.
It’s the recommended method to upsert a large number of vectors.</p><h3 id=input-1>Input</h3><ul><li><p>the scheme of <code>payload.v1.Upsert.Request stream</code></p><pre tabindex=0><code class=language-rpc data-lang=rpc>message Upsert {
    message Request {
        Object.Vector vector = 1 [ (validate.rules).repeated .min_items = 2 ];
        Config config = 2;
    }
    message Config {
        bool skip_strict_exist_check = 1;
        Filter.Config filters = 2;
        int64 timestamp = 3;
    }
}

message Object {
    message Vector {
        string id = 1 [ (validate.rules).string.min_len = 1 ];
        repeated float vector = 2 [ (validate.rules).repeated .min_items = 2 ];
    }
}
</code></pre><ul><li><p>Upsert.Request</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>vector</td><td style=text-align:left>Object.Vector</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The information of vector.</td></tr><tr><td style=text-align:center>config</td><td style=text-align:left>Config</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The configuration of the update request.</td></tr></tbody></table></li><li><p>Upsert.Config</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>skip_strict_exist_check</td><td style=text-align:left>bool</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>Check whether the same vector is already inserted or not.<br>The ID should be unique if the value is <code>true</code>.</td></tr><tr><td style=text-align:center>timestamp</td><td style=text-align:left>int64</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>The timestamp of the vector inserted.<br>If it is N/A, the current time will be used.</td></tr><tr><td style=text-align:center>filters</td><td style=text-align:left>Filter.Config</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>Configuration for filter.</td></tr><tr><td style=text-align:center>disable_balanced_update</td><td style=text-align:left>bool</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>A flag to disable balanced update (split remove -> insert operation) during update operation.</td></tr></tbody></table></li><li><p>Object.Vector</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>id</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The ID of a vector. ID should consist of 1 or more characters.</td></tr><tr><td style=text-align:center>vector</td><td style=text-align:left>float</td><td style=text-align:left>repeated(Array[float])</td><td style=text-align:center>*</td><td style=text-align:left>The vector data. Its dimension is between 2 and 65,536.</td></tr></tbody></table></li></ul></li></ul><h3 id=output-1>Output</h3><ul><li><p>the scheme of <code>payload.v1.Object.StreamLocation</code></p><pre tabindex=0><code class=language-rpc data-lang=rpc>message Object {
    message StreamLocation {
      oneof payload {
          Location location = 1;
          google.rpc.Status status = 2;
      }
    }

    message Location {
      string name = 1;
      string uuid = 2;
      repeated string ips = 3;
    }
}
</code></pre><ul><li><p>Object.StreamLocation</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>location</td><td style=text-align:left>Object.Location</td><td style=text-align:left></td><td style=text-align:left>The information of Object.Location data.</td></tr><tr><td style=text-align:center>status</td><td style=text-align:left>google.rpc.Status</td><td style=text-align:left></td><td style=text-align:left>The status of Google RPC.</td></tr></tbody></table></li><li><p>Object.Location</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>name</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>The name of vald agent pod where the request vector is updated/inserted.</td></tr><tr><td style=text-align:center>uuid</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>The ID of the updated/inserted vector. It is the same as an <code>Object.Vector</code>.</td></tr><tr><td style=text-align:center>ips</td><td style=text-align:left>string</td><td style=text-align:left>repeated(Array[string])</td><td style=text-align:left>The IP list of <code>vald-agent</code> pods where the request vector is updated/inserted.</td></tr></tbody></table></li><li><p><a href=https://github.com/googleapis/googleapis/blob/master/google/rpc/status.proto>google.rpc.Status</a></p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>code</td><td style=text-align:left>int32</td><td style=text-align:left></td><td style=text-align:left>Status code (code list is next section)</td></tr><tr><td style=text-align:center>message</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>Error message</td></tr><tr><td style=text-align:center>details</td><td style=text-align:left>google.protobuf.Any</td><td style=text-align:left>repeated(Array[any])</td><td style=text-align:left>The details error message list</td></tr></tbody></table></li></ul></li></ul><h3 id=status-code-1>Status Code</h3><table><thead><tr><th style=text-align:center>code</th><th style=text-align:left>name</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:left>OK</td></tr><tr><td style=text-align:center>1</td><td style=text-align:left>CANCELLED</td></tr><tr><td style=text-align:center>3</td><td style=text-align:left>INVALID_ARGUMENT</td></tr><tr><td style=text-align:center>4</td><td style=text-align:left>DEADLINE_EXCEEDED</td></tr><tr><td style=text-align:center>6</td><td style=text-align:left>ALREADY_EXISTS</td></tr><tr><td style=text-align:center>13</td><td style=text-align:left>INTERNAL</td></tr></tbody></table><p>Please refer to <a href=./status>Response Status Code</a> for more details.</p><h3 id=troubleshooting-1>Troubleshooting</h3><p>The request process may not be completed when the response code is NOT <code>0 (OK)</code>.</p><p>Here are some common reasons and how to resolve each error.</p><table><thead><tr><th style=text-align:left>name</th><th style=text-align:left>common reason</th><th style=text-align:left>how to resolve</th></tr></thead><tbody><tr><td style=text-align:left>CANCELLED</td><td style=text-align:left>Executed cancel() of rpc from client/server-side or network problems between client and server.</td><td style=text-align:left>Check the code, especially around timeout and connection management, and fix if needed.</td></tr><tr><td style=text-align:left>INVALID_ARGUMENT</td><td style=text-align:left>The Dimension of the request vector is NOT the same as Vald Agent&rsquo;s config, the requested vector&rsquo;s ID is empty, or some request payload is invalid.</td><td style=text-align:left>Check Agent config, request payload, and fix request payload or Agent config.</td></tr><tr><td style=text-align:left>DEADLINE_EXCEEDED</td><td style=text-align:left>The RPC timeout setting is too short on the client/server side.</td><td style=text-align:left>Check the gRPC timeout setting on both the client and server sides and fix it if needed.</td></tr><tr><td style=text-align:left>ALREADY_EXISTS</td><td style=text-align:left>Requested pair of ID and vector is already inserted</td><td style=text-align:left>Change request payload or nothing to do if update is unnecessary.</td></tr><tr><td style=text-align:left>INTERNAL</td><td style=text-align:left>Target Vald cluster or network route has some critical error.</td><td style=text-align:left>Check target Vald cluster first and check network route including ingress as second.</td></tr></tbody></table><h2 id=multiupsert-rpc>MultiUpsert RPC</h2><p>MultiUpsert is the method to update existing multiple vectors and add new multiple vectors in <strong>1</strong> request.</p><div class=notice>gRPC has a message size limitation.<br>Please be careful that the size of the request exceeds the limit.</div><h3 id=input-2>Input</h3><ul><li><p>the scheme of <code>payload.v1.Upsert.MultiRequest</code></p><pre tabindex=0><code class=language-rpc data-lang=rpc>message Upsert {
    message MultiRequest { repeated Request requests = 1; }

    message Request {
        Object.Vector vector = 1 [ (validate.rules).repeated .min_items = 2 ];
        Config config = 2;
    }

    message Config {
        bool skip_strict_exist_check = 1;
        Filter.Config filters = 2;
        int64 timestamp = 3;
    }
}

message Object {
    message Vector {
        string id = 1 [ (validate.rules).string.min_len = 1 ];
        repeated float vector = 2 [ (validate.rules).repeated .min_items = 2 ];
    }
}
</code></pre><ul><li><p>Upsert.MultiRequest</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>requests</td><td style=text-align:left>Upsert.Request</td><td style=text-align:left>repeated(Array[Insert.Request])</td><td style=text-align:center>*</td><td style=text-align:left>The request list.</td></tr></tbody></table></li><li><p>Upsert.Request</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>vector</td><td style=text-align:left>Object.Vector</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The information of vector.</td></tr><tr><td style=text-align:center>config</td><td style=text-align:left>Config</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The configuration of the update request.</td></tr></tbody></table></li><li><p>Upsert.Config</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>skip_strict_exist_check</td><td style=text-align:left>bool</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>Check whether the same vector is already inserted or not.<br>The ID should be unique if the value is <code>true</code>.</td></tr><tr><td style=text-align:center>timestamp</td><td style=text-align:left>int64</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>The timestamp of the vector inserted.<br>If it is N/A, the current time will be used.</td></tr><tr><td style=text-align:center>filters</td><td style=text-align:left>Filter.Config</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>Configuration for filter.</td></tr><tr><td style=text-align:center>disable_balanced_update</td><td style=text-align:left>bool</td><td style=text-align:left></td><td style=text-align:center></td><td style=text-align:left>A flag to disable balanced update (split remove -> insert operation) during update operation.</td></tr></tbody></table></li><li><p>Object.Vector</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:center>required</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>id</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:center>*</td><td style=text-align:left>The ID of a vector. ID should consist of 1 or more characters.</td></tr><tr><td style=text-align:center>vector</td><td style=text-align:left>float</td><td style=text-align:left>repeated(Array[float])</td><td style=text-align:center>*</td><td style=text-align:left>The vector data. Its dimension is between 2 and 65,536.</td></tr></tbody></table></li></ul></li></ul><h3 id=output-2>Output</h3><ul><li><p>the scheme of <code>payload.v1.Object.Locations</code>.</p><pre tabindex=0><code class=language-rpc data-lang=rpc>message Object {
    message Locations { repeated Location locations = 1; }

    message Location {
      string name = 1;
      string uuid = 2;
      repeated string ips = 3;
    }
}
</code></pre><ul><li><p>Object.Locations</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>location</td><td style=text-align:left>Object.Location</td><td style=text-align:left>repeated(Array[Object.Location])</td><td style=text-align:left>The list of <code>Object.Location</code>.</td></tr></tbody></table></li><li><p>Object.Location</p><table><thead><tr><th style=text-align:center>field</th><th style=text-align:left>type</th><th style=text-align:left>label</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td style=text-align:center>name</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>The name of vald agent pod where the request vector is updated/inserted.</td></tr><tr><td style=text-align:center>uuid</td><td style=text-align:left>string</td><td style=text-align:left></td><td style=text-align:left>The ID of the updated/inserted vector. It is the same as an <code>Object.Vector</code>.</td></tr><tr><td style=text-align:center>ips</td><td style=text-align:left>string</td><td style=text-align:left>repeated(Array[string])</td><td style=text-align:left>The IP list of <code>vald-agent</code> pods where the request vector is updated/inserted.</td></tr></tbody></table></li></ul></li></ul><h3 id=status-code-2>Status Code</h3><table><thead><tr><th style=text-align:center>code</th><th style=text-align:left>name</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:left>OK</td></tr><tr><td style=text-align:center>1</td><td style=text-align:left>CANCELLED</td></tr><tr><td style=text-align:center>3</td><td style=text-align:left>INVALID_ARGUMENT</td></tr><tr><td style=text-align:center>4</td><td style=text-align:left>DEADLINE_EXCEEDED</td></tr><tr><td style=text-align:center>6</td><td style=text-align:left>ALREADY_EXISTS</td></tr><tr><td style=text-align:center>13</td><td style=text-align:left>INTERNAL</td></tr></tbody></table><p>Please refer to <a href=./status>Response Status Code</a> for more details.</p><h3 id=troubleshooting-2>Troubleshooting</h3><p>The request process may not be completed when the response code is NOT <code>0 (OK)</code>.</p><p>Here are some common reasons and how to resolve each error.</p><table><thead><tr><th style=text-align:left>name</th><th style=text-align:left>common reason</th><th style=text-align:left>how to resolve</th></tr></thead><tbody><tr><td style=text-align:left>CANCELLED</td><td style=text-align:left>Executed cancel() of rpc from client/server-side or network problems between client and server.</td><td style=text-align:left>Check the code, especially around timeout and connection management, and fix if needed.</td></tr><tr><td style=text-align:left>INVALID_ARGUMENT</td><td style=text-align:left>The Dimension of the request vector is NOT the same as Vald Agent&rsquo;s config, the requested vector&rsquo;s ID is empty, or some request payload is invalid.</td><td style=text-align:left>Check Agent config, request payload, and fix request payload or Agent config.</td></tr><tr><td style=text-align:left>DEADLINE_EXCEEDED</td><td style=text-align:left>The RPC timeout setting is too short on the client/server side.</td><td style=text-align:left>Check the gRPC timeout setting on both the client and server sides and fix it if needed.</td></tr><tr><td style=text-align:left>ALREADY_EXISTS</td><td style=text-align:left>Requested pair of ID and vector is already inserted</td><td style=text-align:left>Change request payload or nothing to do if update is unnecessary.</td></tr><tr><td style=text-align:left>INTERNAL</td><td style=text-align:left>Target Vald cluster or network route has some critical error.</td><td style=text-align:left>Check target Vald cluster first and check network route including ingress as second.</td></tr></tbody></table></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#upsert-rpc>Upsert RPC</a><ul><li><a href=#input>Input</a></li><li><a href=#output>Output</a></li><li><a href=#status-code>Status Code</a></li><li><a href=#troubleshooting>Troubleshooting</a></li></ul></li><li><a href=#streamupsert-rpc>StreamUpsert RPC</a><ul><li><a href=#input-1>Input</a></li><li><a href=#output-1>Output</a></li><li><a href=#status-code-1>Status Code</a></li><li><a href=#troubleshooting-1>Troubleshooting</a></li></ul></li><li><a href=#multiupsert-rpc>MultiUpsert RPC</a><ul><li><a href=#input-2>Input</a></li><li><a href=#output-2>Output</a></li><li><a href=#status-code-2>Status Code</a></li><li><a href=#troubleshooting-2>Troubleshooting</a></li></ul></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.7/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.7/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.7/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.7 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>©2019-2023 vald.vdaas.org Vald team</p></footer></body></html>