<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-F9Y0YKG55S"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F9Y0YKG55S")</script><link rel=canonical href=https://vald.vdaas.org><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=robots content="index, follow"><title>Vald | Backup Configuration</title><meta name=description content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine" }><meta name=format-detection content="telephone=no"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:type" content="article"><meta property="og:title" content="Vald | Backup Configuration"><meta property="og:description" content="Vald is high scalable distributed high-speed approximate nearest neighbor search engine"><meta property="og:url" content="https://vald.vdaas.org/docs/v1.7/user-guides/backup-configuration/"><meta property="og:image" content="https://vald.vdaas.org/images/ogp_vald.png"><meta property="og:site_name" content="vald"><meta property="og:locale" content="en_US"><meta property="fb:app_id" content="615732422350002"><meta name=twitter:site content="@vdaas_vald"><meta name=twitter:card content="app"><link rel="shortcut icon" href=https://vald.vdaas.org/favicon.ico><link rel=stylesheet type=text/css href=/css/style.min.css><link rel=stylesheet type=text/css href=/css/header.min.css><link rel=stylesheet type=text/css href=/css/footer.min.css><link rel=stylesheet type=text/css href=/css/main.min.css><script type=text/javascript src=/js/script.min.js defer></script><meta name=viewport content="target-densitydpi=device-dpi,width=device-width,maximum-scale=1,user-scalable=yes"></head><body><header class=header id=header><div class=header__content><nav class=header__nav><a href=https://vald.vdaas.org class=header-nav__link><picture class=header-nav__image><source srcset=https://vald.vdaas.org/images/vald_white.svg media="(prefers-color-scheme: dark)"><img src=https://vald.vdaas.org/images/vald_color_1.svg alt></picture></a>
<a class=header-nav__icon id=nav-btn><span class=header-nav__button></span></a><ul class=header__list id=menu><li class=header__item><a href=/docs/v1.7/overview/about-vald class=header__link>About</a></li><li class=header__item><a href=/docs/v1.7/tutorial/get-started class=header__link>Get Started</a></li><li class=header__item><a href=/docs/v1.7/user-guides/sdks class=header__link>SDKs</a></li><li class=header__item><a href=/docs/v1.7 class=header__link>Docs</a></li><li class=header__item><a href=https://vdaas-vald.medium.com/ target=_blank class=header__link>Blog<br></a></li><li class=header__item><details class=header__version id=version_details><summary class=version__current id=current_version>v1.7</summary><ul class=version__list><il class=version__item><a href=javascript:void(0) class="version__link version__link--latest">v1.7.8</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.7</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.6</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.5</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.4</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.3</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.2</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.1</a></il>
<il class=version__item><a href=javascript:void(0) class=version__link>v1.0</a></il></ul></details></li><li class=header__item><a class=header__git href=https://github.com/vdaas/vald target=_blank><picture class=git__logo><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" width=18 height=18><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github width=18 height=18></picture><div class=git__star><p class=git__starnum id=git-star-num></p></div></a></li></ul></nav></div></header><main role=main><div class=single><aside class=page><nav><ul id=list-body><li class=withchild id=cat_Overview>Overview<ul><li class=index><a href=/docs/v1.7/overview/about-vald/>About Vald</a></li><li class=index><a href=/docs/v1.7/overview/architecture/>Architecture</a></li><li class=index><a href=/docs/v1.7/overview/data-flow/>Data Flow</a></li></ul></li><li class=withchild id=cat_Component>Component<ul><li class=index><a href=/docs/v1.7/overview/component/agent/>Agent</a></li><li class=index><a href=/docs/v1.7/overview/component/lb-gateway/>Lb Gateway</a></li><li class=index><a href=/docs/v1.7/overview/component/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.7/overview/component/discoverer/>Discoverer</a></li><li class=index><a href=/docs/v1.7/overview/component/index-manager/>Index Manager</a></li></ul></li><li class=withchild id=cat_Tutorial>Tutorial<ul><li class=index><a href=/docs/v1.7/tutorial/get-started/>Get Started</a></li><li class=index><a href=/docs/v1.7/tutorial/vald-agent-standalone-on-k8s/>Vald Agent Standalone on K8s</a></li><li class=index><a href=/docs/v1.7/tutorial/vald-agent-standalone-on-docker/>Vald Agent Standalone on Docker</a></li></ul></li><li class=withchild id=cat_Usecase>Usecase<ul><li class=index><a href=/docs/v1.7/usecase/usage-example/>Usage Example</a></li></ul></li><li class=withchild id="cat_User Guides">User Guides<ul><li class=index><a href=/docs/v1.7/user-guides/configuration/>Configuration</a></li><li class=view><a href=/docs/v1.7/user-guides/backup-configuration/>Backup Configuration</a></li><li class=index><a href=/docs/v1.7/user-guides/filtering-configuration/>Filtering Configuration</a></li><li class=index><a href=/docs/v1.7/user-guides/cluster-role-binding/>Cluster Role Binding</a></li><li class=index><a href=/docs/v1.7/user-guides/deployment/>Deployment</a></li><li class=index><a href=/docs/v1.7/user-guides/operations/>Operations</a></li><li class=index><a href=/docs/v1.7/user-guides/upgrade-cluster/>Upgrade Cluster</a></li><li class=index><a href=/docs/v1.7/user-guides/capacity-planning/>Capacity Planning</a></li><li class=index><a href=/docs/v1.7/user-guides/client-api-config/>Client Api Config</a></li><li class=index><a href=/docs/v1.7/user-guides/network-policy/>Network Policy</a></li><li class=index><a href=/docs/v1.7/user-guides/sdks/>Sdks</a></li><li class=index><a href=/docs/v1.7/user-guides/observability-configuration/>Observability Configuration</a></li></ul></li><li class=withchild id=cat_Performance>Performance<ul><li class=index><a href=/docs/v1.7/performance/loadtest/>Loadtest</a></li><li class=index><a href=/docs/v1.7/performance/benchmark/>Benchmark</a></li></ul></li><li class=withchild id=cat_Api>API<ul><li class=index><a href=/docs/v1.7/api/insert/>Insert</a></li><li class=index><a href=/docs/v1.7/api/update/>Update</a></li><li class=index><a href=/docs/v1.7/api/upsert/>Upsert</a></li><li class=index><a href=/docs/v1.7/api/search/>Search</a></li><li class=index><a href=/docs/v1.7/api/remove/>Remove</a></li><li class=index><a href=/docs/v1.7/api/object/>Object</a></li><li class=index><a href=/docs/v1.7/api/filter-gateway/>Filter Gateway</a></li><li class=index><a href=/docs/v1.7/api/status/>Status</a></li><li class=index><a href=/docs/v1.7/api/build_proto/>Build Proto</a></li></ul></li><li class=withchild id=cat_Troubleshooting>Troubleshooting<ul><li class=index><a href=/docs/v1.7/troubleshooting/provisioning/>Provisioning</a></li><li class=index><a href=/docs/v1.7/troubleshooting/client-side/>Client Side</a></li></ul></li><li class=withchild id=cat_Contributing>Contributing<ul><li class=index><a href=/docs/v1.7/contributing/contributing-guide/>Contributing Guide</a></li><li class=index><a href=/docs/v1.7/contributing/development/>Development</a></li><li class=index><a href=/docs/v1.7/contributing/coding-style/>Coding Style</a></li><li class=index><a href=/docs/v1.7/contributing/unit-test-guideline/>Unit Test Guideline</a></li></ul></li><li class=withchild id=cat_Support>Support<ul><li class=index><a href=/docs/v1.7/support/contacts/>Contacts</a></li><li class=index><a href=/docs/v1.7/support/faq/>Faq</a></li></ul></li><li class=withchild id=cat_Release>Release<ul><li class=index><a href=/docs/v1.7/release/changelog/>Changelog</a></li></ul></li></ul></nav></aside><div class=content><div class=markdown id=markdown><h1 id=backup-configuration>Backup configuration</h1><p>There are three types of options for the Vald cluster: backup, filtering, and core algorithms.</p><p>This page describes how to enable the backup feature on your Vald cluster.</p><h2 id=what-is-the-backup>What is the backup</h2><p>Vald&rsquo;s backup function is to save the index data in each Vald Agent pod as a data file to the Persistent Volume or S3.
When the Vald Agent pod is restarted for some reason, the index state is restored from the saved index data.</p><h2 id=backup-methods>Backup methods</h2><p>You can choose one of three types of backup methods.</p><ul><li>PV (recommended)</li><li>S3</li><li>PV + S3</li></ul><p>Please refer to the following tables and decide which method fit for your case.</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left>PV</th><th style=text-align:left>S3</th><th style=text-align:left>PV+S3</th></tr></thead><tbody><tr><td style=text-align:left>usecase</td><td style=text-align:left>Want to use backup with low cost<br>Would not like to use some external storage for backup<br>Want to backup with highly compatible storage with Kubernetes</td><td style=text-align:left>Want to use the same backup file with several Vald clusters<br>Want to access the backup files easily</td><td style=text-align:left>Want to use backup with PV basically and access the backup files easily<br>Want to prevent backup file failure due to Kubernetes cluster failure</td></tr><tr><td style=text-align:left>pros üëç</td><td style=text-align:left>Easy to use<br>Highly compatible with Kubernetes<br>Low latency using in-cluster network<br>Safety backup using Copy on Write option</td><td style=text-align:left>Easy to access backup files<br>It can be shared and used by multiple clusters</td><td style=text-align:left>The safest of these methods</td></tr><tr><td style=text-align:left>cons üëé</td><td style=text-align:left>A bit hard to check backup files<br>Can not share backup files for several Vald clusters</td><td style=text-align:left>Need to communicate with external network</td><td style=text-align:left>Need to operate both storages<br>The most expensive way</td></tr></tbody></table><h2 id=backup-configuration-1>Backup configuration</h2><p>This section shows the best practice for configuring backup features with PV, S3, or PV + S3.</p><p>Each sample configuration yaml is published on <a href=https://github.com/vdaas/vald/tree/master/charts/vald/values>here</a>.
Please refer it for more details.</p><h3 id=general>General</h3><p>Regardless of the backup destination, the following Vald Agent settings must be set to enable backup.</p><ul><li><code>agent.ngt.index_path</code> is the location where those files are stored.</li><li><code>agent.ngt.in-memory-mode=false</code> means storing index files in the local volume.</li></ul><p>In addition, <code>agent.terminationGracePeriodSeconds</code> value should be long enough to ensure the backup speed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># We recommend setting this value long enough to ensure the backup speed of PV, since the Index is backed up at the end of the pod.</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ngt</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>index_path</span>: <span style=color:#e6db74>&#34;/var/ngt/index&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enable_in_memory_mode</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><h3 id=persistent-volume>Persistent Volume</h3><h4 id=requirement>requirement</h4><p>You must prepare PV before deployment when using Kubernetes Persistent Volume (PV) for backup storage.
Please refer to the setup guide of the usage environment for the provisioning PV.</p><p>For example:</p><ul><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/persistent-volumes>GKE setup PV document</a></li><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/storage.html>EKS storage document</a></li></ul><h4 id=configuration>configuration</h4><p>After provisioning PV, the following parameters are needed to be set.
It shows the example for using GKE.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>persistentVolume</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># use PV flag</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># accessMode for PV (please verify your environment).</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>accessMode</span>: <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># storage class for PV (please verify your environment)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storageClass</span>: <span style=color:#ae81ff>standard</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># set enough size for backup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>size</span>: <span style=color:#ae81ff>2Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ngt</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>index_path</span>: <span style=color:#e6db74>&#34;/var/ngt/index&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enable_in_memory_mode</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># copy on write function flag</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enable_copy_on_write</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>Each PV will be mounted on each Vald Agent Pod&rsquo;s <code>index_path</code>.</p><p>You can choose <code>copy_on_write</code> (CoW) function.</p><p>The CoW is an option to update the backup file safely.</p><p>The backup file may be corrupted, and the Vald Agent pod may not restore from backup files when the Vald Agent pod terminates during saveIndex without CoW is not be enabled.
On the other hand, if CoW is enabled, the Vald Agent pod can restore the data from one generation ago.</p><div class=caution>When CoW is enabled, PV temporarily has two backup files; new and old versions.<br>So, A double storage capacity is required if CoW is enabled, e.g., when set 2Gi as size without CoW, the size should be more than 4Gi with CoW.</div><h3 id=s3>S3</h3><h4 id=requirement-1>requirement</h4><p>Before deployment, you must provision the S3 object storage.
You can use any S3-compatible object storage.</p><p>For example:</p><ul><li><a href=https://aws.amazon.com/s3/>AWS S3</a></li><li><a href=https://cloud.google.com/storage/docs/>Google Cloud Storage</a></li></ul><h4 id=configuration-1>configuration</h4><p>After provisioning the object storage, the following parameters are needed to be set.
To enable the backup function with S3, the Vald Agent Sidecar should be enabled.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ngt</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>index_path</span>: <span style=color:#e6db74>&#34;/var/ngt/index&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enable_in_memory_mode</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sidecar</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># run sidecar with initContainerMode or not</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>initContainerEnabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is the Amazon S3 settings.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Please change it according to your environment.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>blob_storage</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># storage type (default: s3)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>storage_type</span>: <span style=color:#e6db74>&#34;s3&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># your bucket name</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>bucket</span>: <span style=color:#e6db74>&#34;vald&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>s3</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>region</span>: <span style=color:#e6db74>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If you enable sidecar, the following environment variables will be created automatically by default values.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># So, please create the &#39;aws-secret&#39; resource before deploying.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># env:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#   - name: AWS_ACCESS_KEY</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#     valueFrom:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#       secretKeyRef:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         name: aws-secret</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         key: access-key</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#   - name: AWS_SECRET_ACCESS_KEY</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#     valueFrom:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#       secretKeyRef:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         name: aws-secret</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         key: secret-access-key</span>
</span></span></code></pre></div><p>The Vald Agent Sidecar needs an access key and a secret access key to communicate with your object storage.
Before applying the helm chart, register each value in Kubernetes secrets with the following commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create secret -n &lt;Vald cluster namespace&gt; aws-secret --access-key<span style=color:#f92672>=</span>&lt;ACCESS KEY&gt; --secret-access-key<span style=color:#f92672>=</span>&lt;SECRET ACCESSS KEY&gt;
</span></span></code></pre></div><h3 id=persistent-volume-and-s3>Persistent Volume and S3</h3><p>You can use both PV and S3 at the same time.
Please refer to the before sections for provisioning storages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>agent</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>persistentVolume</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># use PV flag</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># accessMode for PV (please verify your environment)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>accessMode</span>: <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># storage class for PV (please verify your environment)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storageClass</span>: <span style=color:#ae81ff>standard</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># set enough size for backup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>size</span>: <span style=color:#ae81ff>2Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ngt</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enable_in_memory_mode</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># copy on write function flag</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enable_copy_on_write</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sidecar</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># run sidecar with initContainerMode or not. If true, it allows restoration.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>initContainerEnabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is the Amazon S3 settings.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Please change it according to your environment.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>blob_storage</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># storage type (default: s3)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>storage_type</span>: <span style=color:#e6db74>&#34;s3&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># your bucket name</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>bucket</span>: <span style=color:#e6db74>&#34;vald&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>s3</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>region</span>: <span style=color:#e6db74>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If you enable sidecar, the following environment variables will be created automatically by default values.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># So, please create the &#39;aws-secret&#39; resource before deploying.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># env:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#   - name: AWS_ACCESS_KEY</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#     valueFrom:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#       secretKeyRef:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         name: aws-secret</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         key: access-key</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#   - name: AWS_SECRET_ACCESS_KEY</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#     valueFrom:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#       secretKeyRef:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         name: aws-secret</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#         key: secret-access-key</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><h2 id=restore>Restore</h2><p>Restoring from the backup file runs on start Pod when the config is set correctly, and the backup file exists.</p><h3 id=pv>PV</h3><p>In using the PV case, restoration starts when Pod starts.</p><p>If the configuration is correct, the backup file will be automatically mounted, loaded, and indexed when the Pod starts.</p><h3 id=s3-1>S3</h3><p>In using the S3 case, restoration runs only <code>initContainerMode</code>.
To enable restoration, you have to set <code>sidecar.initContainerMode</code> as <code>true</code>.</p><p>Agent Sidecar tries to get the backup file from S3, unpacks it, and starts indexing.</p><h3 id=pv--s3>PV + S3</h3><p>In using both the PV and S3 case, the backup file used for restoration will prioritize the file on PV.
If the backup file does not exist on the PV, the backup file will be retrieved from S3 via the Vald Agent Sidecar and restored.</p><h2 id=broken-index-backup>Broken index backup</h2><p>If a backup file of an index is corrupted for some reason, Vald agent fails to load the index file, and the index file is then identified as a broken index.</p><blockquote><p>Causes of broken index could be agent crash during save index operation, partial storage corruption, etc.</p></blockquote><p>When an index is broken, the default behavior is to discard it and continue running the Pod. This is useful for saving storage space, but sometimes you may need to inspect the contents of a broken index at a later time. By enabling the <code>broken index backup</code> feature, a backup is created without deleting the broken index before running the Pod. This feature can help you investigate the cause of index corruption at a later time.</p><h3 id=settings>Settings</h3><p>To enable this feature, set the <code>agent.ngt.broken_index_history_limit</code> setting to at least 1 (default: 0). The system stores backups of broken indexes up to the number of generations specified by this variable. If a backup of a broken index is needed that goes beyond this value, the system will delete the oldest backup.</p><pre tabindex=0><code>agent:
  ngt:
    ...
    broken_index_history_limit: 3
    ...
</code></pre><h3 id=backup-location>Backup location</h3><p>The backup is stored under <code>${index_path}/broken</code>. Each directory name represents the Unix nanosecond when an attempt was made to read the broken index.</p><pre tabindex=0><code>${index_path}/
  origin/
    ngt-meta.kvsdb
    ngt-timestamp.kvsdb
    metadata.json
    prf
    grp
    tre
    obj
  broken/
    1611271735938403848/
      ngt-meta.kvsdb
      ...
    1611271749583028942/
      ngt-meta.kvsdb
      ...
    1611271759849304593/
      ngt-meta.kvsdb
      ...
</code></pre><h3 id=restore-1>Restore</h3><h4 id=cow-disabled>CoW: disabled</h4><p>If an index file exists under <code>${index_path}/origin</code>, restore is attempted based on that index file. If the restore fails, the index file is backed up as a broken index. The agent starts in its initial state.</p><h4 id=cow-enabled>CoW: enabled</h4><p>If an index file exists under <code>${index_path}/origin</code>, restore is attempted based on that index file. If the restore fails, <code>${index_path}/origin</code> is backed up as a broken index at that point. Then, restore is attempted based on the index file in <code>${index_path}/backup</code> (one generation older index file). If the restore fails again, the agent starts in its initial state.</p><h3 id=metrics>Metrics</h3><p>The number of generations of broken indexes currently stored can be obtained as a metric <code>agent_core_ngt_broken_index_store_count</code>.</p><p>Reference: <a href=https://github.com/vdaas/vald/blob/main/k8s/metrics/grafana/dashboards/01-vald-agent.yaml>vald/k8s/metrics/grafana/dashboards/01-vald-agent.yaml</a></p></div><aside class=current id=current><button class=menu><span class=dot></span></button><nav id=TableOfContents><ul><li><a href=#what-is-the-backup>What is the backup</a></li><li><a href=#backup-methods>Backup methods</a></li><li><a href=#backup-configuration-1>Backup configuration</a><ul><li><a href=#general>General</a></li><li><a href=#persistent-volume>Persistent Volume</a></li><li><a href=#s3>S3</a></li><li><a href=#persistent-volume-and-s3>Persistent Volume and S3</a></li></ul></li><li><a href=#restore>Restore</a><ul><li><a href=#pv>PV</a></li><li><a href=#s3-1>S3</a></li><li><a href=#pv--s3>PV + S3</a></li></ul></li><li><a href=#broken-index-backup>Broken index backup</a><ul><li><a href=#settings>Settings</a></li><li><a href=#backup-location>Backup location</a></li><li><a href=#restore-1>Restore</a></li><li><a href=#metrics>Metrics</a></li></ul></li></ul></nav></aside></div></div></main><footer class=footer><div class="footer__content cf"><ul class=footer__list><li class=footer__item><a href=/docs/v1.7/overview/about-vald class=footer__link>About<br></a></li><li class=footer__item><a href=/docs/v1.7/tutorial/get-started class=footer__link>Get Started<br></a></li><li class=footer__item><a href=/docs/v1.7/user-guides/sdks class=footer__link>SDKs</a></li><li class=footer__item><a href=/docs/v1.7 class=footer__link>Docs</a></li><li class=footer__item><a href=https://vdaas-vald.medium.com/ target=_blank class=footer__link>Blog<br></a></li><li class=footer__item><a class="footer__item footer__icon" href=https://github.com/vdaas/vald target=_blank><picture><source srcset=https://vald.vdaas.org/images/logo_github_white.svg media="(prefers-color-scheme: dark)" class=icon__image width=24 height=24><img src=https://vald.vdaas.org/images/logo_github_black.svg alt=github class=icon__image></picture></a></li></ul></div><p class=footer__copylight>¬©2019-2023 vald.vdaas.org Vald team</p></footer></body></html>