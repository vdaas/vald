#
# Copyright (C) 2019-2026 vdaas.org vald team <vald@vdaas.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
time_zone: UTC
logging:
  format: raw
  level: info
  logger: glg
dataset:
  name: _E2E_DATASET_PATH_
kubernetes:
  kube_config: _KUBECONFIG_
  port_forward:
    enabled: true
    local_port: 8082
    namespace: _E2E_TARGET_NAMESPACE_
    service_name: _E2E_TARGET_NAME_
    target_port: 8081
target:
  addrs:
    - 127.0.0.1:8082
  health_check_duration: 1s
  connection_pool:
    enable_dns_resolver: true
    enable_rebalance: true
    old_conn_close_duration: 2m
    rebalance_duration: 30m
    size: 3
  backoff:
    backoff_factor: 1.1
    backoff_time_limit: 5s
    enable_error_log: false
    initial_duration: 5ms
    jitter_limit: 100ms
    maximum_duration: 5s
    retry_count: 100
  call_option:
    content_subtype: ""
    max_recv_msg_size: 0
    max_retry_rpc_buffer_size: 0
    max_send_msg_size: 0
    wait_for_ready: true
  dial_option:
    authority: ""
    backoff_base_delay: 1s
    backoff_jitter: 0.2
    backoff_max_delay: 120s
    backoff_multiplier: 1.6
    disable_retry: false
    enable_backoff: true
    idle_timeout: ""
    initial_connection_window_size: 2097152
    initial_window_size: 1048576
    insecure: true
    interceptors: []
    keepalive:
      permit_without_stream: false
      time: ""
      timeout: 30s
    max_call_attempts: 0
    max_header_list_size: 0
    max_msg_size: 0
    min_connection_timeout: 20s
    net:
      dialer:
        dual_stack_enabled: true
        keepalive: ""
        timeout: ""
      dns:
        cache_enabled: true
        cache_expiration: 1h
        refresh_duration: 30m
      network: tcp
      socket_option:
        ip_recover_destination_addr: false
        ip_transparent: false
        reuse_addr: true
        reuse_port: true
        tcp_cork: false
        tcp_defer_accept: false
        tcp_fast_open: false
        tcp_no_delay: false
        tcp_quick_ack: false
      tls:
        ca: /path/to/ca
        cert: /path/to/cert
        enabled: false
        insecure_skip_verify: false
        key: /path/to/key
    read_buffer_size: 0
    shared_write_buffer: true
    timeout: ""
    user_agent: Vald-gRPC
    write_buffer_size: 0
  tls:
    ca: /path/to/ca
    cert: /path/to/cert
    enabled: false
    insecure_skip_verify: false
    key: /path/to/key
metadata:
  key1: sample metadata value1
  key2: sample metadata value2
  key3: sample metadata value3
metadata_string: key4=value4,key5=value5
metrics:
  enabled: true
  latency_histogram:
    num_shards: 10
  queue_wait_histogram:
    num_shards: 10
  latency_tdigest:
    compression: 100
    compression_trigger_factor: 1.2
    num_shards: 16
  queue_wait_tdigest:
    compression: 100
    compression_trigger_factor: 1.2
    num_shards: 16
  exemplar:
    capacity: 10
  range_scales:
    - name: 0-100
      width: 10
      capacity: 10
  time_scales:
    - name: 0-10s
      width: 1
      capacity: 10
  custom_counters:
    - custom_counter_1
strategies:
  - concurrency: 1
    name: check Index Property
    operations:
      - name: IndexProperty
        executions:
          - mode: unary
            name: IndexProperty
            type: index_property
            wait: 3s
            expect:
              - status_code: ok
                path: $.details.length()
                op: ge
                value: 3
  - concurrency: 1
    name: Initial Insert and Wait
    operations:
      - name: Insert Operation
        executions:
          - name: Flush
            mode: unary
            type: flush
            wait: 20s
          - mode: unary
            name: IndexInfo
            type: index_info
            expect:
              - value: {}
          - name: Insert
            type: insert
            mode: unary
            parallelism: _E2E_PARALLELISM_
            num: _E2E_INSERT_COUNT_
            qps: _E2E_QPS_
            wait: 2m
          - mode: unary
            name: IndexInfo
            type: index_info
            retry_until_success_timeout: 5m
            expect:
              - status_code: ok
                path: $.sum()
                value: _E2E_EXPECTED_INDEX_
  - concurrency: 1
    name: Index Correction -> Check the number of Replica
    operations:
      - name: IndexCorrection
        executions:
          - name: IndexCorrection
            type: kubernetes
            mode: other
            kubernetes:
              kind: job
              namespace: default
              name: vald-index-correction
              action: create
          - name: Wait
            type: kubernetes
            mode: other
            kubernetes:
              kind: pod
              namespace: default
              label_selector: app=vald-index-correction
              action: wait
              status: completed
          - mode: unary
            name: IndexInfo
            type: index_info
            expect:
              - status_code: ok
                path: $.sum()
                value: _E2E_EXPECTED_INDEX_
  - concurrency: 1
    name: Kill an agent -> Index Correction -> Check the number of Replica
    operations:
      - name: IndexCorrection
        executions:
          - name: KillAgent
            type: kubernetes
            mode: other
            wait: 10s
            kubernetes:
              kind: pod
              namespace: default
              name: vald-agent-0
              action: delete
          - mode: unary
            name: IndexInfo
            type: index_info
            expect:
              - status_code: ok
                path: $.sum()
                op: lt
                value: _E2E_EXPECTED_INDEX_
          - name: IndexCorrection
            type: kubernetes
            mode: other
            kubernetes:
              kind: job
              namespace: default
              name: vald-index-correction
              action: create
          - name: Wait
            type: kubernetes
            mode: other
            kubernetes:
              kind: pod
              namespace: default
              label_selector: app=vald-index-correction
              status: completed
              action: wait
          - mode: unary
            name: IndexInfo
            type: index_info
            expect:
              - status_code: ok
                path: $.sum()
                value: _E2E_EXPECTED_INDEX_
